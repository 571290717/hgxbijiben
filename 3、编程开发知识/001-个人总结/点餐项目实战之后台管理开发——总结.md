# 点餐项目实战之后台管理开发——总结









## 前言

我这里的目标是个人学习+网上接单出售该系统，所以我这边主要考虑项目研发过程

项目研发过程包`8`个过程域,分为:`需求开发`、`技术预研`、`系统设计`、`实现与测试`、`系统测试`、 `Beta测试`、`客户验收`、`技术评审`

````
做项目落地：
1、做需求分析
2、设计数据库
（建表）
3、项目架构设计
（规定一下使用的技术及版本，整体框架(就是每个文件做什么用)）
4、进行项目搭建
（django）
这一步就开始着手写系统了


写系统：
满足需求、数据库、前段模板
二个字,框架就是程序的骨架
pip install django==2.2.*
python -m django --version
django-admin startproject myweb   创建项目
 python manage.py runserver 0.0.0.0:8000   测试运行
 python manage.py startapp myapp	创建一个应用程序
pip install mysqlclient

写settings.py

# 1. 配置允许访问的主机名信息
ALLOWED_HOSTS = ['*']
或
ALLOWED_HOSTS = ['localhost','127.0.0.1','192.168.2.240']
# 2. 将myadmin和web的应用添加到项目框架结构中
INSTALLED_APPS = [
    'django.contrib.admin',
    'django.contrib.auth',
    'django.contrib.contenttypes',
    'django.contrib.sessions',
    'django.contrib.messages',
    'django.contrib.staticfiles',
    'myadmin',
    'web',
    'mobile',
]

...

# 3. 配置模板目录 os.path.join(BASE_DIR,'templates')
TEMPLATES = [
    {
        'BACKEND': 'django.template.backends.django.DjangoTemplates',
        'DIRS': [os.path.join(BASE_DIR,'templates')],
        'APP_DIRS': True,
        'OPTIONS': {
            'context_processors': [
                'django.template.context_processors.debug',
                'django.template.context_processors.request',
                'django.contrib.auth.context_processors.auth',
                'django.contrib.messages.context_processors.messages',
            ],
        },
    },
]

...

# 4. 配置项目的数据库连接信息：
DATABASES = {
    'default': {
        'ENGINE': 'django.db.backends.mysql',
        'NAME': 'osdb',
        'USER': 'root',
        'PASSWORD': '',
        'HOST': 'localhost',
        'PORT': '3306',
    }
}

...

# 5. 设置时区和语言 
LANGUAGE_CODE = 'zh-hans'

TIME_ZONE = 'Asia/Shanghai'

...

# 6. 配置网站的静态资源目录
STATIC_URL = '/static/'
STATICFILES_DIRS = [
    os.path.join(BASE_DIR, 'static'),
]

**1）生成迁移文件**

```
python manage.py makemigrations
```

**2）同步到数据库中**

```
python manage.py migrate
```


(以上是基础的设置)

现在设置完了：
开始开发了：

1、写mysql
MySQL数据库建表
2、models.py
  写模型便于操作数据库
3、写views.py
(这里就是主要业务了
增删改查、验证码、session、上传图片、准备数据、外接接口
)---这个也是主要学习的东西

4、前后端联动写模板
（这里就是前端了，一个项目的价值就体现在前端了
这里包含vue，js，ajax
我们可以使用开源前段自己联动，关于联动就需要自己学习
Django的模板语言
）


5、写urls
就是让浏览器能访问到views
 （后面三步没有明确的界限，这是一般流程，写完urls就可以开始测试，测试有问题，就又回头开始测试）

综上总结为：
主要学习view.py和模板
urls自己总结一下方法就行




````



## 1. 需求分析

(1). 确立项目：线上点餐系统 （B2C结构）

(2). 项目功能介绍

本点餐项目分为网站后台管理、前台大堂点餐和移动端会员点餐三部分：

① 网站后台管理

- 后台操作：登录、退出
- 员工信息管理：添加、删除、修改、重置密码、查看、分配店铺
- 店铺信息管理：添加、删除、修改、查看店铺信息
- 菜品分类信息管理：添加、删除、修改、查看菜品类别信息
- 菜品信息管理：添加、删除、修改、查看菜品信息
- 会员信息管理：查看、修改会员状态、重置密码
- 订单信息管理：查看订单、订单详情
- 其他扩展：权限管理、系统配置等

② 前台大堂点餐

- 大堂点餐： 登录（选择店铺）与退出
- 大堂点餐首页：展示当前店铺基本信息、菜品分类与菜品信息。
- 购物车管理：添加、查看、删除、清空等当前用户的点餐信息操作。
- 订餐管理：浏览当前店铺订单列表、详情以及处理订单
- 其他扩展：汇总数据展示：营业日结、订单统计等；

③ 移动端会员点餐

- 移动端会员操作：登录、退出
- 切换店铺
- 菜品浏览：当前店铺所有菜品类别与菜品信息
- 购物车：添加、查看、操作当前购物车
- 下的处理：执行订单下单处理
- 会员中心：

(3). 绘制项目的功能模块 和操作流程图

- [免费在线作图](https://www.processon.com/i/5ac2a107e4b0cfe2747ca85e)

① 智能点餐项目功能模块图（如下图）

![img](%E7%82%B9%E9%A4%90%E9%A1%B9%E7%9B%AE%E5%AE%9E%E6%88%98%E4%B9%8B%E5%90%8E%E5%8F%B0%E7%AE%A1%E7%90%86%E5%BC%80%E5%8F%91%E2%80%94%E2%80%94%E6%80%BB%E7%BB%93.assets/22-16819705807351.png)

② 点餐系统后台用户操作流程图（如下图）

![img](%E7%82%B9%E9%A4%90%E9%A1%B9%E7%9B%AE%E5%AE%9E%E6%88%98%E4%B9%8B%E5%90%8E%E5%8F%B0%E7%AE%A1%E7%90%86%E5%BC%80%E5%8F%91%E2%80%94%E2%80%94%E6%80%BB%E7%BB%93.assets/33-16819705911652.png)

③ 员工大堂点餐操作流程图（如下图）

![img](%E7%82%B9%E9%A4%90%E9%A1%B9%E7%9B%AE%E5%AE%9E%E6%88%98%E4%B9%8B%E5%90%8E%E5%8F%B0%E7%AE%A1%E7%90%86%E5%BC%80%E5%8F%91%E2%80%94%E2%80%94%E6%80%BB%E7%BB%93.assets/44-16819706070793-16819706085724.png)

④ 移动端会员点餐操作流程图（如下图）

![img](%E7%82%B9%E9%A4%90%E9%A1%B9%E7%9B%AE%E5%AE%9E%E6%88%98%E4%B9%8B%E5%90%8E%E5%8F%B0%E7%AE%A1%E7%90%86%E5%BC%80%E5%8F%91%E2%80%94%E2%80%94%E6%80%BB%E7%BB%93.assets/55-16819706150355.png)

(4). 具体功能描述

- 针对与点餐平台的每个功能块进行详细描述，主要包含以下几个方面：
  - 功能名称、编号、设计者、时间
  - 功能框图及说明
  - 操作权限
  - 需要哪些输入
  - 具体执行过程内容
  - 输出结果
  - 业务数据流：DFD图
  - 功能效果预览

(5). 项目运行环境要求

- 服务器环境要求：服务器数量，类型和用途；以及每台服务器的配置要求
- 软件环境：Python、MySQL、框架Django的版本要求
- 各种接口标准要求（支付、微信、短信等接口）

(6). 项目具体完成时间和报价

- 项目开发进度计划表，时间周期的安排
- 项目总体报价，以及每个模块的报价、付款方式
- 项目违约处理，后期功能附加条款处理等事项说明

(7). 验收标准

- 项目模块功能的完成情况
- 项目的执行性能（如：网站的响应时间值：正常<=3秒）

## 2. 项目的数据库设计

 绘制E-R图

![img](%E7%82%B9%E9%A4%90%E9%A1%B9%E7%9B%AE%E5%AE%9E%E6%88%98%E4%B9%8B%E5%90%8E%E5%8F%B0%E7%AE%A1%E7%90%86%E5%BC%80%E5%8F%91%E2%80%94%E2%80%94%E6%80%BB%E7%BB%93.assets/66-16819708024856-16819708061947.png)





(2). 逻辑结构设计

- 在上面实体之间的关系基础上,将实体、属性和实体之间的联系转换为关系模式。

* 确定关系模式：

- 根据转换算法,E-R 图中有 7 个实体类型,可以转换成 8 个关系模式:

  1). `员工`(id号、账号、昵称、密码、密码干扰、状态、添加时间、修改时间)

  2). `店铺`(id号，店铺名称，封面图片、图标logo、店铺地址、联系电话、状态、添加时间、修改时间)

  3). `菜品类别`(id号，店铺id、类别名称，状态、添加时间、修改时间)

  4). `菜品`(id、店铺id、类别id、菜品图片、菜品名称、单价、状态、添加时间、修改时间)

  5). `会员`(id号、账号、昵称、头像、电话、状态、添加时间、修改时间)

  6). `订单`(id号、店铺id、会员id号、操作员id、金额、订单状态、支付状态、添加时间、修改时间)

  7). `订单详情`(id号、订单id号、菜品id号、单价、状态、购买量)

* 消除冗余：

- 冗余数据和冗余联系容易破坏数据库的完整性,给数据库的维护增加困难,应当予以消除。
- 本系统的冗余数据和冗余关系已经在概念结构设计中处理过了,这里不再进行过多的叙述。

(3). 物理结果设计

- 数据库设计的最后阶段是确定数据库在物理设备上的存储结构和存取方法,即物理数据模型。
- 物理数据模型的设计其实也是在设计表结构。
- 一般地,实体对应于表,实体的属性对应于表的列(字段),实体之间的关系成为表的约束。

* 设计数据表结构：

![img](%E7%82%B9%E9%A4%90%E9%A1%B9%E7%9B%AE%E5%AE%9E%E6%88%98%E4%B9%8B%E5%90%8E%E5%8F%B0%E7%AE%A1%E7%90%86%E5%BC%80%E5%8F%91%E2%80%94%E2%80%94%E6%80%BB%E7%BB%93.assets/bb1-16819708483978-16819708497319-168197085625310.png)

* 通过数据表结构来创建数据表：

```mysql
-- 员工信息表
CREATE TABLE `user` (
  `id` int(10) unsigned NOT NULL AUTO_INCREMENT COMMENT '员工账号id',
  `username` varchar(50) DEFAULT NULL COMMENT '员工账号',
  `nickname` varchar(50) DEFAULT NULL COMMENT '昵称',
  `password_hash` varchar(100) DEFAULT NULL COMMENT '密码',
  `password_salt` varchar(50) DEFAULT NULL COMMENT '密码干扰值',
  `status` tinyint(3) unsigned NOT NULL DEFAULT '1' COMMENT '状态:1正常/2禁用/9删除',
  `create_at` datetime DEFAULT NULL COMMENT '创建时间',
  `update_at` datetime DEFAULT NULL COMMENT '修改时间',
  PRIMARY KEY (`id`)
) ENGINE=InnoDB AUTO_INCREMENT=4 DEFAULT CHARSET=utf8;

-- 店铺信息表
CREATE TABLE `shop` (
  `id` int(10) unsigned NOT NULL AUTO_INCREMENT COMMENT '店铺id',
  `name` varchar(255) NOT NULL COMMENT '店铺名称',
  `cover_pic` varchar(255) DEFAULT NULL COMMENT '封面图片',
  `banner_pic` varchar(255) DEFAULT NULL COMMENT '图标Logo',
  `address` varchar(255) DEFAULT NULL COMMENT '店铺地址',
  `phone` varchar(255) DEFAULT NULL COMMENT '联系电话',
  `status` tinyint(4) NOT NULL DEFAULT '1' COMMENT '状态：1:正常 2:暂停 9:删除',
  `create_at` datetime DEFAULT NULL COMMENT '添加时间',
  `update_at` datetime DEFAULT NULL COMMENT '修改时间',
  PRIMARY KEY (`id`)
) ENGINE=InnoDB AUTO_INCREMENT=5 DEFAULT CHARSET=utf8;

-- 菜品类别表
CREATE TABLE `category` (
  `id` int(10) unsigned NOT NULL AUTO_INCREMENT COMMENT '菜品分类id',
  `shop_id` int(11) DEFAULT NULL COMMENT '店铺id',
  `name` varchar(50) DEFAULT NULL COMMENT '分类名称',
  `status` tinyint(4) NOT NULL DEFAULT '1' COMMENT '状态：1正常 9删除',
  `create_at` datetime DEFAULT NULL COMMENT '添加时间',
  `update_at` datetime DEFAULT NULL COMMENT '修改时间',
  PRIMARY KEY (`id`)
) ENGINE=InnoDB AUTO_INCREMENT=9 DEFAULT CHARSET=utf8;

-- 菜品信息表
CREATE TABLE `product` (
  `id` int(11) unsigned NOT NULL AUTO_INCREMENT COMMENT '菜品id',
  `shop_id` int(11) DEFAULT NULL COMMENT '店铺id',
  `category_id` int(11) DEFAULT NULL COMMENT '菜品分类id',
  `cover_pic` varchar(50) DEFAULT NULL COMMENT '菜品图片',
  `name` varchar(50) DEFAULT NULL COMMENT '菜品名称',
  `price` double(6,2) DEFAULT NULL COMMENT '单价',
  `status` tinyint(4) DEFAULT NULL COMMENT '状态：1:正常  2:停售  9:删除',
  `create_at` datetime DEFAULT NULL COMMENT '添加时间',
  `update_at` datetime DEFAULT NULL COMMENT '修改时间',
  PRIMARY KEY (`id`)
) ENGINE=InnoDB AUTO_INCREMENT=18 DEFAULT CHARSET=utf8;

-- 会员信息表
CREATE TABLE `member` (
  `id` int(10) unsigned NOT NULL AUTO_INCREMENT COMMENT '会员表id',
  `nickname` varchar(50) DEFAULT NULL COMMENT '昵称',
  `avatar` varchar(255) DEFAULT NULL COMMENT '头像',
  `mobile` varchar(50) DEFAULT NULL COMMENT '电话',
  `status` tinyint(3) unsigned NOT NULL DEFAULT '1' COMMENT '状态:1正常/2禁用/9删除',
  `create_at` datetime DEFAULT NULL COMMENT '添加时间',
  `update_at` datetime DEFAULT NULL COMMENT '修改时间',
  PRIMARY KEY (`id`)
) ENGINE=InnoDB AUTO_INCREMENT=5 DEFAULT CHARSET=utf8;

-- 订单信息表
CREATE TABLE `orders` (
  `id` int(10) unsigned NOT NULL AUTO_INCREMENT COMMENT '订单表id',
  `shop_id` int(10) unsigned DEFAULT NULL COMMENT '店铺id号',
  `member_id` int(10) unsigned DEFAULT NULL COMMENT '会员id',
  `user_id` int(10) unsigned DEFAULT NULL COMMENT '操作员id',
  `money` double(8,2) DEFAULT NULL COMMENT '金额',
  `status` tinyint(3) unsigned DEFAULT NULL COMMENT '订单状态:1过行中/2无效/3已完成',
  `payment_status` tinyint(3) unsigned DEFAULT NULL COMMENT '支付状态:1未支付/2已支付/3已退款',
  `create_at` datetime DEFAULT NULL COMMENT '添加时间',
  `update_at` datetime DEFAULT NULL COMMENT '修改时间',
  PRIMARY KEY (`id`)
) ENGINE=InnoDB AUTO_INCREMENT=1 DEFAULT CHARSET=utf8;

-- 订单信息详情表
CREATE TABLE `order_detail` (
  `id` int(10) unsigned NOT NULL AUTO_INCREMENT COMMENT '订单详情id',
  `order_id` int(10) unsigned DEFAULT NULL COMMENT '订单id',
  `product_id` int(10) unsigned DEFAULT NULL COMMENT '菜品id',
  `product_name` varchar(50) DEFAULT NULL COMMENT '菜品名称',
  `price` double(6,2) unsigned DEFAULT NULL COMMENT '单价',
  `quantity` int(10) unsigned NOT NULL DEFAULT '1' COMMENT '数量',
  `status` tinyint(3) unsigned NOT NULL DEFAULT '1' COMMENT '状态:1正常/9删除',
  PRIMARY KEY (`id`)
) ENGINE=InnoDB AUTO_INCREMENT=1 DEFAULT CHARSET=utf8 CHECKSUM=1 DELAY_KEY_WRITE=1 ROW_FORMAT=DYNAMIC COMMENT='订单详情信息表';

-- 支付信息表
CREATE TABLE `payment` (
  `id` int(10) unsigned NOT NULL AUTO_INCREMENT COMMENT '支付表id',
  `order_id` int(10) unsigned DEFAULT NULL COMMENT '订单id',
  `member_id` int(10) unsigned DEFAULT NULL COMMENT '会员id',
  `money` double(8,2) unsigned DEFAULT NULL COMMENT '支付金额',
  `type` tinyint(3) unsigned DEFAULT NULL COMMENT '付款方式：1会员付款/2收银收款',
  `bank` tinyint(3) unsigned DEFAULT NULL COMMENT '收款银行渠道:1微信/2余额/3现金/4支付宝',
  `status` tinyint(3) unsigned DEFAULT NULL COMMENT '支付状态:1未支付/2已支付/3已退款',
  `create_at` datetime DEFAULT NULL COMMENT '添加时间',
  `update_at` datetime DEFAULT NULL COMMENT '修改时间',
  PRIMARY KEY (`id`)
) ENGINE=InnoDB AUTO_INCREMENT=6 DEFAULT CHARSET=utf8;


CREATE TABLE `django_session` (
  `session_key` varchar(40) NOT NULL,
  `session_data` longtext NOT NULL,
  `expire_date` datetime(6) NOT NULL,
  PRIMARY KEY (`session_key`),
  KEY `django_session_expire_date_a5c62663` (`expire_date`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8;


-- 在user上表中添加一条后台管理员账户数据
insert  into `user`(`id`,`username`,`nickname`,`password_hash`,`password_salt`,`status`,`create_at`,`update_at`) values (1,'zhangsan','张三','1e191d851b3b49a248f4ea62f6b06410','123456',1,'2018-08-08 18:18:18','2018-09-07 08:06:55');
```

(4). 安全保密设计

- 本数据库系统采用安全的用户名加口令方式登录。用户名的权限限制为只能进行基本的 增删改查数据功能。
- 数据库应用对数据一般都具有一定的限制,这种限制称为完整性。
- 关系数据库系统应该保证输入的值符合其规定的数据类型,并保证值在系统支持的范围内。
- 关系数据库系统都支持 3 种完整性:`域约束`、`实体完整性约束`和`关联完整性约束`。



## 3. 项目架构的程序设计

(1). 项目使用技术

- 基于Python语言，版本：>=3.6及以上。
- 使用Django框架，版本：2.2.*的LTS版本。
- MySQL数据库
- 连接数据库：mysqlclient=1.4.6
- 图像处理： Pillow=5.0.0
- Web前端技术：HTML、CSS、JavaScript和Jquery等

(2). 项目的目录结构

- 本次项目共计三个应用：

  ```
  myadmin
  ```

  、

  ```
  web
  ```

  和

  ```
  mobile
  ```

  ```
  myobject/ 项目目录
    |   
    |--myadmin/ 后台管理应用
    |    |--__init__.py
    |    |--views/
    |    |    |--index.py 后台首页、登录、退出、验证码加载等视图方法
    |    |    |--user.py 员工信息管理视图
    |    |    |--member.py 会员信息管理视图
    |    |    |--shop.py 店铺信息管理视图
    |    |    |--product.py 菜品信息管理视图
    |    |    |--orders.py 订单信息管理视图
    |    |    |--.....
    |    |
    |    |-- admin.py
    |    |-- apps.py
    |    |-- models.py  定义了整个网站的models类,除了本应使用，还提供给其他应用
    |    |-- shopmiddleware.py 定了整个网站的中间件（验证是否登录及权限管理信息）
    |    |-- tests.py
    |    |-- urls.py 配置了整个网站后台所有请求路由
    |
    |--web/ 前台应用（大堂点餐）
    |    |-- __init__.py
    |    |--views/
    |    |    |--index.py 大堂点餐应用的登录、退出、验证码、加载店铺等方法
    |    |    |--product.py 菜品展示视图
    |    |    |--shopcart.py 购物车管理视图
    |    |    |--orders.py 订单管理视图
    |    |-- admin.py
    |    |-- apps.py
    |    |-- models.py 
    |    |-- tests.py
    |    |-- urls.py 配置了大堂点餐应用的所有请求路由
    |
    |--mobile/ 移动端点餐应用\
    |    |-- __init__.py
    |    |--views/
    |    |    |--index.py 登录，退出路由
    |    |    |--shop.py 店铺信息加载视图
    |    |    |--product.py 菜品信息加载展示视图
    |    |    |--orders.py 个人订单信息管理视图
    |    |    |--member.py 个人中心管理视图
    |    |    |--......
    |    |
    |    |-- admin.py
    |    |-- apps.py
    |    |-- models.py
    |    |-- tests.py
    |    |-- urls.py 配置了移动端点餐应用的所有请求路由
    |
    |--myobject/ 项目目录
    |    |-- __init__.py
    |    |-- settings.py
    |    |-- urls.py
    |    |-- wsgi.py
    |
    |--static/ 静态资源目录
    |    |-- uploads/   上传文件存储目录
    |    |-- myadmin/   后台管理静态资源目录
    |    |-- web/       大堂点餐静态资源目录
    |    |-- mobile/    移动端管理静态资源目录
    |
    |--templates/ 模板目录
    |    |-- myadmin/   后台管理模板目录
    |    |-- web/       大堂点餐模板目录
    |    |-- mobile/    移动端管理模板目录
    |
    |--manage.py 入口文件
  ```

(3). 项目模块结构

* 网站后台应用的模块操作说明

- 网站后台模板采用github上提供的一个后台管理界面，网址：https://github.com/ColorlibHQ/AdminLTE
- 还有一个简单的（已过时）： https://github.com/alecfan/mstp_17_akira

| 模块          | 操作                                                         | 权限         |
| ------------- | ------------------------------------------------------------ | ------------ |
| 登录&退出管理 | 获取登录界面、处理登录、退出、验证码                         | 无           |
| 后台首页页    | 后台首页                                                     | 网站编辑权限 |
| 员工信息管理  | 浏览(搜索&分页)、执行添加、编辑、删除(状态及删除)、更改状态、重置密码 | 网站编辑权限 |
| 店铺信息管理  | 浏览、获取添加界面、执行添加、获取编辑界面、执行修改、删除   | 网站编辑权限 |
| 菜品类别管理  | 浏览、获取添加界面、执行添加、获取编辑界面、执行修改、删除   | 网站编辑权限 |
| 菜品信息管理  | 浏览(搜索&分页)、获取添加界面、执行添加、获取编辑界面、执行修改、删除 | 网站编辑权限 |
| 会员信息管理  | 浏览(搜索&分页)、详情、更改状态、重置密码                    | 网站编辑权限 |
| 订单信息管理  | 浏览(搜索&分页)、查看订单详情、处理订单、删除                | 网站编辑权限 |

* 前台大堂点餐应用的模块操作说明

| 模块                       | 操作                                           | 权限     |
| -------------------------- | ---------------------------------------------- | -------- |
| 登录&退出管理              | 获取登录界面、选择店铺、处理登录、退出、验证码 | 无       |
| 店铺中的菜品类别与菜品展示 | 菜品类别，菜品展示                             | 会员权限 |
| 购物车(点餐)管理           | 添加菜品、查看购物车，修改、删除、清空         | 会员权限 |
| 订单处理                   | 订单处理界面，确认订单界面、执行订单处理       | 会员权限 |
| 历史订单管理               | 查看历史订单，订单详情、处理订单               | 会员权限 |

* 移动端应用的模块操作说明

| 模块             | 操作                                           | 权限     |
| ---------------- | ---------------------------------------------- | -------- |
| 登录&退出管理    | 获取登录界面、选择店铺、处理登录、退出、验证码 | 无       |
| 店铺切换         | 切换店铺                                       | 会员权限 |
| 菜品展示         | 添加菜品、查看购物车，修改、删除、清空         | 会员权限 |
| 购物车(点餐)管理 | 添加菜品、查看购物车，修改、删除、清空         | 会员权限 |
| 个人中心         | 历史订单、个人信息、数据统计                   | 会员权限 |

(4). 程序结构

- 建议统一URL访问格式：

  ```
    http://主机名:端口/应用名/视图名/函数名
  
    其中：index省略不写，web前台应用名省略不写。
  ```

- 视图中的函数命名格式：

  - index() ---- 浏览信息
  - add() ---- 加载添加界面
  - insert() ---- 执行添加
  - delete() ---- 执行删除(路由中使用del)
  - edit() ---- 加载编辑界面
  - update() ---- 执行信息编辑

(5). 项目中的编码规范

- 遵循良好的编码风格，可以有效的提高代码的可读性，降低出错几率和维护难度。
- 在团队开发中，使用（尽量）统一的编码风格，还可以降低沟通成本。
- 网上有很多版本的编码规范介绍，基本上都是遵循 PEP8 的规范：
- 具体详见：https://www.python.org/dev/peps/pep-0008/

- 如下参考格式：

```
缩进
* 不要使用 tab 缩进
* 使用任何编辑器写 Python，请把一个 tab 展开为 4 个空格
* 绝对不要混用 tab 和空格，否则容易出现 IndentationError

空格
* 在 list, dict, tuple, set, 参数列表的 , 后面加一个空格
* 在 dict 的 : 后面加一个空格
* 在注释符号 # 后面加一个空格，但是 #!/usr/bin/python 的 # 后不能有空格
* 操作符两端加一个空格，如 +, -, *, /, |, &, =
* 接上一条，在参数列表里的 = 两端不需要空格
* 括号（(), {}, []）内的两端不需要空格

空行
* function 和 class 顶上两个空行
* class 的 method 之间一个空行
* 函数内逻辑无关的段落之间空一行，不要过度使用空行
* 不要把多个语句写在一行，然后用 ; 隔开
* if/for/while 语句中，即使执行语句只有一句，也要另起一行

换行
* 每一行代码控制在 80 字符以内
* 使用 \ 或 () 控制换行.

命名
* 使用有意义的，英文单词或词组，绝对不要使用汉语拼音
* package/module 名中不要出现 -

import
* 所有 import 尽量放在文件开头，在 docstring 下面，其他变量定义的上面
* 不要使用 from foo imort *
* import 需要分组，每组之间一个空行，每个分组内的顺序尽量采用字典序，分组顺序是：
    * 标准库
    * 第三方库
    * 本项目的 package 和 module


注释
* 文档字符串 docstring, 是 package, module, class, method, function 级别的注释，可以通过 * __doc__ 成员访问到，注释内容在一对 """ 符号之间
* function, method 的文档字符串应当描述其功能、输入参数、返回值，如果有复杂的算法和实现，也需要写清楚
不要写错误的注释，不要无谓的注释

异常
* 不要轻易使用 try/except
* except 后面需要指定捕捉的异常，裸露的 except 会捕捉所有异常，意味着会隐藏潜在的问题
* 可以有多个 except 语句，捕捉多种异常，分别做异常处理
* 使用 finally 子句来处理一些收尾操作
* try/except 里的内容不要太多，只在可能抛出异常的地方使用，
```

## 4. 基于Django框架的项目搭建

(1). 创建数据库 `osdb`

- 进入MySQL数据库中，创建一个数据库名为：osdb
- 将上节《项目的数据库设计》中准备好的osdb.sql脚本导入到`osdb`数据库中

(2). 创建项目 `myobject` 框架和应用 `myamdin`、`web`和`mobile`。

```
    # 创建项目框架 `myobject`
    $ django-admin startproject myobject

    $ cd myobject

    # 在项目中创建一个myadmin应用(项目的后台管理)
    $ python manage.py startapp myadmin

    # 在项目中再创建一个web应用(项目前台大堂点餐应用)
    $ python manage.py startapp web

    # 在项目中再创建一个mobile应用(移动客户点餐端应用)
    $ python manage.py startapp mobile

    # 创建模板目录
    $ mkdir templates
    $ mkdir templates/myadmin
    $ mkdir templates/web
    $ mkdir templates/mobile

    # 创建静态资源目录
    $ mkdir static
    $ mkdir static/myadmin
    $ mkdir static/web
    $ mkdir static/mobile
    $ mkdir static/uploads

    # 创建前后台应用模板目录,并在里面各创建一个`__init__.py`和`index.py`的空文件
    $ mkdir myadmin/views
    $ touch myadmin/views/__init__.py
    $ touch myadmin/views/index.py
    $ mkdir web/views
    $ touch web/views/__init__.py
    $ touch web/views/index.py
    $ mkdir mobile/views
    $ touch mobile/views/__init__.py
    $ touch mobile/views/index.py

    # 删除前后台应用的默认模板文件
    # rm -rf myadmin/views.py
    # rm -rf web/views.py
    # rm -rf mobile/views.py

    # 拷贝路由文件到应用目录中
    $ cp myobject/urls.py   myadmin/urls.py
    $ cp myobject/urls.py   web/urls.py
    $ cp myobject/urls.py   mobile/urls.py

    # 退出项目目录
    $ cd ..

    #查看项目目录结构
    $ tree myobject

    myobject/
        ├── manage.py
        ├── myobject
        │   ├── __init__.py
        │   ├── settings.py
        │   ├── urls.py
        │   └── wsgi.py
        ├── myadmin
        │   ├── admin.py
        │   ├── apps.py
        │   ├── __init__.py
        │   ├── migrations
        │   │   └── __init__.py
        │   ├── views
        │   │   ├── __init__.py
        │   │   └── index.py
        │   ├── models.py
        │   ├── tests.py
        │   └── urls.py
        ├── web
        │   ├── admin.py
        │   ├── apps.py
        │   ├── __init__.py
        │   ├── migrations
        │   │   ├── __init__.py
        │   ├── views
        │   │   ├── __init__.py
        │   │   └── index.py
        │   ├── models.py
        │   ├── tests.py
        │   └── urls.py
        ├── mobile
        │   ├── admin.py
        │   ├── apps.py
        │   ├── __init__.py
        │   ├── migrations
        │   │   ├── __init__.py
        │   ├── views
        │   │   ├── __init__.py
        │   │   └── index.py
        │   ├── models.py
        │   ├── tests.py
        │   └── urls.py
        ├── static
        │   ├── myadmin/
        │   ├── web/
        │   ├── mobile/
        │   └── uploads/
        └── templates
            ├── myadmin/
            ├── web/
            └── mobile/
```

(3). 项目框架配置

注意：此配置需要安装mysql数据库mysqlclient软件包， 如：`$ pip install mysqlclient`

- 3.2 编辑myobject/myobject/settings.py文件:

```python
# myobject/myobject/settings.py  项目配置文件

# 1. 配置允许访问的主机名信息
ALLOWED_HOSTS = ['*']
或
ALLOWED_HOSTS = ['localhost','127.0.0.1','192.168.2.240']

...

# 2. 将myadmin和web的应用添加到项目框架结构中
INSTALLED_APPS = [
    'django.contrib.admin',
    'django.contrib.auth',
    'django.contrib.contenttypes',
    'django.contrib.sessions',
    'django.contrib.messages',
    'django.contrib.staticfiles',
    'myadmin',
    'web',
    'mobile',
]

...

# 3. 配置模板目录 os.path.join(BASE_DIR,'templates')
TEMPLATES = [
    {
        'BACKEND': 'django.template.backends.django.DjangoTemplates',
        'DIRS': [os.path.join(BASE_DIR,'templates')],
        'APP_DIRS': True,
        'OPTIONS': {
            'context_processors': [
                'django.template.context_processors.debug',
                'django.template.context_processors.request',
                'django.contrib.auth.context_processors.auth',
                'django.contrib.messages.context_processors.messages',
            ],
        },
    },
]

...

# 4. 配置项目的数据库连接信息：
DATABASES = {
    'default': {
        'ENGINE': 'django.db.backends.mysql',
        'NAME': 'osdb',
        'USER': 'root',
        'PASSWORD': '',
        'HOST': 'localhost',
        'PORT': '3306',
    }
}

...

# 5. 设置时区和语言 
LANGUAGE_CODE = 'zh-hans'

TIME_ZONE = 'Asia/Shanghai'

...

# 6. 配置网站的静态资源目录
STATIC_URL = '/static/'
STATICFILES_DIRS = [
    os.path.join(BASE_DIR, 'static'),
]
```

(4). 项目urls路由信息配置

- 4.1 打开根路由文件：myobject/myobject/urls.py路由文件，编写路由配置信息

```python
# myobject/myobject/urls.py

#from django.contrib import admin
from django.urls import include,path

urlpatterns = [
    #path('admin/', admin.site.urls),
    path('', include("web.urls")),                # 默认前台大堂点餐端
    path('myadmin/', include("myadmin.urls")),     # 后台管理端
    path('mobile/', include("mobile.urls")),    # 移动会员端
]
```

- 4.2 打开项目后台管理路由文件：myobject/myadmin/urls.py路由文件，编写路由配置信息

```python
# myobject/myadmin/urls.py

from django.urls import path

from myadmin.views import index

urlpatterns = [
    # 后台首页
    path('', index.index, name="myadmin_index"),

]
```

- 4.3 打开项目前台大堂点餐端路由文件：myobject/web/urls.py路由文件，编写路由配置信息

```python
# myobject/web/urls.py

from django.urls import path

from web.views import index

urlpatterns = [
   # path('', index.index, name="index"),
]
```

- 4.4 打开项目移动会员端路由文件：myobject/mobile/urls.py路由文件，编写路由配置信息

```python
# myobject/mobile/urls.py

from django.urls import path

from web.views import index

urlpatterns = [
   # path('', index.index, name="index"),
]
```

(5). 编写后台视图测试

- 5.1 编辑后台、前台和移动端的视图文件

```python
# myobject/myadmin/views/index.py
from django.shortcuts import render
from django.http import HttpResponse

#后台首页
def index(request):
    return HttpResponse('欢迎进入点餐系统网站后台管理！')
# myobject/web/views/index.py
from django.shortcuts import render
from django.http import HttpResponse

#前台首页
def index(request):
    return HttpResponse('欢迎进入大堂点餐前台首页！')
# myobject/mobile/views/index.py
from django.shortcuts import render
from django.http import HttpResponse

#移动端首页
def index(request):
    return HttpResponse('欢迎进入移动会员端首页！')
```

- 5.2 运行测试
- 在项目根目录下启动服务，并使用浏览器访问测试：http://localhost:8000/myadmin

```
[root@localhost myobject]# pwd
/python/myobject
[root@localhost myobject]# ls
manage.py  myadmin  myobject  web  mobile  static  templates
[root@localhost myobject]# python manage.py runserver 0.0.0.0:8000
Performing system checks...

System check identified no issues (0 silenced).

April 06, 2020 - 14:29:36
Django version 1.11, using settings 'myobject.settings'
Starting development server at http://127.0.0.1:8000/
Quit the server with CONTROL-C.
^C[root@localhost myobject]#
```

(6). 摆放后台首页面：

![img](%E7%82%B9%E9%A4%90%E9%A1%B9%E7%9B%AE%E5%AE%9E%E6%88%98%E4%B9%8B%E5%90%8E%E5%8F%B0%E7%AE%A1%E7%90%86%E5%BC%80%E5%8F%91%E2%80%94%E2%80%94%E6%80%BB%E7%BB%93.assets/admin_main-168197110429911-168197110590512.png)



- 6.1. 使用事先准备好的后台模板：

  - 从github上下载一个后台简洁模板：https://github.com/ColorlibHQ/AdminLTE

  - 将后台模板目录中的资源目录：`bower_components`、`dist`、`local`、`package.json`复制到项目的后台静态资源目录`static/myadmin/`中

  - 在`templates/myadmin/`目录中创建一个基类父模板文件`base.html`

  - 在`templates/myadmin/index/`目录中创建一个首页模板文件`index.html`

  - 在`templates/myadmin/`目录中创建一个信息提示模板文件`info.html`

  - 修改

    ```
    myobject/myadmin/views/index.py
    ```

    视图文件中index函数中代码：

    ```python
    def index(request):
      '''管理后台首页'''
      return render(request,"myadmin/index/index.html")
    ```

- 6.2. 编辑父类模板：/templates/myadmin/base.html

```html
{% load static from staticfiles %}
<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <title>订餐系统后台管理</title>
  <!-- 支持响应式布局 -->
  <meta content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no" name="viewport">
  <link rel="stylesheet" href="{% static 'myadmin/bower_components/bootstrap/dist/css/bootstrap.min.css'%}">
  <!-- 象形字体 -->
  <link rel="stylesheet" href="{% static 'myadmin/bower_components/font-awesome/css/font-awesome.min.css'%}">
  <!-- 图标 -->
  <link rel="stylesheet" href="{% static 'myadmin/bower_components/Ionicons/css/ionicons.min.css'%}">
  <!-- 主题风格样式 -->
  <link rel="stylesheet" href="{% static 'myadmin/dist/css/AdminLTE.min.css'%}">
  <!-- AdminLTE 皮肤.这里选择的是skin-blue样式，我们还可以有其他皮肤可以选择. -->
  <link rel="stylesheet" href="{% static 'myadmin/dist/css/skins/skin-blue.min.css'%}">
  <!-- 兼容IE9以下浏览器 -->
  <!--[if lt IE 9]>
  <script src="{% static 'myadmin/local/js/html5shiv.min.js'%}"></script>
  <script src="{% static 'myadmin/local/js/respond.min.js'%}"></script>
  <![endif]-->
  <!-- Google Font -->
  <link rel="stylesheet" href="{% static 'myadmin/local/css/google_fonts.css'%}">
</head>
<body class="hold-transition skin-blue sidebar-mini">
<div class="wrapper">

  <!-- Main Header 主体页头 -->
  <header class="main-header">

    <!-- Logo -->
    <a href="index2.html" class="logo">
      <!-- 侧栏迷你徽标 mini 50x50 pixels -->
      <span class="logo-mini"><b>餐</b></span>
      <!-- 常规状态标志和移动设备标志 -->
      <span class="logo-lg"><b>订餐系统后台管理</b></span>
    </a>

    <!-- Header Navbar 首部导航栏 -->
    <nav class="navbar navbar-static-top" role="navigation">
      <!-- Sidebar toggle button 侧边栏切换按钮 -->
      <a href="#" class="sidebar-toggle" data-toggle="push-menu" role="button">
        <span class="sr-only">切换导航</span>
      </a>
      <!-- 右栏菜单 -->
      <div class="navbar-custom-menu">
        <ul class="nav navbar-nav">
          <!-- messages-menu 消息菜单: 样式可以在 dropdown.less 中找到 -->
          <li class="dropdown messages-menu">
            <!-- Menu toggle button 菜单切换按钮 -->
            <a href="#" class="dropdown-toggle" data-toggle="dropdown">
              <i class="fa fa-envelope-o"></i>
              <span class="label label-success">4</span>
            </a>
            <ul class="dropdown-menu">
              <li class="header">你有4个短信息</li>
              <li>
                <!-- 内部菜单：包含消息 -->
                <ul class="menu">
                  <li><!-- start message 信息开始 -->
                    <a href="#">
                      <div class="pull-left">
                        <!-- User Image 使用图片 -->
                        <img src="{% static 'myadmin/dist/img/user2-160x160.jpg'%}" class="img-circle" alt="User Image">
                      </div>
                      <!-- 消息标题和时间 -->
                      <h4>
                        我们都支持团队
                        <small><i class="fa fa-clock-o"></i> 5 分钟</small>
                      </h4>
                      <!-- The message -->
                      <p>Why not buy a new awesome theme?</p>
                    </a>
                  </li>
                  <!-- end message -->
                </ul>
                <!-- /.menu -->
              </li>
              <li class="footer"><a href="#">查看所有信息</a></li>
            </ul>
          </li>
          <!-- /.messages-menu -->

          <!-- Notifications Menu 通知菜单 -->
          <li class="dropdown notifications-menu">
            <!-- Menu toggle button  菜单切换按钮 -->
            <a href="#" class="dropdown-toggle" data-toggle="dropdown">
              <i class="fa fa-bell-o"></i>
              <span class="label label-warning">10</span>
            </a>
            <ul class="dropdown-menu">
              <li class="header">你有10条通知信息</li>
              <li>
                <!-- Inner Menu: contains the notifications -->
                <ul class="menu">
                  <li><!-- start notification -->
                    <a href="#">
                      <i class="fa fa-users text-aqua"></i> 今天有5名新成员加入
                    </a>
                  </li>
                  <!-- end notification -->
                </ul>
              </li>
              <li class="footer"><a href="#">查看全部</a></li>
            </ul>
          </li>
          <!-- Tasks Menu 任务菜单 -->
          <li class="dropdown tasks-menu">
            <!-- Menu Toggle Button 菜单切换按钮 -->
            <a href="#" class="dropdown-toggle" data-toggle="dropdown">
              <i class="fa fa-flag-o"></i>
              <span class="label label-danger">9</span>
            </a>
            <ul class="dropdown-menu">
              <li class="header">你有9个任务</li>
              <li>
                <!-- Inner menu: contains the tasks -->
                <ul class="menu">
                  <li><!-- Task item -->
                    <a href="#">
                      <!-- Task title and progress text -->
                      <h3>
                        设计一些按钮
                        <small class="pull-right">20%</small>
                      </h3>
                      <!-- The progress bar -->
                      <div class="progress xs">
                        <!-- Change the css width attribute to simulate progress -->
                        <div class="progress-bar progress-bar-aqua" style="width: 20%" role="progressbar"
                             aria-valuenow="20" aria-valuemin="0" aria-valuemax="100">
                          <span class="sr-only">20% 完成</span>
                        </div>
                      </div>
                    </a>
                  </li>
                  <!-- end task item -->
                </ul>
              </li>
              <li class="footer">
                <a href="#">查看所有任务</a>
              </li>
            </ul>
          </li>
          <!-- User Account Menu -->
          <li class="dropdown user user-menu">
            <!-- Menu Toggle Button -->
            <a href="#" class="dropdown-toggle" data-toggle="dropdown">
              <!-- The user image in the navbar-->
              <img src="{% static 'myadmin/dist/img/user2-160x160.jpg'%}" class="user-image" alt="User Image">
              <!-- hidden-xs hides the username on small devices so only the image appears. -->
              <span class="hidden-xs">{{request.session.adminuser.nickname}}</span>
            </a>
            <ul class="dropdown-menu">
              <!-- The user image in the menu -->
              <li class="user-header">
                <img src="{% static 'myadmin/dist/img/user2-160x160.jpg'%}" class="img-circle" alt="User Image">

                <p>
                  张无忌 - 管理员
                  <small>2020年07月16日加入</small>
                </p>
              </li>
              <!-- Menu Footer-->
              <li class="user-footer">
                <div class="pull-left">
                  <a href="#" class="btn btn-default btn-flat">个人信息</a>
                </div>
                <div class="pull-right">
                  <a href="#" class="btn btn-default btn-flat">退 出</a>
                </div>
              </li>
            </ul>
          </li>

        </ul>
      </div>
    </nav>
  </header>

  <!-- 左侧柱。包含徽标和边栏 -->
  <aside class="main-sidebar">

    <!-- sidebar: style can be found in sidebar.less -->
    <section class="sidebar">

      <!-- Sidebar user panel (optional) -->
      <div class="user-panel">
        <div class="pull-left image">
          <img src="{% static 'myadmin/dist/img/user2-160x160.jpg'%}" class="img-circle" alt="User Image">
        </div>
        <div class="pull-left info">
          <p>张无忌 . 管理员</p>
          <!-- Status -->
          <a href="#"><i class="fa fa-circle text-success"></i> 在线</a>
        </div>
      </div>

      <!-- Sidebar Menu -->
      <ul class="sidebar-menu" data-widget="tree">
        <li class="header">主要导航</li>
        <!-- 导航列表，你可以自行更改图标 -->
        <li class="active"><a href="admin.html"><i class="fa fa-home"></i> <span>首页</span></a></li>

        <li><a href="member.html"><i class="fa fa-users"></i> <span>会员管理</span></a></li>
        <li><a href="shop.html"><i class="fa fa-sitemap"></i> <span>店铺管理</span></a></li>
        <li class="treeview">
          <a href="category.html"><i class="fa fa-cutlery"></i> <span>菜品管理</span>
            <span class="pull-right-container">
              <i class="fa fa-angle-left pull-right"></i>
            </span>
          </a>
          <ul class="treeview-menu">
            <li><a href="category.html"> <i class="fa fa-circle-o"></i> 菜品分类</a></li>
            <li><a href="product.html"> <i class="fa fa-circle-o"></i> 菜品信息</a></li>
          </ul>
        </li>
        <li><a href="orders.html"><i class="fa fa-shopping-cart"></i> <span>订单管理</span></a></li>
        <li><a href="#"><i class="fa fa-user"></i> <span>账号管理</span></a></li>
        <li><a href="#"><i class="fa fa-key"></i> <span>权限管理</span></a></li>
        <li><a href="#"><i class="fa fa-gear"></i> <span>系统配置</span></a></li>
        <li><a href="#"><i class="fa fa-unlock-alt"></i> <span>认证体系</span></a></li>
      </ul>
      <!-- /.sidebar-menu -->
    </section>
    <!-- /.sidebar -->
  </aside>

  <!-- Content Wrapper. Contains page content -->
  <div class="content-wrapper">
    {% block main_body %}
    {% endblock %}
  </div>
  <!-- /.content-wrapper -->

  <!-- Main Footer -->
  <footer class="main-footer">
    <!-- To the right -->
    <div class="pull-right hidden-xs">
      <!--餐饮管理平台-->
    </div>
    <!-- Default to the left -->
    <strong>Copyright &copy; 2020 <a href="#">北京*******有限公司</a>.</strong> 版权所有
  </footer>

  <!-- 添加侧栏的背景。必须放置此处紧接在控制侧边栏之后 -->
  <div class="control-sidebar-bg"></div>
</div>
<!-- ./wrapper -->

<!-- edu-model提示框模板 -->
<div id="edu-alert" class="modal">
  <div class="modal-dialog modal-sm">
    <div class="modal-content">
      <div class="modal-header">
        <button type="button" class="close" data-dismiss="modal"><span aria-hidden="true">×</span><span class="sr-only">Close</span></button>
        <h5 class="modal-title"><i class="fa fa-exclamation-circle"></i> [Title]</h5>
      </div>
      <div class="modal-body small">
        <p>[Message]</p>
      </div>
      <div class="modal-footer" >
        <button type="button" class="btn btn-primary ok" data-dismiss="modal">[BtnOk]</button>
        <button type="button" class="btn btn-default cancel" data-dismiss="modal">[BtnCancel]</button>
      </div>
    </div>
  </div>
</div>
<!-- edu-model-end -->

<!-- REQUIRED JS SCRIPTS -->

<!-- jQuery 3 -->
<script src="{% static 'myadmin/bower_components/jquery/dist/jquery.min.js'%}"></script>
<!-- Bootstrap 3.3.7 -->
<script src="{% static 'myadmin/bower_components/bootstrap/dist/js/bootstrap.min.js'%}"></script>
<!-- AdminLTE App -->
<script src="{% static 'myadmin/dist/js/adminlte.min.js'%}"></script>

<script src="{% static 'myadmin/dist/js/edu-modal-alert-confirm.js'%}"></script>

<!-- 此处可以添加SimLoopl和FastClick插件，用于增强用户体验。 -->

<script type="text/javascript">
  //自定义一个用于实现Ajax信息删除的函数
  function doDelete(del_url){
    Modal.confirm({
      msg: "确定要删除吗？",
      title: ' 信息提示',
      btnok: '确定',
      btncl:'取消'
    }).on(function (e){
      if(e){ //判断是否点击了确定按钮
        $.ajax({
          type:'get',
          url:del_url,
          dataType:'json',
          async: false,
          success:function(res){
            Modal.alert({msg:res.info, title:' 信息提示',btnok: '确定',btncl:'取消'});
            window.location.reload(); //刷新当前页面.
          },
        });
      }
    });
  }
</script>
{% block loadjavascript %}
<!-- 此处可加载独立的javascript程序 -->
{% endblock %}
</body>
</html>
```

- 6.3. 编辑后台首页模板：/templates/myadmin/index.html

```html
{% extends 'myadmin/base.html' %}

{% block main_body %}
    <!-- Content Header (Page header) -->
    <section class="content-header">
      <h1>
        首页
        <small>订餐系统后台管理</small>
      </h1>
      <ol class="breadcrumb">
        <li><a href="#"><i class="fa fa-dashboard"></i> Level</a></li>
        <li class="active">Here</li>
      </ol>
    </section>

    <!-- Main content -->
    <section class="content container-fluid">
      <!-- Small boxes (Stat box) -->
      <div class="row">
        <div class="col-lg-3 col-xs-6">
          <!-- small box -->
          <div class="small-box bg-aqua">
            <div class="inner">
              <h3>150</h3>

              <p>新订单</p>
            </div>
            <div class="icon">
              <i class="ion ion-bag"></i>
            </div>
            <a href="#" class="small-box-footer">更多信息 <i class="fa fa-arrow-circle-right"></i></a>
          </div>
        </div>
        <!-- ./col -->
        <div class="col-lg-3 col-xs-6">
          <!-- small box -->
          <div class="small-box bg-green">
            <div class="inner">
              <h3>53<sup style="font-size: 20px">%</sup></h3>

              <p>Bounce Rate</p>
            </div>
            <div class="icon">
              <i class="ion ion-stats-bars"></i>
            </div>
            <a href="#" class="small-box-footer">更多信息 <i class="fa fa-arrow-circle-right"></i></a>
          </div>
        </div>
        <!-- ./col -->
        <div class="col-lg-3 col-xs-6">
          <!-- small box -->
          <div class="small-box bg-yellow">
            <div class="inner">
              <h3>44</h3>

              <p>用户注册</p>
            </div>
            <div class="icon">
              <i class="ion ion-person-add"></i>
            </div>
            <a href="#" class="small-box-footer">更多信息 <i class="fa fa-arrow-circle-right"></i></a>
          </div>
        </div>
        <!-- ./col -->
        <div class="col-lg-3 col-xs-6">
          <!-- small box -->
          <div class="small-box bg-red">
            <div class="inner">
              <h3>65</h3>

              <p>Unique Visitors</p>
            </div>
            <div class="icon">
              <i class="ion ion-pie-graph"></i>
            </div>
            <a href="#" class="small-box-footer">More info <i class="fa fa-arrow-circle-right"></i></a>
          </div>
        </div>
        <!-- ./col -->
      </div>

    </section>
    <!-- /.content -->
{% endblock %}
```

- 6.4. 后台公共提示信息模板：/templates/myadmin/info.html

```html
{% extends "myadmin/base.html" %}

{% block main_body %}                
    <!-- Content Header (Page header) -->
    <section class="content-header">
      <h4>
        信息提示:
      </h4>
    </section>

    <div class="pad margin no-print">
      <div class="callout callout-info" style="margin-bottom: 0!important;padding-left: 50px">
        <h3><i class="fa fa-exclamation-triangle"></i>  &nbsp; {{ info }}</h3>
      </div>
    </div>
{% endblock %}
```



# 个人总结部分

## 1、view主业务如何编写

```python
首先导包：
from django.shortcuts import render
from django.http import HttpResponse
from django.http import JsonResponse
from django.db.models import Q
from django.core.paginator import Paginator
from datetime import datetime
import random

from myadmin.models import User


def index(request,pIndex=1):
    '''浏览信息'''
    umod = User.objects
    mywhere=[]
    list = umod.filter(status__lt=9)  #过滤status小于9的数字

    # 获取、判断并封装关keyword键搜索
    kw = request.GET.get("keyword",None) #获取前端数据
    if kw:
        # 查询员工账号或昵称中只要含有关键字的都可以、、、Q对象可以使用&、|连接，&表示逻辑与，|表示逻辑或。
        list = list.filter(Q(username__contains=kw) | Q(nickname__contains=kw))
        mywhere.append("keyword="+kw)

    # 获取、判断并封装状态status搜索条件
    status = request.GET.get('status','')
    if status != '':
        list = list.filter(status=status)
        mywhere.append("status="+status)

    #执行分页处理
    pIndex = int(pIndex)
    page = Paginator(list,5) #以5条每页创建分页对象
    maxpages = page.num_pages #最大页数
    #判断页数是否越界
    if pIndex > maxpages:
        pIndex = maxpages
    if pIndex < 1:
        pIndex = 1
    list2 = page.page(pIndex) #当前页数据
    plist = page.page_range   #页码数列表

    #list2 = User.objects.all() #获取所有信息
    #封装信息加载模板输出
    context = {"userlist":list2,'plist':plist,'pIndex':pIndex,'maxpages':maxpages,'mywhere':mywhere}
    return render(request,"myadmin/user/index.html",context)

目标：


数据库增删改查

增

ob= object()##这里ob就是指models函数
 ob.status = 1
 ob.save()
>>> PeopleInfo.objects.create(
...         name='itheima',
...         book=book
...     )

删
ob.status = 9
ob.save()

>>> person = PeopleInfo.objects.get(name='传智播客')
>>> person.delete()
改
>>> PeopleInfo.objects.filter(name='itcast').update(name='传智播客')
1
>>> person = PeopleInfo.objects.get(name='itheima')
>>> person.name = 'itcast'
>>> person.save()
查
list = User.objects.filter(status__lt=9)


图片上传
        # 店铺封面图片的上传处理
        myfile = request.FILES.get("cover_pic",None)
        if not myfile:
            return HttpResponse("没有店铺封面上传文件信息")
        cover_pic = str(time.time())+"."+myfile.name.split('.').pop()
        destination = open("./static/uploads/shop/"+cover_pic,"wb+")
        for chunk in myfile.chunks():      # 分块写入文件  
            destination.write(chunk)  
        destination.close()
验证码
# ==============后台管理员操作====================
# 会员登录表单
def verify(request):
    #引入随机函数模块
    import random
    from PIL import Image, ImageDraw, ImageFont
    #定义变量，用于画面的背景色、宽、高
    #bgcolor = (random.randrange(20, 100), random.randrange(
    #    20, 100),100)
    bgcolor = (242,164,247)
    width = 100
    height = 25
    #创建画面对象
    im = Image.new('RGB', (width, height), bgcolor)
    #创建画笔对象
    draw = ImageDraw.Draw(im)
    #调用画笔的point()函数绘制噪点
    for i in range(0, 100):
        xy = (random.randrange(0, width), random.randrange(0, height))
        fill = (random.randrange(0, 255), 255, random.randrange(0, 255))
        draw.point(xy, fill=fill)
    #定义验证码的备选值
    #str1 = 'ABCD123EFGHIJK456LMNOPQRS789TUVWXYZ0'
    str1 = '0123456789'
    #随机选取4个值作为验证码
    rand_str = ''
    for i in range(0, 4):
        rand_str += str1[random.randrange(0, len(str1))]
    #构造字体对象，ubuntu的字体路径为“/usr/share/fonts/truetype/freefont”
    font = ImageFont.truetype('static/arial.ttf', 21)
    #font = ImageFont.load_default().font
    #构造字体颜色
    fontcolor = (255, random.randrange(0, 255), random.randrange(0, 255))
    #绘制4个字
    draw.text((5, -3), rand_str[0], font=font, fill=fontcolor)
    draw.text((25, -3), rand_str[1], font=font, fill=fontcolor)
    draw.text((50, -3), rand_str[2], font=font, fill=fontcolor)
    draw.text((75, -3), rand_str[3], font=font, fill=fontcolor)
    #释放画笔
    del draw
    #存入session，用于做进一步验证
    request.session['verifycode'] = rand_str
    """
    python2的为
    # 内存文件操作
    import cStringIO
    buf = cStringIO.StringIO()
    """
    # 内存文件操作-->此方法为python3的
    import io
    buf = io.BytesIO()
    #将图片保存在内存中，文件类型为png
    im.save(buf, 'png')
    #将内存中的图片数据返回给客户端，MIME类型为图片png
    return HttpResponse(buf.getvalue(), 'image/png')

 <img src="{% url 'myadmin_verify'%}" onclick="this.src='{% url 'myadmin_verify' %}?sn='+Math.random()" style="float:right;margin:5px 20px;" />
      
   #验证判断
    verifycode = request.session['verifycode']
    code = request.POST['code']
    if verifycode != code:
        context = {'info':'验证码错误！'}
        return render(request,"myadmin/index/login.html",context)


session
                
    这里是登录写入session
    # 将当前登录成功用户信息以adminuser这个key放入到session中
                request.session['adminuser']=user.toDict()


        这里是中间件：
        
            # 判断当前用户是否没有登录
            if "adminuser" not in request.session:
                # 执行登录界面跳转
                return redirect(reverse('myadmin_login'))

中间件
# 自定义中间件类
from django.shortcuts import redirect
from django.urls import reverse

import re

class ShopMiddleware(object):
    def __init__(self, get_response):
        self.get_response = get_response
        # One-time configuration and initialization.
        print("ShopMiddleware")

    def __call__(self, request):

        # 获取当前请求路径
        path = request.path
        #print("mycall..."+path)

        # 后台请求路由判断
        # 定义网站后台不用登录也可访问的路由url
        urllist = ['/myadmin/login','/myadmin/dologin','/myadmin/logout','/myadmin/verify']
        # 判断当前请求是否是访问网站后台,并且path不在urllist中
        if re.match(r"^/myadmin",path) and (path not in urllist):
            # 判断当前用户是否没有登录
            if "adminuser" not in request.session:
                # 执行登录界面跳转
                return redirect(reverse('myadmin_login'))


        # 请求继续执行下去
        response = self.get_response(request)
        # Code to be executed for each request/response after
        # the view is called.
        return response
    
  setting.py  
    MIDDLEWARE = [
     'myadmin.shopmiddleware.ShopMiddleware',     #注册中间件
]
    
    
登录

from django.shortcuts import render
from django.http import HttpResponse
from django.shortcuts import redirect
from django.urls import reverse

from myadmin.models import User

...

# ==============后台管理员操作====================
def login(request):
    '''加载登录页面'''
    return render(request,"myadmin/index/login.html")

def dologin(request):
    '''执行登录'''
    try:
        #根据登录账号获取用户信息
        user = User.objects.get(username=request.POST['username'])
        # 校验当前用户状态是否是管理员
        if user.status == 6:
            #获取密码并md5
            import hashlib
            md5 = hashlib.md5()
            n = user.password_salt
            s = request.POST['pass']+str(n) 
            md5.update(s.encode('utf-8'))
            # 校验密码是否正确
            if user.password_hash == md5.hexdigest():
                # 将当前登录成功用户信息以adminuser这个key放入到session中
                request.session['adminuser']=user.toDict()
                return redirect(reverse('myadmin_index'))
            else:
                context={"info":"登录密码错误！"}
        else:
            context={"info":"此用户非后台管理账号！"}
    except Exception as err:
        print(err)
        context={"info":"登录账号不存在！"}
    return render(request,"myadmin/index/login.html",context)

def logout(request):
    '''执行退出'''
    del request.session['adminuser']
    return redirect(reverse('myadmin_login'))
...

退出


分页
 #执行分页处理
    pIndex = int(pIndex)
    page = Paginator(list,5) #以5条每页创建分页对象
    maxpages = page.num_pages #最大页数
    #判断页数是否越界
    if pIndex > maxpages:
        pIndex = maxpages
    if pIndex < 1:
        pIndex = 1
    list2 = page.page(pIndex) #当前页数据
    plist = page.page_range   #页码数列表
    
    #list2 = User.objects.all() #获取所有信息
翻页

分页输入Pindex就可以翻页了




微信接口






```





[Django Models 多条件查询 以及 Q/F 查询](https://my.oschina.net/esdn/blog/834943)

### **Models 多条件查询方法：**

**1、传参数**

```python
models.UserInfo.objects.filter(id=3,name='alex')
```

**2、传字典**

需要注意的是，传入字典时，字典前面需要加 ***\*** ，记为字典

```python
dic = {'id':123,'name':'alex'}
models.UserInfo.objects.filter(**dic)
```

所以我们可以在在捕捉用户输入后，将输入构造成字典，然后将字典当做参数传入查询

**3、传 Q 对象，构造搜索条件**

a、在 filter () 等函式中关键字参数彼此之间都是 **"AND" 关系**。如果你要执行更复杂的查询 (比如，
实现筛选条件的 **OR 关系**)，可以使用 Q 对象。
b、Q 对象包括 AND 关系 和 OR 关系
c、Q 对象可以用 & 和 | 运算符进行连接。当某个操作连接两个 Q 对象时，**就会产生一个新的等
价的 Q 对象。**

如：下面这段语句就产生了一个 Q ，这是用 "OR" 关系连接

```python
Q(question__startswith='Who') | Q(question__startswith='What')
```

d、每种查询函式 (比如 filter (), exclude (), get ()) 除了能接收关键字参数以外，也能以位置参数的
形式接受一个或多个 Q 对象。如果你给查询函式传递了多个 Q 对象，那么它们彼此间都是
**"AND" 关系。**例如：

```python
Poll.objects.get(
Q(question__startswith='Who'),
Q(pub_date=date(2005, 5, 2)) | Q(pub_date=date(2005, 5, 6))
)
```

**e: filter () 等函数 可以接受 Q 对象和条件参数，但 Q 对象必须放在 条件参数前面**

**4、Q 对象使用实例：**

首先还是需要导入模块

```python
from django.db.models import Q
```

**传入条件进行查询:**

```python
q1 = Q()
q1.connector = 'OR'              #连接方式
q1.children.append(('id', 1))
q1.children.append(('id', 2))
q1.children.append(('id', 3))
    
models.Tb1.objects.filter(q1)
```



合并条件进行查询:

```python
con = Q()

q1 = Q()
q1.connector = 'OR'
q1.children.append(('id', 1))
q1.children.append(('id', 2))
q1.children.append(('id', 3))

q2 = Q()
q2.connector = 'OR'
q2.children.append(('status', '在线'))

con.add(q1, 'AND')
con.add(q2, 'AND')

models.Tb1.objects.filter(con)
```



F 对象

- 可以使用模型的字段 A 与字段 B 进行比较，如果 A 写在了等号的左边，则 B 出现在等号的右边，需要通过 F 对象构造

```
list.filter(bread__gte=F('bcommet'))
```

- django 支持对 F () 对象使用算数运算

```
list.filter(bread__gte=F('bcommet') * 2)
```

- F () 对象中还可以写作 “模型类__列名” 进行关联查询

```
list.filter(isDelete=F('heroinfo__isDelete'))
```

- 对于 date/time 字段，可与 timedelta () 进行运算

```
list.filter(bpub_date__lt=F('bpub_date') + timedelta(days=1))
```



Q 对象

- 过滤器的方法中关键字参数查询，会合并为 And 进行
- 需要进行 or 查询，使用 Q () 对象
- Q 对象 (django.db.models.Q) 用于封装一组关键字参数，这些关键字参数与 “比较运算符” 中的相同

```
from django.db.models import Q
list.filter(Q(pk_ _lt=6))
```

- Q 对象可以使用 &（and）、|（or）操作符组合起来
- 当操作符应用在两个 Q 对象时，会产生一个新的 Q 对象

```
list.filter(pk_ _lt=6).filter(bcommet_ _gt=10)
list.filter(Q(pk_ _lt=6) | Q(bcommet_ _gt=10))
```

- 使用～（not）操作符在 Q 对象前表示取反

```
list.filter(~Q(pk__lt=6))
```

- 可以使用 &|~ 结合括号进行分组，构造做生意复杂的 Q 对象
- 过滤器函数可以传递一个或多个 Q 对象作为位置参数，如果有多个 Q 对象，这些参数的逻辑为 and
- 过滤器函数可以混合使用 Q 对象和关键字参数，所有参数都将 and 在一起，Q 对象必须位于关键字参数的前面







## 2、模板语言以及ajax

https://www.bootcss.com/

https://www.runoob.com/js/js-tutorial.html



~~~html
总结一下
1、变量
｛｛ var ｝｝

{% tag  %}

{% for.. in .. %}
循环逻辑
{% endfor %}

{ %  if ...  % }
    逻辑1
{ %  elif ...  % }
    逻辑2
{ %  else  % }
    逻辑3
{ %  endif  % }

{ %  comment  % }
    多行注释
{ %  endcomment  % }

{ %  include "base/index.html"  % }include：加载模板并以标签内的参数渲染

{ %  url 'name' p1 p2  % }url：反向解析

{ %  csrf_token  % }csrf_token：这个标签用于跨站请求伪造保护

{ {  变量|过滤器  } }，例如{ {  name|lower  } }，表示将变量name的值变为小写输出

{ {  data|safe  } }
if list1|length > 1
name|lower|upper
list|join:", "
value|default:"什么也没有"
value|date:'Y-m-d'

{# 注释 #}
{%  comment  %}
      多行注释
{%  endcomment  %}

使用：在模板文件使用 
{ % load pagetag % }
  <h4>6. 自定义标签 </h4>
  {% load pagetag %}
  大写：{{name|myupper}} <br/>
  相减：{% jian m1 m2 %}

模板运算

{ {  value|add:10  } }
note:value=5,则结果返回15

{ {  value|add:-10  } }
note:value=5,则结果返回-5，加一个负数就是减法了

{ %  widthratio 5 1 100  % }
note:等同于：(5 / 1) * 100 ，结果返回500，
withratio需要三个参数，它会使用参数1/参数2*参数3的方式进行运算，进行乘法运算，使「参数2」=1


{ %  widthratio 5 100 1  % }
note:等同于：(5 / 100) * 1,则结果返回0.05,和乘法一样，使「参数3」= 1就是除法了。



### 6.自定义 标签 或 过滤器

- 首先在当前应用目录下创建一个`templatetags`模板标签目录，建议内放一个`__init__.py`的空文件
- 然后在`templatetags`目录下创建一个模板标签文件`pagetag.py`,具体代码如下：

```python
 templatetags
    ├── pagetag.py
    ----------------pagetag.py-------------------------
    from django import template

    register = template.Library()

    # 自定义过滤器（实现大写转换）
    @register.filter
    def myupper(val):
        # print ('val from template:',val)
        return val.upper()

    # 自定义标签（实现减法计算）
    #from django.utils.html import format_html
    @register.simple_tag
    def jian(a,b):
        res = int(a) - int(b)
        return res
```

- 使用：在模板文件使用 `{ % load pagetag % }`

```
  <h4>6. 自定义标签 </h4>
  {% load pagetag %}
  大写：{{name|myupper}} <br/>
  相减：{% jian m1 m2 %}
```

### 模板继承

总结：
 模板继承可以减少页面内容的重复定义，实现页面内容的重用
 
 定义父模板base.html
{ %  block block_name  % }
   这里可以定义默认值
   如果不定义默认值，则表示空字符串
{ %  endblock  % }


定义子模板index.html
{ %  extends "base.html"  % }



在子模板中使用block填充预留区域
{ %  block block_name  % }
实际填充内容
{ %  endblock  % }



如果在模版中使用extends标签，它必须是模版中的第一个标签
不能在一个模版中定义多个相同名字的block标签
{ %  block block_name  % }
    区域内容
{ %  endblock block_name  % }

- ck标签：在父模板中预留区域，在子模板中填充
- **extends继承：继承，写在模板文件的第一行**
- 定义父模板base.html

```js
{ %  block block_name  % }
   这里可以定义默认值
   如果不定义默认值，则表示空字符串
{ %  endblock  % }
```

- 定义子模板index.html

```
{ %  extends "base.html"  % }
```

- 在子模板中使用block填充预留区域

```js
{ %  block block_name  % }
实际填充内容
{ %  endblock  % }
```

#### 说明

- **如果在模版中使用extends标签，它必须是模版中的第一个标签**
- **不能在一个模版中定义多个相同名字的block标签**
- 子模版不必定义全部父模版中的blocks，如果子模版没有定义block，则使用了父模版中的默认值
- 如果发现在模板中大量的复制内容，那就应该把内容移动到父模板中
- 使用可以获取父模板中block的内容
- 为了更好的可读性，可以给endblock标签一个名字

```js
{ %  block block_name  % }
    区域内容
{ %  endblock block_name  % }
```

### 三层继承结构

- 三层继承结构使代码得到最大程度的复用，并且使得添加内容更加简单

#### 1.创建根级模板

- 名称为“base.html”
- 存放整个站点共用的内容

```js
<!DOCTYPE html>
<html>
    <head>
        <title>{ %  block title  % }{ %  endblock  % } 水果超市</title>
    </head>
    <body>
        top--{{logo}}
        <hr/>
        { %  block left  % }

        { %  endblock  % }

        { %  block content  % }

        { %  endblock  % }
        <hr/>
        bottom
    </body>
</html>
```

#### 2.创建分支模版

- 继承自base.html
- 名为“base_***.html”
- 定义特定分支共用的内容
- 定义base_goods.html

```js
{ %  extends 'temtest/base.html'  % }

{ %  block title  % }商品{ %   endblock   % }

{ %  block left  % }
    <h1>goods left</h1>
{ %  endblock  % }
```

- 定义base_user.html

```js
{ %  extends 'temtest/base.html'  % }

{ %  block title  % }用户中心{ %  endblock   % }

{ %  block left  % }
    <font color='blue'>user left</font>
{ %  endblock  % }
```

- 定义index.html，继承自base.html，不需要写left块

```js
{ %  extends 'temtest/base.html'  % }

{ %  block content  % }
    首页内容
{ %  endblock content  % }
```

#### 3.为具体页面创建模板，继承自分支模板

- 定义商品列表页goodslist.html

```js
{ %  extends 'temtest/base_goods.html'  % }
{ %  block content  % }
    商品正文列表
{ %  endblock content  % }
```

- 定义用户密码页userpwd.html

```js
{ %  extends 'temtest/base_user.html'  % }
{ %  block content  % }
    用户密码修改
{ %  endblock content  % }
```

#### 4.视图调用具体页面，并传递模板中需要的数据

- 首页视图index

```py
logo='welcome to itcast'
def index(request):
    return render(request, 'temtest/index.html', {'logo': logo})
```

- 商品列表视图goodslist

```py
def goodslist(request):
    return render(request, 'temtest/goodslist.html', {'logo': logo})
```

- 用户密码视图userpwd

```py
def userpwd(request):
    return render(request, 'temtest/userpwd.html', {'logo': logo})
```

#### 5.配置url

```py
from django.urls import path
from . import views
urlpatterns = [
    path('', views.index, name='index'),
    path('list/', views.goodslist, name='list'),
    path('pwd/', views.userpwd, name='pwd'),
]
```

### 

- ck标签：在父模板中预留区域，在子模板中填充
- **extends继承：继承，写在模板文件的第一行**
- 定义父模板base.html

```js
{ %  block block_name  % }
   这里可以定义默认值
   如果不定义默认值，则表示空字符串
{ %  endblock  % }
```

- 定义子模板index.html

```
{ %  extends "base.html"  % }
```

- 在子模板中使用block填充预留区域

```js
{ %  block block_name  % }
实际填充内容
{ %  endblock  % }
```

#### 说明

- **如果在模版中使用extends标签，它必须是模版中的第一个标签**
- **不能在一个模版中定义多个相同名字的block标签**
- 子模版不必定义全部父模版中的blocks，如果子模版没有定义block，则使用了父模版中的默认值
- 如果发现在模板中大量的复制内容，那就应该把内容移动到父模板中
- 使用可以获取父模板中block的内容
- 为了更好的可读性，可以给endblock标签一个名字

```js
{ %  block block_name  % }
    区域内容
{ %  endblock block_name  % }
```

### 三层继承结构

- 三层继承结构使代码得到最大程度的复用，并且使得添加内容更加简单

#### 1.创建根级模板

- 名称为“base.html”
- 存放整个站点共用的内容

```js
<!DOCTYPE html>
<html>
    <head>
        <title>{ %  block title  % }{ %  endblock  % } 水果超市</title>
    </head>
    <body>
        top--{{logo}}
        <hr/>
        { %  block left  % }

        { %  endblock  % }

        { %  block content  % }

        { %  endblock  % }
        <hr/>
        bottom
    </body>
</html>
```

#### 2.创建分支模版

- 继承自base.html
- 名为“base_***.html”
- 定义特定分支共用的内容
- 定义base_goods.html

```js
{ %  extends 'temtest/base.html'  % }

{ %  block title  % }商品{ %   endblock   % }

{ %  block left  % }
    <h1>goods left</h1>
{ %  endblock  % }
```

- 定义base_user.html

```js
{ %  extends 'temtest/base.html'  % }

{ %  block title  % }用户中心{ %  endblock   % }

{ %  block left  % }
    <font color='blue'>user left</font>
{ %  endblock  % }
```

- 定义index.html，继承自base.html，不需要写left块

```js
{ %  extends 'temtest/base.html'  % }

{ %  block content  % }
    首页内容
{ %  endblock content  % }
```

#### 3.为具体页面创建模板，继承自分支模板

- 定义商品列表页goodslist.html

```js
{ %  extends 'temtest/base_goods.html'  % }
{ %  block content  % }
    商品正文列表
{ %  endblock content  % }
```

- 定义用户密码页userpwd.html

```js
{ %  extends 'temtest/base_user.html'  % }
{ %  block content  % }
    用户密码修改
{ %  endblock content  % }
```

#### 4.视图调用具体页面，并传递模板中需要的数据

- 首页视图index

```py
logo='welcome to itcast'
def index(request):
    return render(request, 'temtest/index.html', {'logo': logo})
```

- 商品列表视图goodslist

```py
def goodslist(request):
    return render(request, 'temtest/goodslist.html', {'logo': logo})
```

- 用户密码视图userpwd

```py
def userpwd(request):
    return render(request, 'temtest/userpwd.html', {'logo': logo})
```

#### 5.配置url

```py
from django.urls import path
from . import views
urlpatterns = [
    path('', views.index, name='index'),
    path('list/', views.goodslist, name='list'),
    path('pwd/', views.userpwd, name='pwd'),
]
```


//######js




{% block myjavascript %}
<script type="text/javascript">
    $("button:contains('点击获取')").click(function(){
        bt = $(this);
        if(bt.html() != "点击获取"){
            return;
        }
        var phone = $("#name").val();
        //$.get();
        bt = $(this);
        var t=60;
        bt.html(t+"秒")
        var mytime = setInterval(function(){
            t= t-1;
            bt.html(t+"秒")
            if(t <= 0){
                clearInterval(mytime)
                bt.html("点击获取");
            }
        },1000);

    });
</script>
{% endblock %}


### 
~~~



#### Ajax CSRF 认证

> GET 请求不需要 CSRF 认证，POST 请求需要正确认证才能得到正确的返回结果。

**如果使用Ajax调用的时候，就要麻烦一些。需要注意以下几点：**

- 在视图中使用**render** （而不要使用 render_to_response）

- 使用 jQuery 的 ajax 或者 post 之前 加入这个 js 代码

  ```js
  jQuery(document).ajaxSend(function(event, xhr, settings) {
      function getCookie(name) {
          var cookieValue = null;
          if (document.cookie && document.cookie != '') {
              var cookies = document.cookie.split(';');
              for (var i = 0; i < cookies.length; i++) {
                  var cookie = jQuery.trim(cookies[i]);
                  // Does this cookie string begin with the name we want?
                  if (cookie.substring(0, name.length + 1) == (name + '=')) {
                      cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                      break;
                  }
              }
          }
          return cookieValue;
      }
      function sameOrigin(url) {
          // url could be relative or scheme relative or absolute
          var host = document.location.host; // host + port
          var protocol = document.location.protocol;
          var sr_origin = '//' + host;
          var origin = protocol + sr_origin;
          // Allow absolute or scheme relative URLs to same origin
          return (url == origin || url.slice(0, origin.length + 1) == origin + '/') ||
              (url == sr_origin || url.slice(0, sr_origin.length + 1) == sr_origin + '/') ||
              // or any other URL that isn't scheme relative or absolute i.e relative.
              !(/^(\/\/|http:|https:).*/.test(url));
      }
      function safeMethod(method) {
          return (/^(GET|HEAD|OPTIONS|TRACE)$/.test(method));
      }
  
      if (!safeMethod(settings.type) && sameOrigin(settings.url)) {
          xhr.setRequestHeader("X-CSRFToken", getCookie('csrftoken'));
      }
  });
  ```

- 或者 **更为优雅简洁的代码（不能写在 .js 中，要直接写在模板文件中**）：

  ```js
  $.ajaxSetup({
      data: {csrfmiddlewaretoken: '{ { csrf_token } }' },
  });
  ```

这样之后，就可以像原来一样的使用 jQuery.ajax() 和 jQuery.post()了

#### Django之ajax

https://blog.csdn.net/m0_64599482/article/details/128172693

[Django之Ajax](https://www.cnblogs.com/chen-ao666/p/16993245.html)

https://code.ziqiangxuetang.com/django/django-ajax.html





**目录**

- [什么是Ajax?](https://www.cnblogs.com/chen-ao666/p/16993245.html#_label0)

- - [什么是同步请求？(false)](https://www.cnblogs.com/chen-ao666/p/16993245.html#_lab2_0_0)
  - [ 什么是异步请求？(默认:true)](https://www.cnblogs.com/chen-ao666/p/16993245.html#_lab2_0_1)

- [Ajax 的优势](https://www.cnblogs.com/chen-ao666/p/16993245.html#_label1)

- [应用场景](https://www.cnblogs.com/chen-ao666/p/16993245.html#_label2)

- [Ajax 的操作流程](https://www.cnblogs.com/chen-ao666/p/16993245.html#_label3)

- - [具体操作流程：](https://www.cnblogs.com/chen-ao666/p/16993245.html#_lab2_3_0)

- [基本语法](https://www.cnblogs.com/chen-ao666/p/16993245.html#_label4)

- - [示例：](https://www.cnblogs.com/chen-ao666/p/16993245.html#_lab2_4_0)

- [前后端数据传输的编码格式](https://www.cnblogs.com/chen-ao666/p/16993245.html#_label5)

- - [1.前端可以向后端发起post请求的方式](https://www.cnblogs.com/chen-ao666/p/16993245.html#_lab2_5_0)
  - [2.基于post请求, 前后端数据传输的主流编码格式有三种](https://www.cnblogs.com/chen-ao666/p/16993245.html#_lab2_5_1)
  - [3.基于post请求, form表单传输数据默认的编码格式](https://www.cnblogs.com/chen-ao666/p/16993245.html#_lab2_5_2)
  - [4.基于post请求, ajax传输数据默认编码格式](https://www.cnblogs.com/chen-ao666/p/16993245.html#_lab2_5_3)
  - [5.json.loads( )是否可以转Bytes格式](https://www.cnblogs.com/chen-ao666/p/16993245.html#_lab2_5_4)

- [ Ajax发送数据](https://www.cnblogs.com/chen-ao666/p/16993245.html#_label6)

- - [Ajax发送json格式数据](https://www.cnblogs.com/chen-ao666/p/16993245.html#_lab2_6_0)

  - - [后端如何处理json格式字符串](https://www.cnblogs.com/chen-ao666/p/16993245.html#_label3_6_0_0)
    - [ajax发送json格式数据需要注意的点：](https://www.cnblogs.com/chen-ao666/p/16993245.html#_label3_6_0_1)

  - [Ajax发送文件数据](https://www.cnblogs.com/chen-ao666/p/16993245.html#_lab2_6_1)

  - - [Ajax发送文件需要注意的点：](https://www.cnblogs.com/chen-ao666/p/16993245.html#_label3_6_1_0)

- [Ajax补充说明](https://www.cnblogs.com/chen-ao666/p/16993245.html#_label7)

- - [字典数据前后端交互的几种方式](https://www.cnblogs.com/chen-ao666/p/16993245.html#_lab2_7_0)

  - - [ 1. 直接发送](https://www.cnblogs.com/chen-ao666/p/16993245.html#_label3_7_0_0)
    - [2. 后端先转成json格式，再发送给前端](https://www.cnblogs.com/chen-ao666/p/16993245.html#_label3_7_0_1)
    - [3. JOSN.parse()反序列化](https://www.cnblogs.com/chen-ao666/p/16993245.html#_label3_7_0_2)
    - [4. dataType:'json'](https://www.cnblogs.com/chen-ao666/p/16993245.html#_label3_7_0_3)
    - [5. 后端通过JsonResponse处理](https://www.cnblogs.com/chen-ao666/p/16993245.html#_label3_7_0_4)

[返回目录](https://www.cnblogs.com/chen-ao666/p/16993245.html#_labelTop)

什么是Ajax?

![img](%E7%82%B9%E9%A4%90%E9%A1%B9%E7%9B%AE%E5%AE%9E%E6%88%98%E4%B9%8B%E5%90%8E%E5%8F%B0%E7%AE%A1%E7%90%86%E5%BC%80%E5%8F%91%E2%80%94%E2%80%94%E6%80%BB%E7%BB%93.assets/2639438-20221219185619831-944186846.png)

- ajax 全名: async javascript and XML(异步JavaScript和XML)
- 是前后台交互的能⼒, 也就是我们客户端给服务端发送消息的⼯具，以及接受响应的⼯具
- AJAX 不是新的编程语言，而是一种使用现有标准的新方法。
- AJAX 是与服务器交换数据并更新部分网页的艺术，在不重新加载整个页面的情况下。
- 是⼀个默认异步执⾏机制的功能，AJAX分为同步（async = false）和异步（async = true）

[返回目录](https://www.cnblogs.com/chen-ao666/p/16993245.html#_labelTop)

什么是同步请求？(false)

```
1  同步请求是指当前发出请求后，浏览器什么都不能做，
2  必须得等到请求完成返回数据之后，才会执行后续的代码，
3  相当于生活中的排队，必须等待前一个人完成自己的事物，后一个人才能接着办。
4  也就是说，当JS代码加载到当前AJAX的时候会把页面里所有的代码停止加载，页面处于一个假死状态，
5  当这个AJAX执行完毕后才会继续运行其他代码页面解除假死状态
```

[返回目录](https://www.cnblogs.com/chen-ao666/p/16993245.html#_labelTop)

 什么是异步请求？(默认:true)

```
1 默认异步：异步请求就当发出请求的同时，浏览器可以继续做任何事，
2 Ajax发送请求并不会影响页面的加载与用户的操作，相当于是在两条线上，各走各的，互不影响。
3 一般默认值为true，异步。异步请求可以完全不影响用户的体验效果，
4 无论请求的时间长或者短，用户都在专心的操作页面的其他内容，并不会有等待的感觉。
```

[返回目录](https://www.cnblogs.com/chen-ao666/p/16993245.html#_labelTop)

Ajax 的优势

- AJAX使用JavaScript技术向服务器发送异步请求；
- AJAX请求无须刷新整个页面；
- 因为服务器响应内容不再是整个页面，而是页面中的部分内容，所以AJAX性能高； 
- 两个关键点:1.局部刷新，2.异步请求

[返回目录](https://www.cnblogs.com/chen-ao666/p/16993245.html#_labelTop)

应用场景

搜索引擎根据用户输入的关键字，自动提示检索关键字。

还有一个很重要的应用场景就是注册时候的用户名的查重。

其实这里就使用了AJAX技术！当文件框发生了输入变化时，使用AJAX技术向服务器发送一个请求，然后服务器会把查询到的结果响应给浏览器，最后再把后端返回的结果展示出来。

- 整个过程中页面没有刷新，只是刷新页面中的局部位置而已！
- 当请求发出后，浏览器还可以进行其他操作，无需等待服务器的响应！

![img](%E7%82%B9%E9%A4%90%E9%A1%B9%E7%9B%AE%E5%AE%9E%E6%88%98%E4%B9%8B%E5%90%8E%E5%8F%B0%E7%AE%A1%E7%90%86%E5%BC%80%E5%8F%91%E2%80%94%E2%80%94%E6%80%BB%E7%BB%93.assets/2639438-20221219191529249-197034207.png)

当输入用户名后，把光标移动到其他表单项上时，浏览器会使用Ajax技术向服务器发出请求，服务器会查询名为lemontree7777777的用户是否存在，最终服务器返回true表示名为lemontree7777777的用户已经存在了，浏览器在得到结果后显示“用户名已被注册！”。

- 整个过程中页面没有刷新，只是局部刷新了；
- 在请求发出后，浏览器不用等待服务器响应结果就可以进行其他操作；

[返回目录](https://www.cnblogs.com/chen-ao666/p/16993245.html#_labelTop)

Ajax 的操作流程

![img](%E7%82%B9%E9%A4%90%E9%A1%B9%E7%9B%AE%E5%AE%9E%E6%88%98%E4%B9%8B%E5%90%8E%E5%8F%B0%E7%AE%A1%E7%90%86%E5%BC%80%E5%8F%91%E2%80%94%E2%80%94%E6%80%BB%E7%BB%93.assets/2639438-20221219185818053-323651631.png)

[返回目录](https://www.cnblogs.com/chen-ao666/p/16993245.html#_labelTop)

具体操作流程：

- 首先通过PHP页面将数据库中的数据取出
- 取出后转成json格式的字符串，后利用ajax把字符串返还给前台
- 再利用json.parse解析通过循环添加到页面上
- 那么反之，前端的数据可以利用ajax提交到后台
- 但是后台是没有办法直接把这些数据插入到数据库中，所以要先提交到PHP页面上
- 最后再由PHP将数据插入到数据库中

[返回目录](https://www.cnblogs.com/chen-ao666/p/16993245.html#_labelTop)

基本语法

[![复制代码](%E7%82%B9%E9%A4%90%E9%A1%B9%E7%9B%AE%E5%AE%9E%E6%88%98%E4%B9%8B%E5%90%8E%E5%8F%B0%E7%AE%A1%E7%90%86%E5%BC%80%E5%8F%91%E2%80%94%E2%80%94%E6%80%BB%E7%BB%93.assets/copycode.gif)](javascript:void(0);)

```
$('#subBtn').click(function (){
        //发送ajax请求
        $.ajax({
            url:'',    //后端地址，三种填写方式，与form标签的action一致
            type:'post',    //请求方式，默认也是get
            data:{'v1':$('#d1').val(),'v2':$('#d2').val()},    //获取两个框里面的数据
            success:function (args){     //后端返回结果之后自动触发,args接收后端返回的数据
                $('#d3').val(args)
            }

        })
    })
```

[![复制代码](%E7%82%B9%E9%A4%90%E9%A1%B9%E7%9B%AE%E5%AE%9E%E6%88%98%E4%B9%8B%E5%90%8E%E5%8F%B0%E7%AE%A1%E7%90%86%E5%BC%80%E5%8F%91%E2%80%94%E2%80%94%E6%80%BB%E7%BB%93.assets/copycode.gif)](javascript:void(0);)

[返回目录](https://www.cnblogs.com/chen-ao666/p/16993245.html#_labelTop)

示例：

 \# 路由层 urls.py 文件

```
from app01 import views
urlpatterns = [
    path('admin/', admin.site.urls),
    path('ab_ajax/',views.ab_ajax_func)
```

 \# 视图层 views.py 文件

[![复制代码](%E7%82%B9%E9%A4%90%E9%A1%B9%E7%9B%AE%E5%AE%9E%E6%88%98%E4%B9%8B%E5%90%8E%E5%8F%B0%E7%AE%A1%E7%90%86%E5%BC%80%E5%8F%91%E2%80%94%E2%80%94%E6%80%BB%E7%BB%93.assets/copycode.gif)](javascript:void(0);)

```
from django.shortcuts import render, HttpResponse


def ab_ajax_func(request):
    if request.method == 'POST':
        print(request.POST)
        v1 = request.POST.get('v1')
        v2 = request.POST.get('v2')
        res = int(v1) + int(v2)
        return HttpResponse(res)
    return render(request, 'abAjaxPage.html')
```

[![复制代码](%E7%82%B9%E9%A4%90%E9%A1%B9%E7%9B%AE%E5%AE%9E%E6%88%98%E4%B9%8B%E5%90%8E%E5%8F%B0%E7%AE%A1%E7%90%86%E5%BC%80%E5%8F%91%E2%80%94%E2%80%94%E6%80%BB%E7%BB%93.assets/copycode.gif)](javascript:void(0);)

 \# 模板层 abAjaxPage.html 文件

[![复制代码](%E7%82%B9%E9%A4%90%E9%A1%B9%E7%9B%AE%E5%AE%9E%E6%88%98%E4%B9%8B%E5%90%8E%E5%8F%B0%E7%AE%A1%E7%90%86%E5%BC%80%E5%8F%91%E2%80%94%E2%80%94%E6%80%BB%E7%BB%93.assets/copycode.gif)](javascript:void(0);)

```
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Title</title>
    <script src="https://cdn.bootcdn.net/ajax/libs/jquery/3.6.1/jquery.js"></script>
</head>
<body>
<input type="text" id="d1"> + <input type="text" id="d2"> = <input type="text" id="d3">
<button id="subBtn">计算</button>


<script>
    //给按键绑定点击事件
    $('#subBtn').click(function (){
        //发送ajax请求
        $.ajax({
            url:'',    //后端地址，三种填写方式，与form标签的action一致
            type:'post',    //请求方式，默认也是get
            data:{'v1':$('#d1').val(),'v2':$('#d2').val()},    //获取两个框里面的数据
            success:function (args){     //后端返回结果之后自动触发,args接收后端返回的数据
                $('#d3').val(args)
            }

        })
    })
</script>
</body>
</html>
```

[![复制代码](%E7%82%B9%E9%A4%90%E9%A1%B9%E7%9B%AE%E5%AE%9E%E6%88%98%E4%B9%8B%E5%90%8E%E5%8F%B0%E7%AE%A1%E7%90%86%E5%BC%80%E5%8F%91%E2%80%94%E2%80%94%E6%80%BB%E7%BB%93.assets/copycode.gif)](javascript:void(0);)

![img](%E7%82%B9%E9%A4%90%E9%A1%B9%E7%9B%AE%E5%AE%9E%E6%88%98%E4%B9%8B%E5%90%8E%E5%8F%B0%E7%AE%A1%E7%90%86%E5%BC%80%E5%8F%91%E2%80%94%E2%80%94%E6%80%BB%E7%BB%93.assets/2639438-20221219220843621-1736423916.png)

[返回目录](https://www.cnblogs.com/chen-ao666/p/16993245.html#_labelTop)

前后端数据传输的编码格式

[返回目录](https://www.cnblogs.com/chen-ao666/p/16993245.html#_labelTop)

1.前端可以向后端发起post请求的方式

- form 表单
- ajax 请求

[返回目录](https://www.cnblogs.com/chen-ao666/p/16993245.html#_labelTop)

2.基于post请求, 前后端数据传输的主流编码格式有三种

- urlencoded : 默认的编码格式, 提交的数据从request.POST中提取
- form-data : 上传文件时使用的编码格式, 提交的数据从request.POST中提取, 上传的文件从request.FILES中提取
- **json :** ajax发送的json格式数据, 在request.POST中取不到数据, 需要在request.body中提取数据

[返回目录](https://www.cnblogs.com/chen-ao666/p/16993245.html#_labelTop)

3.基于post请求, form表单传输数据默认的编码格式

- 默认编码格式为 : urlencoded
- 如果要上传文件需要在标签中指定 : enctype="multipart/form-data" 编码格式
- 数据格式 : username=alex&password=123
- 提交位置 : django后端针对符合urlencoded编码格式的数据都会自动帮你解析封装到request.POST中, 文件提交到request.FILES中

[返回目录](https://www.cnblogs.com/chen-ao666/p/16993245.html#_labelTop)

4.基于post请求, ajax传输数据默认编码格式

- 默认编码格式 : urlencoded
- 如果要上传文件需要使用 Formdata 对象
- 数据格式 : username=alex&password=123
- 提交位置 : django后端会自动帮你解析封装到request.POST中, 文件提交到request.FILES中

[返回目录](https://www.cnblogs.com/chen-ao666/p/16993245.html#_labelTop)

5.json.loads( )是否可以转Bytes格式

- 3.5之前不行, 需要我们手动将 Bytes 格式转成 str 类型, 然后再进行转换
- 3.6以后可以, Bytes无需手动转 str 类型, 它内部会自动帮你转成 str, 再转成 json
- 查看 json.loads( ) 的源码可以得到验证 :

![img](%E7%82%B9%E9%A4%90%E9%A1%B9%E7%9B%AE%E5%AE%9E%E6%88%98%E4%B9%8B%E5%90%8E%E5%8F%B0%E7%AE%A1%E7%90%86%E5%BC%80%E5%8F%91%E2%80%94%E2%80%94%E6%80%BB%E7%BB%93.assets/2639438-20221219205405670-1059116387.png)

 

 

[返回目录](https://www.cnblogs.com/chen-ao666/p/16993245.html#_labelTop)

 Ajax发送数据

[返回目录](https://www.cnblogs.com/chen-ao666/p/16993245.html#_labelTop)

Ajax发送json格式数据

 \# 模板层：

[![复制代码](%E7%82%B9%E9%A4%90%E9%A1%B9%E7%9B%AE%E5%AE%9E%E6%88%98%E4%B9%8B%E5%90%8E%E5%8F%B0%E7%AE%A1%E7%90%86%E5%BC%80%E5%8F%91%E2%80%94%E2%80%94%E6%80%BB%E7%BB%93.assets/copycode.gif)](javascript:void(0);)

```
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Title</title>
    <script src="https://cdn.bootcdn.net/ajax/libs/jquery/3.6.1/jquery.js"></script>
</head>
<body>
<button id="d1">发送json格式数据</button>
<script>
    $('#d1').click(function (){
        $.ajax({
            url:'',
            type:'post',
            data:JSON.stringify({'name':'alex','age':18}),    # 告诉后端发送的是json格式数据
            contentType:'application/json',  //指定字符编码格式
            success:function (args){
                alert(args)
            }
        })
    })
</script>
</body>
</html>
```

[![复制代码](%E7%82%B9%E9%A4%90%E9%A1%B9%E7%9B%AE%E5%AE%9E%E6%88%98%E4%B9%8B%E5%90%8E%E5%8F%B0%E7%AE%A1%E7%90%86%E5%BC%80%E5%8F%91%E2%80%94%E2%80%94%E6%80%BB%E7%BB%93.assets/copycode.gif)](javascript:void(0);)

后端拿到二进制格式的JSON格式字符串。Django针对json格式数据后端需要手动处理。

[返回目录](https://www.cnblogs.com/chen-ao666/p/16993245.html#_labelTop)

后端如何处理json格式字符串

\# 视图层：

[![复制代码](%E7%82%B9%E9%A4%90%E9%A1%B9%E7%9B%AE%E5%AE%9E%E6%88%98%E4%B9%8B%E5%90%8E%E5%8F%B0%E7%AE%A1%E7%90%86%E5%BC%80%E5%8F%91%E2%80%94%E2%80%94%E6%80%BB%E7%BB%93.assets/copycode.gif)](javascript:void(0);)

```
from django.shortcuts import render 

def ab_ajax_func(request):
    if request.method == 'POST':
        print(request.POST)    # <QueryDict: {}>
        print(request.FILES)    # <MultiValueDict: {}>
        print(request.body)    # b'{"name":"alex","age":18}'
        import json
        res = json.loads(request.body)   # json.loads（）自带解码功能
        print(res,type(res))    # {'name': 'alex', 'age': 18} <class 'dict'>
        request.JSON =res    # 也可以将处理好的数据自己进行封装
        print(request.JSON)    # {'name': 'alex', 'age': 18}
    return render(request, 'abAjaxPage.html')
```

[![复制代码](%E7%82%B9%E9%A4%90%E9%A1%B9%E7%9B%AE%E5%AE%9E%E6%88%98%E4%B9%8B%E5%90%8E%E5%8F%B0%E7%AE%A1%E7%90%86%E5%BC%80%E5%8F%91%E2%80%94%E2%80%94%E6%80%BB%E7%BB%93.assets/copycode.gif)](javascript:void(0);)

[返回目录](https://www.cnblogs.com/chen-ao666/p/16993245.html#_labelTop)

ajax发送json格式数据需要注意的点：

- contentType 参数 指定成 : application/json
- 数据必须是真正的json格式数据
- Django后端不会处理json格式数据，需要到request.body获取并处理

[返回目录](https://www.cnblogs.com/chen-ao666/p/16993245.html#_labelTop)

Ajax发送文件数据

 \# 模板层：

[![复制代码](%E7%82%B9%E9%A4%90%E9%A1%B9%E7%9B%AE%E5%AE%9E%E6%88%98%E4%B9%8B%E5%90%8E%E5%8F%B0%E7%AE%A1%E7%90%86%E5%BC%80%E5%8F%91%E2%80%94%E2%80%94%E6%80%BB%E7%BB%93.assets/copycode.gif)](javascript:void(0);)

```
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Title</title>
    <script src="https://cdn.bootcdn.net/ajax/libs/jquery/3.6.1/jquery.js"></script>
</head>
<body>

<input type="file" id="d2">
<button id="d3">发送文件数据</button>
<script>
    $('#d3').click(function (){
        //1.先产生一个FormData对象
        let myFormDataObj = new FormData();
        //2.往该对象中添加普通数据
        myFormDataObj.append('name','alex');
        myFormDataObj.append('age',18);
        //3.往该对象中添加文件数据，$('#d2')取索引0，转为原生jQuery对象即原生标签对象，再用files[0]就获得用户传的文件对象
        myFormDataObj.append('file',$('#d2')[0].files[0])
        //4.发送ajax请求
        $.ajax({
            url:'',
            type:'post',
            data:myFormDataObj,
            //ajax发送文件数据固定的两个配制
　　　　　　　contentType:false,    //告诉浏览器不需要带任何编码，Django后端能够自动识别formdata对象，
            processData: false,  //告诉浏览器，不要对数据进行任何处理，原封不动发送到后端。
```

　　   success:function (args){

 

```
                alert(args)
            }
        })
    })
</script>

</body>
</html>
```

[![复制代码](%E7%82%B9%E9%A4%90%E9%A1%B9%E7%9B%AE%E5%AE%9E%E6%88%98%E4%B9%8B%E5%90%8E%E5%8F%B0%E7%AE%A1%E7%90%86%E5%BC%80%E5%8F%91%E2%80%94%E2%80%94%E6%80%BB%E7%BB%93.assets/copycode.gif)](javascript:void(0);)

 \# 视图层：

[![复制代码](%E7%82%B9%E9%A4%90%E9%A1%B9%E7%9B%AE%E5%AE%9E%E6%88%98%E4%B9%8B%E5%90%8E%E5%8F%B0%E7%AE%A1%E7%90%86%E5%BC%80%E5%8F%91%E2%80%94%E2%80%94%E6%80%BB%E7%BB%93.assets/copycode.gif)](javascript:void(0);)

```
from django.shortcuts import render

def ab_ajax_func(request):
    if request.method == 'POST':
        print(request.POST)    # QueryDict: {'name': ['alex'], 'age': ['18']}>
        print(request.FILES)    # <MultiValueDict: {'file': [<InMemoryUploadedFile: 试卷.pdf (application/pdf)>]}>
    return render(request, 'abAjaxPage.html')
```

[![复制代码](%E7%82%B9%E9%A4%90%E9%A1%B9%E7%9B%AE%E5%AE%9E%E6%88%98%E4%B9%8B%E5%90%8E%E5%8F%B0%E7%AE%A1%E7%90%86%E5%BC%80%E5%8F%91%E2%80%94%E2%80%94%E6%80%BB%E7%BB%93.assets/copycode.gif)](javascript:void(0);)

![img](%E7%82%B9%E9%A4%90%E9%A1%B9%E7%9B%AE%E5%AE%9E%E6%88%98%E4%B9%8B%E5%90%8E%E5%8F%B0%E7%AE%A1%E7%90%86%E5%BC%80%E5%8F%91%E2%80%94%E2%80%94%E6%80%BB%E7%BB%93.assets/2639438-20221219220641412-982240343.png)

[返回目录](https://www.cnblogs.com/chen-ao666/p/16993245.html#_labelTop)

Ajax发送文件需要注意的点：

-  需要利用内置对象FormData，普通键值对和文件都能发送

```
obj.append('name','alex');

obj.append('password',$('#pwd').val());

obj.append('file',$('#d2')[0].files[0])
```

- 需要指定两个关键性的参数

```
1 contentType: false
2 processData: false
```

- Django后端能够直接识别formdata对象，并且能够将内部的普通键值对自动解析并封装到你request.POST中，文件数据对象自动解析并封装到reuqest.FILES中

[返回目录](https://www.cnblogs.com/chen-ao666/p/16993245.html#_labelTop)

Ajax补充说明

```
1. 后端request.is_ajax()
　　用于判断当前请求是否由ajax发出

2. 后端返回的三板斧都会被args接收，不再影响整个浏览器页面

3. 选择使用ajax做前后端交互的时候，后端一般返回的都是字典数据
```

 

[返回目录](https://www.cnblogs.com/chen-ao666/p/16993245.html#_labelTop)

字典数据前后端交互的几种方式

[返回目录](https://www.cnblogs.com/chen-ao666/p/16993245.html#_labelTop)

 1. 直接发送

 \# 视图层：

[![复制代码](%E7%82%B9%E9%A4%90%E9%A1%B9%E7%9B%AE%E5%AE%9E%E6%88%98%E4%B9%8B%E5%90%8E%E5%8F%B0%E7%AE%A1%E7%90%86%E5%BC%80%E5%8F%91%E2%80%94%E2%80%94%E6%80%BB%E7%BB%93.assets/copycode.gif)](javascript:void(0);)

```
from django.shortcuts import render, HttpResponse


def ab_ajax_func(request):
    if request.method == 'POST':
        user_dict = {'username': 'alex', 'hobby': 'reading'}
        return HttpResponse(request, user_dict)    # 将字典直接的发送给前端
    
    return render(request, 'AjaxPage.html')
```

[![复制代码](%E7%82%B9%E9%A4%90%E9%A1%B9%E7%9B%AE%E5%AE%9E%E6%88%98%E4%B9%8B%E5%90%8E%E5%8F%B0%E7%AE%A1%E7%90%86%E5%BC%80%E5%8F%91%E2%80%94%E2%80%94%E6%80%BB%E7%BB%93.assets/copycode.gif)](javascript:void(0);)

 \# 模板层：

[![复制代码](%E7%82%B9%E9%A4%90%E9%A1%B9%E7%9B%AE%E5%AE%9E%E6%88%98%E4%B9%8B%E5%90%8E%E5%8F%B0%E7%AE%A1%E7%90%86%E5%BC%80%E5%8F%91%E2%80%94%E2%80%94%E6%80%BB%E7%BB%93.assets/copycode.gif)](javascript:void(0);)

```
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Title</title>
    <script src="https://cdn.bootcdn.net/ajax/libs/jquery/3.6.1/jquery.js"></script>
</head>
<body>
<button id="d1">发送ajax请求</button>
<script>
    $('#d1').click(function (){
        $.ajax({
            url:'',
            type:'post',
            data:{'name':'alex'},
            success:function (args){
                console.log(args);
                console.log(typeof args)
            }
        })

    })
```

[![复制代码](%E7%82%B9%E9%A4%90%E9%A1%B9%E7%9B%AE%E5%AE%9E%E6%88%98%E4%B9%8B%E5%90%8E%E5%8F%B0%E7%AE%A1%E7%90%86%E5%BC%80%E5%8F%91%E2%80%94%E2%80%94%E6%80%BB%E7%BB%93.assets/copycode.gif)](javascript:void(0);)

![img](%E7%82%B9%E9%A4%90%E9%A1%B9%E7%9B%AE%E5%AE%9E%E6%88%98%E4%B9%8B%E5%90%8E%E5%8F%B0%E7%AE%A1%E7%90%86%E5%BC%80%E5%8F%91%E2%80%94%E2%80%94%E6%80%BB%E7%BB%93.assets/2639438-20221220155931529-1061515213.png)

[返回目录](https://www.cnblogs.com/chen-ao666/p/16993245.html#_labelTop)

2. 后端先转成json格式，再发送给前端

 \# 视图层：

[![复制代码](%E7%82%B9%E9%A4%90%E9%A1%B9%E7%9B%AE%E5%AE%9E%E6%88%98%E4%B9%8B%E5%90%8E%E5%8F%B0%E7%AE%A1%E7%90%86%E5%BC%80%E5%8F%91%E2%80%94%E2%80%94%E6%80%BB%E7%BB%93.assets/copycode.gif)](javascript:void(0);)

```
from django.shortcuts import render, HttpResponse


def ab_ajax_func(request):
    if request.method == 'POST':
        user_dict = {'username': 'alex', 'hobby': 'reading'}
        import json
        user_data = json.dumps(user_dict)    # 将字典转成jaon格式
        return HttpResponse(user_data)
    return render(request, 'AjaxPage.html')
```

[![复制代码](%E7%82%B9%E9%A4%90%E9%A1%B9%E7%9B%AE%E5%AE%9E%E6%88%98%E4%B9%8B%E5%90%8E%E5%8F%B0%E7%AE%A1%E7%90%86%E5%BC%80%E5%8F%91%E2%80%94%E2%80%94%E6%80%BB%E7%BB%93.assets/copycode.gif)](javascript:void(0);)

 \# 模板层：

[![复制代码](%E7%82%B9%E9%A4%90%E9%A1%B9%E7%9B%AE%E5%AE%9E%E6%88%98%E4%B9%8B%E5%90%8E%E5%8F%B0%E7%AE%A1%E7%90%86%E5%BC%80%E5%8F%91%E2%80%94%E2%80%94%E6%80%BB%E7%BB%93.assets/copycode.gif)](javascript:void(0);)

```
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Title</title>
    <script src="https://cdn.bootcdn.net/ajax/libs/jquery/3.6.1/jquery.js"></script>
</head>
<body>
<button id="d1">发送ajax请求</button>
<script>
    $('#d1').click(function (){
        $.ajax({
            url:'',
            type:'post',
            data:{'name':'alex'},
            success:function (args){
                console.log(args)
                console.log(typeof args)
            }
        })

    })
```

[![复制代码](%E7%82%B9%E9%A4%90%E9%A1%B9%E7%9B%AE%E5%AE%9E%E6%88%98%E4%B9%8B%E5%90%8E%E5%8F%B0%E7%AE%A1%E7%90%86%E5%BC%80%E5%8F%91%E2%80%94%E2%80%94%E6%80%BB%E7%BB%93.assets/copycode.gif)](javascript:void(0);)

**结果：**

![img](%E7%82%B9%E9%A4%90%E9%A1%B9%E7%9B%AE%E5%AE%9E%E6%88%98%E4%B9%8B%E5%90%8E%E5%8F%B0%E7%AE%A1%E7%90%86%E5%BC%80%E5%8F%91%E2%80%94%E2%80%94%E6%80%BB%E7%BB%93.assets/2639438-20221220161113992-129302269.png)

 

 上述处理结果发现，返回的是json格式的字符串类型，在前端还是没有办法通过点的方式来取值，所以还需要在前端加上一步操作：

[返回目录](https://www.cnblogs.com/chen-ao666/p/16993245.html#_labelTop)

3. JOSN.parse()反序列化

\# 视图层：

[![复制代码](%E7%82%B9%E9%A4%90%E9%A1%B9%E7%9B%AE%E5%AE%9E%E6%88%98%E4%B9%8B%E5%90%8E%E5%8F%B0%E7%AE%A1%E7%90%86%E5%BC%80%E5%8F%91%E2%80%94%E2%80%94%E6%80%BB%E7%BB%93.assets/copycode.gif)](javascript:void(0);)

```
from django.shortcuts import render, HttpResponse


def ab_ajax_func(request):
    if request.method == 'POST':
        user_dict = {'username': 'alex', 'hobby': 'reading'}
        import json
        user_data = json.dumps(user_dict)    # 将字典转成jaon格式
        return HttpResponse(user_data)
    return render(request, 'AjaxPage.html')
```

[![复制代码](%E7%82%B9%E9%A4%90%E9%A1%B9%E7%9B%AE%E5%AE%9E%E6%88%98%E4%B9%8B%E5%90%8E%E5%8F%B0%E7%AE%A1%E7%90%86%E5%BC%80%E5%8F%91%E2%80%94%E2%80%94%E6%80%BB%E7%BB%93.assets/copycode.gif)](javascript:void(0);)

 \# 模板层：

[![复制代码](%E7%82%B9%E9%A4%90%E9%A1%B9%E7%9B%AE%E5%AE%9E%E6%88%98%E4%B9%8B%E5%90%8E%E5%8F%B0%E7%AE%A1%E7%90%86%E5%BC%80%E5%8F%91%E2%80%94%E2%80%94%E6%80%BB%E7%BB%93.assets/copycode.gif)](javascript:void(0);)

```
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Title</title>
    <script src="https://cdn.bootcdn.net/ajax/libs/jquery/3.6.1/jquery.js"></script>
</head>
<body>
<button id="d1">发送ajax请求</button>
<script>
    $('#d1').click(function (){
        $.ajax({
            url:'',
            type:'post',
            data:{'name':'alex'},
            success:function (args){
                let userObj = JSON.parse(args);
                console.log(userObj);
                console.log(typeof userObj)
                console.log(userObj.username)
            }
        })

    })
</script>
</body>
</html>
```

[![复制代码](%E7%82%B9%E9%A4%90%E9%A1%B9%E7%9B%AE%E5%AE%9E%E6%88%98%E4%B9%8B%E5%90%8E%E5%8F%B0%E7%AE%A1%E7%90%86%E5%BC%80%E5%8F%91%E2%80%94%E2%80%94%E6%80%BB%E7%BB%93.assets/copycode.gif)](javascript:void(0);)

![img](%E7%82%B9%E9%A4%90%E9%A1%B9%E7%9B%AE%E5%AE%9E%E6%88%98%E4%B9%8B%E5%90%8E%E5%8F%B0%E7%AE%A1%E7%90%86%E5%BC%80%E5%8F%91%E2%80%94%E2%80%94%E6%80%BB%E7%BB%93.assets/2639438-20221220161822202-1725773547.png)

[返回目录](https://www.cnblogs.com/chen-ao666/p/16993245.html#_labelTop)

4. dataType:'json'

ajax自动反序列化后端的json格式的bytes类型数据

 \# 视图层：

[![复制代码](%E7%82%B9%E9%A4%90%E9%A1%B9%E7%9B%AE%E5%AE%9E%E6%88%98%E4%B9%8B%E5%90%8E%E5%8F%B0%E7%AE%A1%E7%90%86%E5%BC%80%E5%8F%91%E2%80%94%E2%80%94%E6%80%BB%E7%BB%93.assets/copycode.gif)](javascript:void(0);)

```
from django.shortcuts import render, HttpResponse


def ab_ajax_func(request):
    if request.method == 'POST':
        user_dict = {'username': 'alex', 'hobby': 'reading'}
        import json
        user_data = json.dumps(user_dict)    # 将字典转成jaon格式
        return HttpResponse(user_data)
    return render(request, 'AjaxPage.html')
```

[![复制代码](%E7%82%B9%E9%A4%90%E9%A1%B9%E7%9B%AE%E5%AE%9E%E6%88%98%E4%B9%8B%E5%90%8E%E5%8F%B0%E7%AE%A1%E7%90%86%E5%BC%80%E5%8F%91%E2%80%94%E2%80%94%E6%80%BB%E7%BB%93.assets/copycode.gif)](javascript:void(0);)

 

 \# 模板层：

[![复制代码](%E7%82%B9%E9%A4%90%E9%A1%B9%E7%9B%AE%E5%AE%9E%E6%88%98%E4%B9%8B%E5%90%8E%E5%8F%B0%E7%AE%A1%E7%90%86%E5%BC%80%E5%8F%91%E2%80%94%E2%80%94%E6%80%BB%E7%BB%93.assets/copycode.gif)](javascript:void(0);)

```
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Title</title>
    <script src="https://cdn.bootcdn.net/ajax/libs/jquery/3.6.1/jquery.js"></script>
</head>
<body>
<button id="d1">发送ajax请求</button>
<script>
    $('#d1').click(function (){
        $.ajax({
            url:'',
            type:'post',
            data:{'name':'alex'},
            dataType:'json',      {# 告诉前端发送过来的为json格式字符串 #}
            success:function (args){
                console.log(args);
                console.log(typeof args)
                console.log(args.username)
            }
        })

    })
</script>
</body>
</html>
```

[![复制代码](%E7%82%B9%E9%A4%90%E9%A1%B9%E7%9B%AE%E5%AE%9E%E6%88%98%E4%B9%8B%E5%90%8E%E5%8F%B0%E7%AE%A1%E7%90%86%E5%BC%80%E5%8F%91%E2%80%94%E2%80%94%E6%80%BB%E7%BB%93.assets/copycode.gif)](javascript:void(0);)

**结果：**

![img](%E7%82%B9%E9%A4%90%E9%A1%B9%E7%9B%AE%E5%AE%9E%E6%88%98%E4%B9%8B%E5%90%8E%E5%8F%B0%E7%AE%A1%E7%90%86%E5%BC%80%E5%8F%91%E2%80%94%E2%80%94%E6%80%BB%E7%BB%93.assets/2639438-20221220163626905-2118893189.png)

 但是3、4两种操作在前后端都需要进行处理，太过麻烦，有没有简单一点的方法呢？

[返回目录](https://www.cnblogs.com/chen-ao666/p/16993245.html#_labelTop)

5. 后端通过JsonResponse处理

 \# 视图层：

[![复制代码](%E7%82%B9%E9%A4%90%E9%A1%B9%E7%9B%AE%E5%AE%9E%E6%88%98%E4%B9%8B%E5%90%8E%E5%8F%B0%E7%AE%A1%E7%90%86%E5%BC%80%E5%8F%91%E2%80%94%E2%80%94%E6%80%BB%E7%BB%93.assets/copycode.gif)](javascript:void(0);)

```
from django.shortcuts import render, HttpResponse

def ab_ajax_func(request):
    if request.method == 'POST':
        user_dict = {'username': 'alex', 'hobby': 'reading'}
        from django.http import JsonResponse
        return JsonResponse(user_dict)

    return render(request, 'AjaxPage.html')
```

[![复制代码](%E7%82%B9%E9%A4%90%E9%A1%B9%E7%9B%AE%E5%AE%9E%E6%88%98%E4%B9%8B%E5%90%8E%E5%8F%B0%E7%AE%A1%E7%90%86%E5%BC%80%E5%8F%91%E2%80%94%E2%80%94%E6%80%BB%E7%BB%93.assets/copycode.gif)](javascript:void(0);)

 \# 模板层：

[![复制代码](%E7%82%B9%E9%A4%90%E9%A1%B9%E7%9B%AE%E5%AE%9E%E6%88%98%E4%B9%8B%E5%90%8E%E5%8F%B0%E7%AE%A1%E7%90%86%E5%BC%80%E5%8F%91%E2%80%94%E2%80%94%E6%80%BB%E7%BB%93.assets/copycode.gif)](javascript:void(0);)

```
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Title</title>
    <script src="https://cdn.bootcdn.net/ajax/libs/jquery/3.6.1/jquery.js"></script>
</head>
<body>
<button id="d1">发送ajax请求</button>
<script>
    $('#d1').click(function (){
        $.ajax({
            url:'',
            type:'post',
            data:{'name':'alex'},
            success:function (args){
                console.log(args);
                console.log(typeof args)
                console.log(args.username)
            }
        })

    })
</script>
</body>
</html>
```

[![复制代码](%E7%82%B9%E9%A4%90%E9%A1%B9%E7%9B%AE%E5%AE%9E%E6%88%98%E4%B9%8B%E5%90%8E%E5%8F%B0%E7%AE%A1%E7%90%86%E5%BC%80%E5%8F%91%E2%80%94%E2%80%94%E6%80%BB%E7%BB%93.assets/copycode.gif)](javascript:void(0);)

**结果：**

![img](%E7%82%B9%E9%A4%90%E9%A1%B9%E7%9B%AE%E5%AE%9E%E6%88%98%E4%B9%8B%E5%90%8E%E5%8F%B0%E7%AE%A1%E7%90%86%E5%BC%80%E5%8F%91%E2%80%94%E2%80%94%E6%80%BB%E7%BB%93.assets/2639438-20221220162311425-1632041097.png)

 











## 3、urls路由设置

Python

一个`干净优雅`的`URL方案`是`高质量Web应用`程序中的一个`重要细节`。

```python
##示例子
# myobject/myobject/urls.py

#from django.contrib import admin
from django.urls import include,path

urlpatterns = [
    #path('admin/', admin.site.urls),
    path('', include("web.urls")),                # 默认前台大堂点餐端
    path('myadmin/', include("myadmin.urls")),     # 后台管理端
    path('mobile/', include("mobile.urls")),    # 移动会员端
]

# myobject/web/urls.py

from django.urls import path

from web.views import index

urlpatterns = [
   # path('', index.index, name="index"),
]


urlpatterns = [
    path('articles/2003/', views.special_case_2003),
    path('articles/<int:year>/', views.year_archive),
    path('articles/<int:year>/<int:month>/', views.month_archive),
 path('articles/<int:year>/<int:month>/<slug:slug>/', views.article_detail),

- **要从URL捕获一个值，请使用尖括号括起来**。
- 捕获的值可以选择包括转换器类型。例如，用于 `<int:name>`捕获整数参数。如果不包括转换器`/`，则匹配除字符以外的任何字符串。
- 无需添加斜杠，因为每个URL都有该斜杠。例如`articles`，不是/`articles`。
示例请求：

- /articles/2005/03/将匹配列表中的第三个条目。Django会调用该函数 。views.month_archive(request, '2005', '03')
- /articles/2005/3/ 不符合任何网址格式，因为列表中的第三个条目需要两个数字的月份。
- /articles/2003/将匹配列表中的第一个模式，而不是第二个模式，因为模式是按顺序测试的，第一个模式是第一个测试通过。随意利用这些命令插入特殊情况。在这里，Django会调用该函数 views.special_case_2003(request)
- /articles/2003 将不匹配任何这些模式，因为每个模式要求URL以斜杠结尾。
- /articles/2003/03/03/将匹配最终模式。Django会调用该函数。views.article_detail(request, '2003', '03', '03')

#### 路径转换器

- 默认情况下，以下路径转换器可用：
  - `str`-匹配任何非空字符串，但路径分隔符除外'/'。如果表达式中不包含转换器，则为默认设置。
  - `int`-匹配零或任何正整数。返回一个int。
  - `slug`-匹配由ASCII字母或数字以及连字符和下划线字符组成的任何条形字符串。例如， building-your-1st-django-site。
  - `uuid`-匹配格式化的UUID。为防止多个URL映射到同一页面，必须包含破折号并且字母必须小写。例如，075194d3-6885-417e-a8a8-6c931e272f00。返回一个 UUID实例。
  - `path`-匹配任何非空字符串，包括路径分隔符 '/'。这样，您就可以匹配完整的URL路径，而不是像一样匹配URL路径的一部分str。
    
  使用正则表达式:  
    - 如果路径和转换器语法不足以定义URL模式，则还可以使用正则表达式。为此，请使用`re_path()`代替`path()`。
- 在Python正则表达式中，命名正则表达式组的语法为`(?P<name>pattern)`,其中`name`是组的名称，并且 pattern是匹配的某种模式。
- 这是前面的示例URLconf，使用正则表达式重写：
    
    from django.urls import path, re_path

from . import views

urlpatterns = [
    path('articles/2003/', views.special_case_2003),
    re_path(r'^articles/(?P<year>[0-9]{4})/$', views.year_archive),
    re_path(r'^articles/(?P<year>[0-9]{4})/(?P<month>[0-9]{2})/$', views.month_archive),
    re_path(r'^articles/(?P<year>[0-9]{4})/(?P<month>[0-9]{2})/(?P<slug>[\w-]+)/$', views.article_detail),
]
    
    
    
 为视图参数指定默认值   
    # URLconf
from django.urls import path

from . import views

urlpatterns = [
    path('blog/', views.page),
    path('blog/page<int:num>/', views.page),
]

# View (in blog/views.py)
def page(request, num=1):
    # Output the appropriate page of blog entries, according to num.
    
    
(5). URL的反向解析
    
    from django.urls import path

from . import views

urlpatterns = [
    #...
    path('articles/<int:year>/', views.year_archive, name='news-year-archive'),
    #...
]
    
    <a href="{ %   url 'news-year-archive' 2020   % }">2020 Archive</a>
{# Or with the year in a template context variable: #}
<ul>
    {% for yearvar in year_list %}
        <li><a href="{% url 'news-year-archive' yearvar %}">{{ yearvar }} Archive</a></li>
    {% endfor %}
</ul>
    
    from django.http import HttpResponseRedirect
from django.urls import reverse

def redirect_to_year(request):
    # ...
    year = 2019
    # ...
    return HttpResponseRedirect(reverse('news-year-archive', args=(year,)))
    
    
    from django.shortcuts import redirect
from django.urls import reverse

def index(request):
    year = 2019
    return redirect(reverse('ews-year-archive',args=(year,)))
```



















