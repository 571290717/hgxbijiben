个人总结



[TOC]





## 一、基础功能介绍

### Django框架介绍与安装

```
二个字,框架就是程序的骨架
pip install django==2.2.*
python -m django --version

```

### Django的快速入门

```python
django-admin startproject myweb   创建项目
 python manage.py runserver 0.0.0.0:8000   运行
 python manage.py startapp myapp	创建一个应用程序
 

```

###   写一个视图

```python
myapp/views.py 并放入以下Python代码：    写第一个视图
 
 from django.http import HttpResponse
 
 def index(request):
	return HttpResponse("Hello, world. You're at the myapp index.")
```

在myapp/urls.py文件中包含以下代码：

```python
from django.urls import path

from . import views

urlpatterns = [
    path('', views.index, name='index'),
]
```

下一步是将根URLconf指向myapp.urls模块。 在 myweb/urls.py添加一条import用于django.conf.urls.include和插入include()的urlpatterns列表，所以你必须：

```python
from django.contrib import admin
from django.urls import include,path

urlpatterns = [
    #path('admin/', admin.site.urls),
    path('myapp/', include('myapp.urls')),
]
```

**在浏览器中转到http://localhost:8000/myapp/，您应该看到文本"Hello, world. You're at the myapp index."**



### 项目的模型--（Model类） ----（这里开始后面再学一遍）

(1). 连接MySQL数据库设置



在myweb/settings.py文件中，通过DATABASES项进行数据库设置

```python
DATABASES = {
    'default': {
        'ENGINE': 'django.db.backends.mysql',
        'NAME': 'mydemo',
        'USER': 'root',
        'PASSWORD': '',
        'HOST': 'localhost',
        'PORT': '3306',
    }
}
```

```
  $ pip install  mysqlclient
  
```

(2). 创建模型

~~~python


在我们的简单的应用程序中，去创建一个stu表信息操作的Model类。

编辑 myapp/models.py文件

```python
from django.db import models

# Create your models here.

class Stu(models.Model):
    '''自定义Stu表对应的Model类'''
    #定义属性：默认主键自增id字段可不写
    id = models.AutoField(primary_key=True)
    name = models.CharField(max_length=16)
    age = models.SmallIntegerField()
    sex = models.CharField(max_length=1)
    classid=models.CharField(max_length=8)

    # 定义默认输出格式
    def __str__(self):
        return "%d:%s:%d:%s:%s"%(self.id,self.name,self.age,self.sex,self.classid)

    # 自定义对应的表名，默认表名：myapp_stu
    class Meta:
        db_table="stu"
~~~

(3). 激活模型

编辑myweb/settings.py文件，并将该虚线路径添加到该INSTALLED_APPS设置。

```python
INSTALLED_APPS  =  [ 
    'django.contrib.admin' ，
    'django.contrib.auth' ，
    'django.contrib.contenttypes' ，
    'django.contrib.sessions' ，
    'django.contrib.messages' ，
    'django.contrib.staticfiles' ，
    'myapp.apps.MyappConfig',  #或者直接写 myapp
]
```

(4). 使用（两种）

① 现在进入交互式的Python shell，并使用Django提供的免费API

```python
C:\Users\张涛\Desktop\code\myweb>python manage.py shell
Python 3.8.2 (tags/v3.8.2:7b3ab59, Feb 25 2020, 22:45:29) [MSC v.1916 32 bit (Intel)] on win32
Type "help", "copyright", "credits" or "license" for more information.
(InteractiveConsole)
>>> from myapp.models import Stu

>>> mod = Stu.objects
# 获取所有信息
>>> lists = mod.all()
>>> for v in lists:
...     print(v)
...
1:zhangsan:22:m:python03
2:lisi:25:w:python04
3:wangwu:20:m:python03
4:zhaoliu:19:w:python04
5:qq01:20:m:python03
6:qq02:21:w:python04
7:qq03:20:m:python05
8:uu01:21:w:python04
9:uu02:20:m:python05
10:aa:29:w:python03
11:bb:20:m:python04

# 获取单条信息
>>> mod.get(id=1)
<Stu: 1:zhangsan:22:m:python03>
>>> mod.get(id=2)
<Stu: 2:lisi:25:w:python04>
>>> mod.get(id=3)
<Stu: 3:wangwu:20:m:python03>

>>>
```

#### ② 在myapp应用的视图中使用

```python
# 文件：myapp/views.py 文件代码

from django.shortcuts import render
from django.http  import HttpResponse
from myapp.models import Stu
# Create your views here.

def index(request):
    return HttpResponse("Hello Django!")

def stu(request):
    #获取所有stu表信息
    lists = Stu.objects.all()
    print(lists)
    #获取单条学生信息
    print(Stu.objects.get(id=1))

    return HttpResponse("ok")
```

- 配置stu函数的访问路由

```python
#在myapp/urls.py文件中配置

path('stu/', views.stu),
```

启动服务后，在浏览器中访问,在命令行终端中查看输出效果: http://localhost:8000/myapp/stu

### 启用网站Admin管理

### （1）. 数据迁移

```python
python manage.py migrate
```

### (2). 创建管理员用户

首先，我们需要创建一个可以登录管理站点的用户。运行以下命令：

```
    $ python manage.py createsuperuser

    # 输入您所需的用户名，然后按Enter键。
    Username: admin

    # 然后将提示您输入所需的电子邮件地址：
    Email address: admin@example.com

    # 最后一步是输入你的密码（>=8位）。您将被要求输入密码两次，第二次作为第一次的确认
    Password: **********
    Password (again): *********
    Superuser created successfully.
```

### (2). 启动开发服务器

默认情况下，Django管理员站点被激活。让我们开始开发服务器并探索它。

启动开发服务器命令如下：

```
    $ python manage.py runserver
    或
    $ python manage.py runserver 0.0.0.0:8000
```

现在，打开一个Web浏览器，访问地址： http://127.0.0.1:8000/admin/

### (3). 设置时区和语言：

编辑myweb/settings.py配置文件：

```python
...

LANGUAGE_CODE = 'zh-hans'

TIME_ZONE = 'Asia/Shanghai'

...
```

### (4). 将我们自定义的应用程序的加入到后台管理

但我们的自定义应用程序在哪里？并没有显示在后台管理索引页面上。

要做到这一点，打开myapp/admin.py 文件，并编辑代码如下：

```python
from django.contrib import admin

from myapp.models import Stu

admin.site.register(Stu)
```

### (5). 更深入设计后台管理

```python
# 编辑myapp/models.py文件，在Stu类中添加如下信息，让后台管理显示中文字段。

class Stu(models.Model):
    '''自定义Stu表对应的Model类'''
    #定义属性：默认主键自增id字段可不写
    id = models.AutoField("学号",primary_key=True)
    name = models.CharField("姓名",max_length=16)
    age = models.SmallIntegerField("年龄")
    sex = models.CharField("性别",max_length=1)
    classid=models.CharField("班级",max_length=8)

    # 定义默认输出格式
    def __str__(self):
        return "%d:%s:%d:%s:%s"%(self.id,self.name,self.age,self.sex,self.classid)

    # 自定义对应的表名，默认表名：myapp_stu
    class Meta:
        db_table="stu"
        verbose_name = '浏览学生信息'  
        verbose_name_plural = '学生信息管理'
        
        
# 编辑myapp/admin.py 文件，实现信息管理的个性化定制

from django.contrib import admin

# Register your models here.
from myapp.models import Stu

#Stu模型的管理器(装饰器写法)
@admin.register(Stu)
class StuAdmin(admin.ModelAdmin):
    #listdisplay设置要显示在列表中的字段（id字段是Django模型的默认主键）
    list_display = ('id','name','age','sex','classid')

    #设置哪些字段可以点击进入编辑界面
    list_display_links = ('id','name')

    #list_per_page设置每页显示多少条记录，默认是100条
    list_per_page = 10

    #ordering设置默认排序字段，负号表示降序排序
    ordering = ('id',)  #-id降序

    #list_editable 设置默认可编辑字段
    #list_editable = ['age','sex','classid']

    #其他请详见手册文档说明
```

### path() 函数介绍

Django path() 可以接收四个参数，分别是两个必选参数：`route`、`view` 和两个可选参数：`kwargs`、`name`，接下来详细介绍这四个参数。

- ```
  route
  ```

  : 是包含URL模式的字符串。在处理请求时，Django从第一个模式开始，

  ```
        urlpatterns然后沿列表向下移动，将请求的URL与每个模式进行比较，直到找到匹配的URL。
  ```

- `view`: 用于执行与正则表达式匹配的 URL 请求。

- `kwargs`: 视图使用的字典类型的参数。

- `name`: 用来反向获取 URL。

### Django的URL路由（URL配置）

一个`干净优雅`的`URL方案`是`高质量Web应用`程序中的一个`重要细节`。



以下是一个URLconf示例：

```python
from django.urls import path

from . import views

urlpatterns = [
    path('articles/2003/', views.special_case_2003),
    path('articles/<int:year>/', views.year_archive),
    path('articles/<int:year>/<int:month>/', views.month_archive),
    path('articles/<int:year>/<int:month>/<slug:slug>/', views.article_detail),
]
```

说明：

> - **要从URL捕获一个值，请使用尖括号括起来**。
> - 捕获的值可以选择包括转换器类型。例如，用于 `<int:name>`捕获整数参数。如果不包括转换器`/`，则匹配除字符以外的任何字符串。
> - 无需添加斜杠，因为每个URL都有该斜杠。例如`articles`，不是/`articles`。

示例请求：

- /articles/2005/03/将匹配列表中的第三个条目。Django会调用该函数 。views.month_archive(request, '2005', '03')
- /articles/2005/3/ 不符合任何网址格式，因为列表中的第三个条目需要两个数字的月份。
- /articles/2003/将匹配列表中的第一个模式，而不是第二个模式，因为模式是按顺序测试的，第一个模式是第一个测试通过。随意利用这些命令插入特殊情况。在这里，Django会调用该函数 views.special_case_2003(request)
- /articles/2003 将不匹配任何这些模式，因为每个模式要求URL以斜杠结尾。
- /articles/2003/03/03/将匹配最终模式。Django会调用该函数。views.article_detail(request, '2003', '03', '03')

#### 路径转换器

- 默认情况下，以下路径转换器可用：
  - `str`-匹配任何非空字符串，但路径分隔符除外'/'。如果表达式中不包含转换器，则为默认设置。
  - `int`-匹配零或任何正整数。返回一个int。
  - `slug`-匹配由ASCII字母或数字以及连字符和下划线字符组成的任何条形字符串。例如， building-your-1st-django-site。
  - `uuid`-匹配格式化的UUID。为防止多个URL映射到同一页面，必须包含破折号并且字母必须小写。例如，075194d3-6885-417e-a8a8-6c931e272f00。返回一个 UUID实例。
  - `path`-匹配任何非空字符串，包括路径分隔符 '/'。这样，您就可以匹配完整的URL路径，而不是像一样匹配URL路径的一部分str。

#### 通过浏览器访问服务

> 注意：url路由，由上而下 进行匹配，如果在上面就匹配成功，则不会向下匹配

```
通过浏览器访问服务
    127.0.0.1:8000/abc ==>  root url(根路由) ==> 加载子路由（myweb/urls.py）

    ==> 正则匹配访问的路径(path) =-=> 视图函数(views.index)

    ==> views.py index() 响应内容
```

#### 使用正则表达式:

- 如果路径和转换器语法不足以定义URL模式，则还可以使用正则表达式。为此，请使用`re_path()`代替`path()`。
- 在Python正则表达式中，命名正则表达式组的语法为`(?P<name>pattern)`,其中`name`是组的名称，并且 pattern是匹配的某种模式。
- 这是前面的示例URLconf，使用正则表达式重写：

```python
from django.urls import path, re_path

from . import views

urlpatterns = [
    path('articles/2003/', views.special_case_2003),
    re_path(r'^articles/(?P<year>[0-9]{4})/$', views.year_archive),
    re_path(r'^articles/(?P<year>[0-9]{4})/(?P<month>[0-9]{2})/$', views.month_archive),
    re_path(r'^articles/(?P<year>[0-9]{4})/(?P<month>[0-9]{2})/(?P<slug>[\w-]+)/$', views.article_detail),
]
```

- 这可以完成与上一个示例大致相同的操作，除了：
  - 将要匹配的确切URL受到更多限制。例如，年份10000将不再匹配，因为年份整数被限制为正好是四位数长。
  - 无论正则表达式进行哪种匹配，每个捕获的参数都将作为`字符串`发送到视图。
- 当从使用切换为使用path()，re_path()反之亦然时，特别重要的是要注意视图参数的类型可能会更改，因此您可能需要调整视图。

#### 使用未命名的正则表达式组(不推荐)

- 除了命名组语法（例如）之外`(?P<year>[0-9]{4})`，您还可以使用较短的未命名组（例如）`([0-9]{4})`。
- `不建议特别使用此用法`，因为这样可以更轻松地在匹配的预期含义和视图的参数之间意外引入错误。
- 无论哪种情况，建议在给定的正则表达式中仅使用一种样式。当两种样式混合使用时，任何未命名的组都会被忽略，只有命名的组才会传递到视图函数。

#### 为视图参数指定默认值

- 一个方便的技巧是为视图的参数指定默认参数。这是一个示例URLconf和视图：

```python
# URLconf
from django.urls import path

from . import views

urlpatterns = [
    path('blog/', views.page),
    path('blog/page<int:num>/', views.page),
]

# View (in blog/views.py)
def page(request, num=1):
    # Output the appropriate page of blog entries, according to num.
    ...
```

- 在上面的示例中，两个URL模式都指向同一视图– views.page–但是第一个模式未捕获URL中的任何内容。
- 如果第一个模式匹配，该page()函数将使用它的默认参数num，1。
- 如果第二个模式匹配， page()将使用num捕获的任何值。

### （3）. 错误处理

> 当Django找不到与请求的URL匹配的正则表达式时，或者异常引发时，Django将调用错误处理视图。
>
> 用于这些情况的视图由四个变量指定。它们的默认值对于大多数项目都是足够的，但通过覆盖其默认值可以进一步定制。
>
> 有关详细信息，请参阅自定义错误视图的文档。
>
> 这样的值可以在你的根URLconf中设置。在任何其他URLconf中设置这些变量将不起作用。
>
> 值必须是可调用的，或者代表视图的完整的Python导入路径的字符串，应该被调用来处理手头的错误条件。

变量是：

- handler400- 见django.conf.urls.handler400。
- handler403- 见django.conf.urls.handler403。
- handler404- 见django.conf.urls.handler404。
- handler500- 见django.conf.urls.handler500。

#### 关于404错误

- 404的错误页面，**在模板目录中创建一个404.html的页面**，
- 在配置文件中 **settings.py 配置 DEBUG = False**
- 在配置文件中 **settings.py 配置 TEMPLATES = [{'DIRS': [os.path.join(BASE_DIR,'templates')] }]**
- 同时需要在项目的根目录下创建文件夹`templates`，并且在此目录下创建一个`404.html`文件
- 在出现404的情况时，自动寻找404页面。
- 也可以在视图函数中 手动报出404错误，带提醒信息

在视图函数中也可以指定返回一个404

```
注意 Http404需要在django.http的模块中引入
 # 响应404
 raise Http404('纳尼a')
```

在模板中 404.html

```
<!DOCTYPE html>
<html>
<head>
    <title>404</title>
</head>
<body>
    <center>
        <h2>404 not found</h2>
        <h3>{ {   exception   } }</h3>
    </center>
</body>
</html>
```

### (4). 包括其他的URLconf

> 在任何时候，您`urlpatterns`都可以“包含”其他URLconf模块。
>
> 这实质上是将一组网址“植根于”其他网址之下

例如，下面是[Django网站](https://www.djangoproject.com/)本身的URLconf的摘录。它包含许多其他URLconf：

```python
from django.urls import include, path

urlpatterns = [
    # ... snip ...
    path('community/', include('aggregator.urls')),
    path('contact/', include('contact.urls')),
    # ... snip ...
]
```

- 每当Django遇到时include()，它都会截断直到该时间点匹配的URL的任何部分，并将剩余的字符串发送到包含的URLconf中以进行进一步处理每当Django遇到`include()`（[`django.urls.include()`](https://docs.djangoproject.com/en/1.11/ref/urls/#django.conf.urls.include)）时，它会截断与该点匹配的URL的任何部分，并将剩余的字符串发送到包含的URLconf以供进一步处理。

### (5). URL的反向解析

如果在视图、模板中使用硬编码的链接，**在urlconf发生改变时，维护是一件非常麻烦的事情**

- 解决：在做链接时，通过指向urlconf的名称，动态生成链接地址
- 视图：使用django.urls.reverse()函数
- 模板：使用url模板标签

#### 示例

- 在URLconf中

```python
from django.urls import path

from . import views

urlpatterns = [
    #...
    path('articles/<int:year>/', views.year_archive, name='news-year-archive'),
    #...
]
```

- 根据这种设计，对应于年度归档文件的URL NNNN 是/articles//。
- 您可以使用以下模板代码获取这些：

```html
<a href="{ %   url 'news-year-archive' 2020   % }">2020 Archive</a>
{# Or with the year in a template context variable: #}
<ul>
    {% for yearvar in year_list %}
        <li><a href="{% url 'news-year-archive' yearvar %}">{{ yearvar }} Archive</a></li>
    {% endfor %}
</ul>
```

- 在Python代码中：

```python
from django.http import HttpResponseRedirect
from django.urls import reverse

def redirect_to_year(request):
    # ...
    year = 2019
    # ...
    return HttpResponseRedirect(reverse('news-year-archive', args=(year,)))
```

- 或简写

```python
from django.shortcuts import redirect
from django.urls import reverse

def index(request):
    year = 2019
    return redirect(reverse('ews-year-archive',args=(year,)))
```

### 定义模型

### 定义属性

- **对于重要数据都做逻辑删除，不做物理删除，实现方法是定义isDelete属性，类型为BooleanField，默认值为False**



#### 字段类型

- AutoField

  ：一个根据实际ID自动增长的IntegerField，通常不指定

  - 如果不指定，一个主键字段将自动添加到模型中

- BooleanField：true/false 字段，此字段的默认表单控制是CheckboxInput

- NullBooleanField：支持null、true、false三种值

- **CharField**(max_length=字符长度)：字符串，默认的表单样式是 TextInput

- **TextField**：大文本字段，一般超过4000使用，默认的表单控件是Textarea

- **IntegerField**：整数

- DecimalField(max_digits=None, decimal_places=None)：使用python的Decimal实例表示的十进制浮点数

  - DecimalField.max_digits：位数总数
  - DecimalField.decimal_places：小数点后的数字位数

- **FloatField**：用Python的float实例来表示的浮点数

- DateField[auto_now=False, auto_now_add=False])：使用Python的datetime.date实例表示的日期

  - 参数DateField.auto_now：每次保存对象时，自动设置该字段为当前时间，用于"最后一次修改"的时间戳，它总是使用当前日期，默认为false
  - 参数DateField.auto_now_add：当对象第一次被创建时自动设置当前时间，用于创建的时间戳，它总是使用当前日期，默认为false
  - 该字段默认对应的表单控件是一个TextInput. 在管理员站点添加了一个JavaScript写的日历控件，和一个“Today"的快捷按钮，包含了一个额外的invalid_date错误消息键
  - auto_now_add, auto_now, and default 这些设置是相互排斥的，他们之间的任何组合将会发生错误的结果

- TimeField：使用Python的datetime.time实例表示的时间，参数同DateField

- **DateTimeField**：使用Python的datetime.datetime实例表示的日期和时间，参数同DateField

- FileField：一个上传文件的字段

- ImageField：继承了FileField的所有属性和方法，但对上传的对象进行校验，确保它是个有效的image

#### 字段选项

- 通过字段选项，可以实现对字段的约束
- 在字段对象时通过关键字参数指定
- null：如果为True，Django 将空值以NULL 存储到数据库中，默认值是 False
- blank：如果为True，则该字段允许为空白，默认值是 False
- **对比：null是数据库范畴的概念，blank是表单验证证范畴的**
- db_column：字段的名称，如果未指定，则使用属性的名称
- db_index：若值为 True, 则在表中会为此字段创建索引
- default：默认值
- primary_key：若为 True, 则该字段会成为模型的主键字段
- unique：如果为 True, 这个字段在表中必须有唯一值

#### 关系

- 关系的类型包括
  - ForeignKey：一对多，将字段定义在多的端中
  - ManyToManyField：多对多，将字段定义在两端中
  - OneToOneField：一对一，将字段定义在任意一端中
- 可以维护递归的关联关系，使用'self'指定，详见“自关联”
- 用一访问多：对象.模型类小写_set

```
bookinfo.heroinfo_set
```

- 用一访问一：对象.模型类小写

```
heroinfo.bookinfo
```

- 访问id：对象.属性_id

```
heroinfo.book_id
```



### 元选项

- 在模型类中定义类Meta，用于设置元信息

- 元信息db_table：定义数据表名称，推荐使用小写字母，

- 数据表的默认名称:<app_name>_<model_name>

- 例如myweb_users

- ordering：对象的默认排序字段，获取对象的列表时使用，接收属性构成的列表

  ```
  class BookInfo(models.Model):
      ...
      class Meta():
          ordering = ['id']
  ```

- 字符串前加-表示倒序，不加-表示正序

  ```
  class BookInfo(models.Model):
      ...
      class Meta():
          ordering = ['-id']
  ```

- 排序会增加数据库的开销

### 示例演示

- 创建test2项目，并创建booktest应用，使用mysql数据库
- 定义图书模型

```
class BookInfo(models.Model):
    btitle = models.CharField(max_length=32)
    bpub_date = models.DateTimeField()
    bread = models.IntegerField(default=0)
    bcommet = models.IntegerField(default=0)
    isDelete = models.BooleanField(default=False)
```

- 英雄模型

```
class HeroInfo(models.Model):
    hname = models.CharField(max_length=32)
    hgender = models.BooleanField(default=True)
    isDelete = models.BooleanField(default=False)
    hcontent = models.CharField(max_length=100)
    hbook = models.ForeignKey('BookInfo')
```

- 定义index、detail视图
- index.html、detail.html模板
- 配置url，能够完成图书及英雄的展示



### 模型实例

### 1. 类的属性

- objects：是Manager类型的对象，用于与数据库进行交互

- 当定义模型类时没有指定管理器，则Django会为模型类提供一个名为objects的管理器

- 支持明确指定模型类的管理器

  ```
  class BookInfo(models.Model):
    ...
    books = models.Manager()
  ```

- 当为模型类指定管理器后，django不再为模型类生成名为objects的默认管理器

### 2. 创建对象

- 当创建对象时，django不会对数据库进行读写操作
- 调用save()方法才与数据库交互，将对象保存到数据库中
- 使用关键字参数构造模型对象很麻烦，推荐使用下面的两种之式
- 说明：*init*方法已经在基类models.Model中使用，在自定义模型中无法使用，

### 3. 实例的属性

- DoesNotExist：在进行单个查询时，模型的对象不存在时会引发此异常，结合try/except使用

### 4. 实例的方法

- **`__str__(self)`：重写object方法，此方法在将对象转换成字符串时会被调用**
- **save()：将模型对象保存到数据表中**
- **delete()：将模型对象从数据表中删除**



### 模型查询

- 查询集表示从数据库中获取的对象集合
- 查询集可以含有零个、一个或多个过滤器
- 过滤器基于所给的参数限制查询的结果
- 从Sql的角度，查询集和select语句等价，过滤器像where和limit子句
- 接下来主要讨论如下知识点
  - 查询集
  - 字段查询：比较运算符，F对象，Q对象

### 1. 查询集

- 在管理器上调用过滤器方法会返回查询集

- **查询集经过过滤器筛选后返回新的查询集，因此可以写成链式过滤**

- **惰性执行：创建查询集不会带来任何数据库的访问，直到调用数据时，才会访问数据库**

- 何时对查询集求值：迭代，序列化，与if合用

- **返回查询集的方法，称为过滤器**

  - all()
  - filter()
  - exclude()
  - order_by()
  - values()：一个对象构成一个字典，然后构成一个列表返回

- 写法：

  ```
  filter(键1=值1,键2=值2)
  等价于
  filter(键1=值1).filter(键2=值2)
  ```

- **返回单个值的方法**

  - get()：返回单个满足条件的对象
    - 如果未找到会引发"模型类.DoesNotExist"异常
    - 如果多条被返回，会引发"模型类.MultipleObjectsReturned"异常
  - count()：返回当前查询的总条数
  - first()：返回第一个对象
  - last()：返回最后一个对象
  - exists()：判断查询集中是否有数据，如果有则返回True

#### 限制查询集

- 查询集返回列表，可以使用下标的方式进行限制，等同于sql中的limit和offset子句

- 注意：不支持负数索引

- 使用下标后返回一个新的查询集，不会立即执行查询

- 如果获取一个对象，直接使用[0]，等同于[0:1].get()，但是如果没有数据，[0]引发IndexError异常，[0:1].get()引发DoesNotExist异常

  ```
  #这会返回前5个对象 LIMIT 5
  Entry.objects.all()[:5]
  #这将返回第六个到第十个对象 OFFSET 5 LIMIT 5
  Entry.objects.all()[5:10]
  ```

#### 查询集的缓存

- 每个查询集都包含一个缓存来最小化对数据库的访问

- 在新建的查询集中，缓存为空，首次对查询集求值时，会发生数据库查询，django会将查询的结果存在查询集的缓存中，并返回请求的结果，接下来对查询集求值将重用缓存的结果

- 情况一：**这构成了两个查询集，无法重用缓存，每次查询都会与数据库进行一次交互，增加了数据库的负载**

  ```
  print([e.title for e in Entry.objects.all()])
  print([e.title for e in Entry.objects.all()])
  ```

- 情况二：**两次循环使用同一个查询集，第二次使用缓存中的数据**

  ```
  querylist=Entry.objects.all()
  print([e.title for e in querylist])
  print([e.title for e in querylist])
  ```

- 何时查询集不会被缓存：当只对查询集的部分进行求值时会检查缓存，但是如果这部分不在缓存中，那么接下来查询返回的记录将不会被缓存，这意味着使用索引来限制查询集将不会填充缓存，如果这部分数据已经被缓存，则直接使用缓存中的数据

### 2. 字段查询

- 实现where子名，作为方法filter()、exclude()、get()的参数
- 语法：属性名称__比较运算符=值
- 表示两个下划线，左侧是属性名称，右侧是比较类型
- 对于外键，使用“属性名_id”表示外键的原始值
- 转义：like语句中使用了%与，匹配数据中的%与，在过滤器中直接写，例如：filter(title__contains="%")=>where title like '%\%%'，表示查找标题中包含%的

#### 比较运算符

- exact：表示判等，大小写敏感；如果没有写“ 比较运算符”，表示判等

  ```
  filter(isDelete=False)
  ```

- contains：是否包含，大小写敏感

  ```
  exclude(btitle__contains='传')
  ```

- startswith、endswith：以value开头或结尾，大小写敏感

  ```
  exclude(btitle__endswith='传')
  ```

- isnull、isnotnull：是否为null

  ```
  filter(btitle__isnull=False)
  ```

- 在前面加个i表示不区分大小写，如iexact、icontains、istarswith、iendswith

- in：是否包含在范围内

  ```
  filter(pk__in=[1, 2, 3, 4, 5])
  ```

- gt、gte、lt、lte：大于、大于等于、小于、小于等于

  ```
  filter(id__gt=3)
  ```

- year、month、day、week_day、hour、minute、second：对日期间类型的属性进行运算

  ```
  filter(bpub_date__year=1980)
  filter(bpub_date__gt=date(1980, 12, 31))
  ```

#### 跨关联关系的查询：处理join查询

- 语法：模型类名 <属性名> <比较>

- 注：可以没有__<比较>部分，表示等于，结果同inner join

- 可返向使用，即在关联的两个模型中都可以使用

  ```
  filter(heroinfo_ _hcontent_ _contains='八')
  ```

#### 聚合函数

- 使用aggregate()函数返回聚合函数的值

- 函数：Avg，Count，Max，Min，Sum

  ```
  from django.db.models import Max
  maxDate = list.aggregate(Max('bpub_date'))
  ```

- count的一般用法：

  ```
  count = list.count()
  ```



### **模型(Model)负责业务对象和数据库的关系映射(ORM)**

#### 配置Mysql数据库

1. 登录连接MySQL数据库，并创建数据库mytest。

   ```
   create databases mytest default charset=utf8
   ```

2. 在Django框架中使用MySQL数据库需要加载 MySQLdb模块，也就是需要安装 mysqlclient，若已经安装请略过。

   ```
   $ pip install  mysqlclient
   ```

3. 在现有的Django项目中的配置数据库连接信息
   修改settings.py文件中的DATABASE配置项

   ```python
   DATABASES = {
       'default': {
           'ENGINE': 'django.db.backends.mysql',
           'NAME': 'mytest',#选择数据库的名,请确认你的mysql中有这个库
           'USER': 'root',
           'PASSWORD': '',
           'HOST': 'localhost',
           'PORT': '3306',
           }
   }
   ```

#### 开发流程

1. 在models.py中定义模型类，要求继承自models.Model

   ```python
   from django.db import models
   from datetime import datetime
   
   # Create your models here.
   class Users(models.Model):
    #id = models.AutoField(primary_key=True) #主键可省略不写
    name = models.CharField(max_length=32)
    age = models.IntegerField(default=20)
    phone = models.CharField(max_length=16)
    addtime=models.DateTimeField(default=datetime.now)
   
   #class Meta:
   #    db_table = "myapp_users"  # 指定表名
   ```

2. 把应用加入settings.py文件的installed_app项
   编辑myweb/settings.py文件，并将项目应用文件名添加到该INSTALLED_APPS设置。

   ```python
   INSTALLED_APPS = [
    'django.contrib.admin',
    'django.contrib.auth',
    'django.contrib.contenttypes',
    'django.contrib.sessions',
    'django.contrib.messages',
    'django.contrib.staticfiles',
    'myapp', #或全称：myapp.apps.MyappConfig
   ]
   ```

3. 生成迁移文件

   ```
   python3 manage.py makemigrations
   
   django.core.exceptions.ImproperlyConfigured: Error loading MySQLdb module: No mo
   dule named 'MySQLdb'.
   Did you install mysqlclient or MySQL-python?
   安装上面"配置Mysql数据库"的第五步配置，或安装：pip install mysqlclient后就可以了
   
   若执行python manage.py makemigrations命令(也可能人比较皮，把migrations文件夹给删了)，会提示"No changes detected." 可能有用的解决方式如下：
   
    先 python manage.py makemigrations --empty yourappname 生成一个空的initial.py
    再 python manage.py makemigrations 生成原先的model对应的migration file
   ```

4. 执行迁移

   ```
   python3 manage.py migrate
   ```

5. 使用模型类进行crud操作（具体详见第二小节）





### HttpResponse对象

1. 在django.http模块中定义了HttpResponse对象的API
2. HttpRequest对象由Django自动创建，HttpResponse对象由程序员创建
3. 在每一个视图函数中必须返回一个HttpResponse对象,当然也可以是HttpResponse子对象

### 1.不用模板,直接返回数据

```python
from django.http import HttpResponse

def index(request):
    return HttpResponse('你好')
```

### 2.调用模板返回数据

```python
from django.http import HttpResponse

# 返回模板
return render(request,'user/edit.html',{'info':'你好'})
```

### 3.子类HttpResponseRedirect

> 重定向，服务器端跳转
> 构造函数的第一个参数用来指定重定向的地址
> 可以简写为 redirect

```python
from django.shortcuts import redirect
from django.urls import reverse

def index(request):
    return redirect(reverse('myindex')
```

### 4.子类JsonResponse

> 返回json数据，一般用于异步请求
> 帮助用户创建JSON编码的响应
> JsonResponse的默认Content-Type为application/json

```python
from django.http import JsonResponse

def index2(requeset):
    return JsonResponse({'list': 'abc'})
```

### 5.set_cookie方法

> Cookie 是由 Web 服务器保存在用户浏览器（客户端）上的小文本文件，它可以包含有关用户的信息。
>
> 服务器可以利用Cookies包含信息的任意性来筛选并经常性维护这些信息，以判断在HTTP传输中的状态。
>
> Cookies最典型的应用是判定注册用户是否已经登录网站

#### 设置cookie

```python
 # 获取当前的 响应对象
 response = HttpResponse('cookie的设置')

 # 使用响应对象进行cookie的设置
 response.set_cookie('a','abc')

 # 返回响应对象
 return response
```

#### 获取cookie

```python
# 读取
a = request.COOKIES.get('a',None)

if a:
    return HttpResponse('cookie的读取：'+a)
else:
    return HttpResponse('cookie不存在')
```

- 使用cookie做了一个页面访问计数器

```python
# 读取
m = request.COOKIES.get('num',None)
if m:
    m = int(m)+1
else:
    m = 1
# 获取当前的 响应对象
response = HttpResponse('cookie记录的计数器值：'+str(m))
# 使用响应对象进行cookie的设置
response.set_cookie('num',m)
# 返回响应对象
return respo
```

### HttpReqeust对象

- **视图函数的第一个参数是HttpRequest对象**

### 属性

下面除非特别说明，属性都是只读的

- path：一个字符串，表示请求的页面的完整路径，不包含域名
- method：一个字符串，表示请求使用的HTTP方法，常用值包括：'GET'、'POST'
- encoding：一个字符串，表示提交的数据的编码方式
  - 如果为None则表示使用浏览器的默认设置，一般为utf-8
  - 这个属性是可写的，可以通过修改它来修改访问表单数据使用的编码，接下来对属性的任何访问将使用新的encoding值
- GET：一个类似于字典的对象，包含get请求方式的所有参数
- POST：一个类似于字典的对象，包含post请求方式的所有参数
- FILES：一个类似于字典的对象，包含所有的上传文件
- COOKIES：一个标准的Python字典，包含所有的cookie，键和值都为字符串
- session：一个既可读又可写的类似于字典的对象，表示当前的会话，只有当Django 启用会话的支持时才可用，详细内容见“状态保持”

### 方法

- **`is_ajax()`：如果请求是通过XMLHttpRequest发起的，则返回True**

### QueryDict对象

```
query 
n.	查询; 询问; 疑问; 问号;
v.	询问; 怀疑; 表示疑虑;

```



- 定义在django.http.QueryDict

- request对象的属性GET、POST都是QueryDict类型的对象

- 与python字典不同，QueryDict类型的对象用来处理同一个键带有多个值的情况

- 方法get()：根据键获取值

  - 只能获取键的一个值

  - 如果一个键同时拥有多个值，获取最后一个值

    ```
    dict.get('键',default)
    或简写为
    dict['键']
    ```

- 方法getlist()：根据键获取值

  - 将键的值以列表返回，可以获取一个键的多个值

    ```
    dict.getlist('键',default)
    ```

### GET && POST

> **一键一值**

```
http://127.0.0.1/get?a=1&b=2&c=3

request.GET['name']
request.GET.get('name',None)
```

> **一键多值**

```
http://127.0.0.1/get?a=1&a=2&b=3

request.GET.getlist('name',None)

request.POST.getlist('name',None)
```

### 验证码

 *CRSF* CSRF漏洞概述 Cross-site request forgery简称为“CSRF",

- 在用户注册、登录页面，为了防止暴力请求，可以加入验证码功能，如果验证码错误，则不需要继续处理，可以减轻一些服务器的压力
- 使用验证码也是一种有效的防止crsf的方法
- 需要安装扩展：`pip install pillow`

### 验证码视图

- 新建viewsUtil.py，定义函数verifycode
- 此段代码用到了PIL中的Image、ImageDraw、ImageFont模块，需要先安装Pillow（3.4.1）包，详细文档参考http://pillow.readthedocs.io/en/3.4.x/
- Image表示画布对象
- ImageDraw表示画笔对象
- ImageFont表示字体对象，ubuntu的字体路径为“/usr/share/fonts/truetype/freefont”

*代码如下：

```python
from django.http import HttpResponse
def verifycode(request):
    #引入绘图模块
    from PIL import Image, ImageDraw, ImageFont
    #引入随机函数模块
    import random
    #定义变量，用于画面的背景色、宽、高
    bgcolor = (random.randrange(20, 100), random.randrange(
        20, 100), 255)
    width = 100
    height = 25
    #创建画面对象
    im = Image.new('RGB', (width, height), bgcolor)
    #创建画笔对象
    draw = ImageDraw.Draw(im)
    #调用画笔的point()函数绘制噪点
    for i in range(0, 100):
        xy = (random.randrange(0, width), random.randrange(0, height))
        fill = (random.randrange(0, 255), 255, random.randrange(0, 255))
        draw.point(xy, fill=fill)
    #定义验证码的备选值
    str1 = 'ABCD123EFGHIJK456LMNOPQRS789TUVWXYZ0'
    #随机选取4个值作为验证码
    rand_str = ''
    for i in range(0, 4):
        rand_str += str1[random.randrange(0, len(str1))]
    #构造字体对象
    font = ImageFont.truetype('static/msyh.ttf', 23)
    #font = ImageFont.load_default().font
    #构造字体颜色
    fontcolor = (255, random.randrange(0, 255), random.randrange(0, 255))
    #绘制4个字
    draw.text((5, 2), rand_str[0], font=font, fill=fontcolor)
    draw.text((25, 2), rand_str[1], font=font, fill=fontcolor)
    draw.text((50, 2), rand_str[2], font=font, fill=fontcolor)
    draw.text((75, 2), rand_str[3], font=font, fill=fontcolor)
    #释放画笔
    del draw
    #存入session，用于做进一步验证
    request.session['verifycode'] = rand_str
    #内存文件操作
    """
    python2的为
    # 内存文件操作
    import cStringIO
    buf = cStringIO.StringIO()
    """
    # 内存文件操作-->此方法为python3的
    import io
    buf = io.BytesIO()
    #将图片保存在内存中，文件类型为png
    im.save(buf, 'png')
    #将内存中的图片数据返回给客户端，MIME类型为图片png
    return HttpResponse(buf.getvalue(), 'image/png')
```

### 配置url

- 在urls.py中定义请求验证码视图的url

```python
from django.urls import path
from . import viewsUtil

urlpatterns = [
    path('verifycode/', viewsUtil.verifycode),
]
```

### 显示验证码

- 在模板中使用img标签，src指向验证码视图

```html
<img id='verifycode' src="/verifycode/" alt="CheckCode"/>
```

- 启动服务器，查看显示成功
- 扩展：点击“看不清，换一个”时，可以换一个新的验证码

```html
<script type="text/javascript" src="/static/jquery-1.12.4.min.js"></script>
<script type="text/javascript">
    $(function(){
        $('#verifycodeChange').css('cursor','pointer').click(function() {
            $('#verifycode').attr('src',$('#verifycode').attr('src')+1)
        });
    });
</script>
<img id='verifycode' src="/verifycode/?1" alt="CheckCode"/>
<span id='verifycodeChange'>看不清，换一个</span>
```

- 为了能够实现提交功能，需要增加form和input标签

```html
<form method='post' action='/verifycodeValid/'>
    <input type="text" name="vc">
    <img id='verifycode' src="/verifycode/?1" alt="CheckCode"/>
<span id='verifycodeChange'>看不清，换一个</span>
<br>
<input type="submit" value="提交">
</form>
```

### 验证

- 接收请求的信息，与session中的内容对比

```python
from django.http import HttpResponse

def verifycodeValid(request):
    vc = request.POST['vc']
    if vc.upper() == request.session['verifycode']:
        return HttpResponse('ok')
    else:
        return HttpResponse('no')
```

- 配置验证处理的url

```python
from django.urls import path

urlpatterns = [
    path('verifycodeValid/', views.verifycodeValid),
]
```

### 第三方

可以在网上搜索“验证码”，找到一些第三方验证码提供网站，阅读文档，使用到项目中



### Django的视图层(View)

- Django框架中的视图（View）是用来负责处理用户请求和返回响应的逻辑程序
- 视图（View）简而言之就是一个Python的函数或方法，接受处理Web请求。
- 视图的响应可以是网页的HTML内容，重定向或404错误，XML文档或图像。
- 视图的代码按惯例是放置一个名为`views.py`的文件中，此文件放在项目或应用程序目录中。（其实视图文件名可以自己定义）

### 1. 一个简单的视图

这是一个返回当前日期和时间的视图，作为HTML文档：

```
from django.http import HttpResponse
import datetime

def current_datetime(request):
    now = datetime.datetime.now()
    html = "<html><body>It is now %s.</body></html>" % now
    return HttpResponse(html)
```

### 2. 返回错误

```
# 直接返回一个404,没有去加载404的模板页面
# return HttpResponseNotFound('<h1>Page not found</h1>')

# 可以直接返回一个status状态码
# return HttpResponse(status=403)

# 返回一个404的错误页面
raise Http404("Poll does not exist")
```

### 3.关于重定向

> **重定向(Redirect)就是通过各种方法将各种网络请求重新定个方向转到其它位置**

```
from django.shortcuts import redirect
from django.urls import reverse

# redirect重定向  reverse反向解析url地址
# return redirect(reverse('userindex'))

# 执行一段js代码，用js进行重定向
# return HttpResponse('<script>alert("添加成功");location.href = "/userindex"; </script>')

# 加载一个提醒信息的跳转页面
context = {'info':'数据添加成功','u':'/userindex'}
return render(request,'info.html',context)
```

### 4. 基于类的基本视图：

示例views.py：

```python
from django.http import HttpResponse
from django.views import View

class MyView(View):

    def get(self, request, *args, **kwargs):
        return HttpResponse('Hello, World!')
```

示例urls.py：

```python
from django.urls import path

from myapp.views import MyView

urlpatterns = [
    path('mine/', MyView.as_view(), name='my-view'),
]

# 其中as_view()是接受请求并返回响应的可调用视图['get', 'post', 'put', 'patch', 'delete, 'options'.]
```

### 模板语法\

```
总结一下
1、变量
｛｛ var ｝｝

{% tag  %}

{% for.. in .. %}
循环逻辑
{% endfor %}

{ %  if ...  % }
    逻辑1
{ %  elif ...  % }
    逻辑2
{ %  else  % }
    逻辑3
{ %  endif  % }

{ %  comment  % }
    多行注释
{ %  endcomment  % }

{ %  include "base/index.html"  % }include：加载模板并以标签内的参数渲染

{ %  url 'name' p1 p2  % }url：反向解析

{ %  csrf_token  % }csrf_token：这个标签用于跨站请求伪造保护

{ {  变量|过滤器  } }，例如{ {  name|lower  } }，表示将变量name的值变为小写输出

{ {  data|safe  } }
if list1|length > 1
name|lower|upper
list|join:", "
value|default:"什么也没有"
value|date:'Y-m-d'

{# 注释 #}
{%  comment  %}
      多行注释
{%  endcomment  %}

使用：在模板文件使用 { % load pagetag % }
  <h4>6. 自定义标签 </h4>
  {% load pagetag %}
  大写：{{name|myupper}} <br/>
  相减：{% jian m1 m2 %}

```





### 1.变量

- 变量输出语法

  ```js
  { {  var  } }
  ```

- 当模版引擎遇到一个变量，将计算这个变量，然后将结果输出

- 变量名必须由字母、数字、下划线（不能以下划线开头）和点组成

- 当模版引擎遇到点(".")，会按照下列顺序查询：

  - 字典查询，例如：foo["bar"]
  - 属性或方法查询，例如：foo.bar
  - 数字索引查询，例如：foo[bar]

- 如果变量不存在， 模版系统将插入'' (空字符串)

- 在模板中调用方法时不能传递参数

### 2.标签

- 语法

  ```
  { %  tag  % }
  ```

- 作用

  - 在输出中创建文本
  - 控制循环或逻辑
  - 加载外部信息到模板中

#### **for标签**

```js
{ %  for ... in ...  % }
    循环逻辑

{ %  endfor  % }
```

#### **if标签**

```js
{ %  if ...  % }
    逻辑1
{ %  elif ...  % }
    逻辑2
{ %  else  % }
    逻辑3
{ %  endif  % }
```

#### **comment标签**

```js
{ %  comment  % }
    多行注释
{ %  endcomment  % }
```

#### **include：加载模板并以标签内的参数渲染**

```js
{ %  include "base/index.html"  % }
```

#### **url：反向解析**

```js
{ %  url 'name' p1 p2  % }
```

#### **csrf_token：这个标签用于跨站请求伪造保护**

```js
{ %  csrf_token  % }
```

### 3.过滤器

- 语法：

  ```js
  { {  变量|过滤器  } }，例如{ {  name|lower  } }，表示将变量name的值变为小写输出
  ```

- 使用管道符号 (|)来应用过滤器

- 通过使用过滤器来改变变量的计算结果

- 关闭HTML自动转义

  ```js
  { {  data|safe  } }
  ```

- 可以在if标签中使用过滤器结合运算符

  ```js
  if list1|length > 1
  ```

- 过滤器能够被“串联”，构成过滤器链

  ```js
  name|lower|upper
  ```

- 过滤器可以传递参数，参数使用引号包起来

  ```js
  list|join:", "
  ```

- default：如果一个变量没有被提供，或者值为false或空，则使用默认值，否则使用变量的值

  ```js
  value|default:"什么也没有"
  ```

- date：根据给定格式对一个date变量格式化

  ```js
  value|date:'Y-m-d'
  ```

- 官方文档内置过滤器参考：

- 网址：https://docs.djangoproject.com/zh-hans/2.2/ref/templates/builtins/#ref-templates-builtins-filters

### 4.注释

- 单行注释

```
{# 注释 #}
```

- 多行注释

```
{%  comment  %}
      多行注释
{%  endcomment  %}
```

### 5.模板运算

- 加

  ```js
  { {  value|add:10  } }
  note:value=5,则结果返回15
  ```

- 减

  ```js
  { {  value|add:-10  } }
  note:value=5,则结果返回-5，加一个负数就是减法了
  ```

- 乘

  ```js
  { %  widthratio 5 1 100  % }
  note:等同于：(5 / 1) * 100 ，结果返回500，
  withratio需要三个参数，它会使用参数1/参数2*参数3的方式进行运算，进行乘法运算，使「参数2」=1
  ```

- 除

  ```js
  { %  widthratio 5 100 1  % }
  note:等同于：(5 / 100) * 1,则结果返回0.05,和乘法一样，使「参数3」= 1就是除法了。
  ```

### 6.自定义 标签 或 过滤器

- 首先在当前应用目录下创建一个`templatetags`模板标签目录，建议内放一个`__init__.py`的空文件
- 然后在`templatetags`目录下创建一个模板标签文件`pagetag.py`,具体代码如下：

```python
 templatetags
    ├── pagetag.py
    ----------------pagetag.py-------------------------
    from django import template

    register = template.Library()

    # 自定义过滤器（实现大写转换）
    @register.filter
    def myupper(val):
        # print ('val from template:',val)
        return val.upper()

    # 自定义标签（实现减法计算）
    #from django.utils.html import format_html
    @register.simple_tag
    def jian(a,b):
        res = int(a) - int(b)
        return res
```

- 使用：在模板文件使用 `{ % load pagetag % }`

```
  <h4>6. 自定义标签 </h4>
  {% load pagetag %}
  大写：{{name|myupper}} <br/>
  相减：{% jian m1 m2 %}
```

### 模板继承

```
 总结：
 模板继承可以减少页面内容的重复定义，实现页面内容的重用
 
 定义父模板base.html
{ %  block block_name  % }
   这里可以定义默认值
   如果不定义默认值，则表示空字符串
{ %  endblock  % }


定义子模板index.html
{ %  extends "base.html"  % }



在子模板中使用block填充预留区域
{ %  block block_name  % }
实际填充内容
{ %  endblock  % }



如果在模版中使用extends标签，它必须是模版中的第一个标签
不能在一个模版中定义多个相同名字的block标签
{ %  block block_name  % }
    区域内容
{ %  endblock block_name  % }


```



- **模板继承可以减少页面内容的重复定义，实现页面内容的重用**

- 典型应用：网站的头部、尾部是一样的，这些内容可以定义在父模板中，子模板不需要重复定义
- block标签：在父模板中预留区域，在子模板中填充
- **extends继承：继承，写在模板文件的第一行**
- 定义父模板base.html

```js
{ %  block block_name  % }
   这里可以定义默认值
   如果不定义默认值，则表示空字符串
{ %  endblock  % }
```

- 定义子模板index.html

```
{ %  extends "base.html"  % }
```

- 在子模板中使用block填充预留区域

```js
{ %  block block_name  % }
实际填充内容
{ %  endblock  % }
```

#### 说明

- **如果在模版中使用extends标签，它必须是模版中的第一个标签**
- **不能在一个模版中定义多个相同名字的block标签**
- 子模版不必定义全部父模版中的blocks，如果子模版没有定义block，则使用了父模版中的默认值
- 如果发现在模板中大量的复制内容，那就应该把内容移动到父模板中
- 使用可以获取父模板中block的内容
- 为了更好的可读性，可以给endblock标签一个名字

```js
{ %  block block_name  % }
    区域内容
{ %  endblock block_name  % }
```

### 三层继承结构

- 三层继承结构使代码得到最大程度的复用，并且使得添加内容更加简单

#### 1.创建根级模板

- 名称为“base.html”
- 存放整个站点共用的内容

```js
<!DOCTYPE html>
<html>
    <head>
        <title>{ %  block title  % }{ %  endblock  % } 水果超市</title>
    </head>
    <body>
        top--{{logo}}
        <hr/>
        { %  block left  % }

        { %  endblock  % }

        { %  block content  % }

        { %  endblock  % }
        <hr/>
        bottom
    </body>
</html>
```

#### 2.创建分支模版

- 继承自base.html
- 名为“base_***.html”
- 定义特定分支共用的内容
- 定义base_goods.html

```js
{ %  extends 'temtest/base.html'  % }

{ %  block title  % }商品{ %   endblock   % }

{ %  block left  % }
    <h1>goods left</h1>
{ %  endblock  % }
```

- 定义base_user.html

```js
{ %  extends 'temtest/base.html'  % }

{ %  block title  % }用户中心{ %  endblock   % }

{ %  block left  % }
    <font color='blue'>user left</font>
{ %  endblock  % }
```

- 定义index.html，继承自base.html，不需要写left块

```js
{ %  extends 'temtest/base.html'  % }

{ %  block content  % }
    首页内容
{ %  endblock content  % }
```

#### 3.为具体页面创建模板，继承自分支模板

- 定义商品列表页goodslist.html

```js
{ %  extends 'temtest/base_goods.html'  % }
{ %  block content  % }
    商品正文列表
{ %  endblock content  % }
```

- 定义用户密码页userpwd.html

```js
{ %  extends 'temtest/base_user.html'  % }
{ %  block content  % }
    用户密码修改
{ %  endblock content  % }
```

#### 4.视图调用具体页面，并传递模板中需要的数据

- 首页视图index

```py
logo='welcome to itcast'
def index(request):
    return render(request, 'temtest/index.html', {'logo': logo})
```

- 商品列表视图goodslist

```py
def goodslist(request):
    return render(request, 'temtest/goodslist.html', {'logo': logo})
```

- 用户密码视图userpwd

```py
def userpwd(request):
    return render(request, 'temtest/userpwd.html', {'logo': logo})
```

#### 5.配置url

```py
from django.urls import path
from . import views
urlpatterns = [
    path('', views.index, name='index'),
    path('list/', views.goodslist, name='list'),
    path('pwd/', views.userpwd, name='pwd'),
]
```

### 上传图片

- 当Django在处理文件上传的时候，文件数据被保存在`request.FILES`
- **FILES中的每个键为<input type="file" name="" />中的name**
- **注意：FILES只有在请求的方法为POST 且提交的<form>带有enctype="multipart/form-data" 的情况下才会包含数据。**
- 否则，FILES 将为一个空的类似于字典的对象

### (1) 自定义上传的模板代码

```html
<html>
<head>
    <title>文件上传</title>
</head>
<body>
    <form method="post" action="upload/" enctype="multipart/form-data">
        <input type="text" name="title"><br>
        <input type="file" name="pic"/><br>
        <input type="submit" value="上传">
    </form>
</body>
</html>
```

- 自定义上传的视图代码

```python
from django.shortcuts import render
from django.http import HttpResponse
from PIL import Image
import time,os

def upload(request):
    '''执行图片的上传'''
    myfile = request.FILES.get("mypic",None)
    if not myfile:
        return HttpResponse("没有上传文件信息")
    filename = str(time.time())+"."+myfile.name.split('.').pop()
    destination = open("./static/pics/"+filename,"wb+")
    for chunk in myfile.chunks():      # 分块写入文件  
        destination.write(chunk)  
    destination.close()

    # 执行图片缩放
    im = Image.open("./static/pics/"+filename)
    # 缩放到75*75(缩放后的宽高比例不变):
    im.thumbnail((75, 75))
    # 把缩放后的图像用jpeg格式保存: 
    im.save("./static/pics/s_"+filename,None)

    #执行图片删除
    #os.remove("./static/pics/"+filename)

    return HttpResponse("上传成功！图片："+filename）
```

### (2) 使用模型处理上传文件：

> **将属性定义成models.ImageField类型**

```python
pic=models.ImageField(upload_to='cars/')
```

- 注意：如果属性类型为ImageField获使用图片处理，那么就需要安装包Pillow

```python
pip install Pillow
```

- 图片存储路径
  - 在项目根目录下创建media文件夹
  - 图片上传后，会被保存到“/static/media/cars/图片文件”
  - 打开settings.py文件，增加media_root项

```python
MEDIA_ROOT=os.path.join(BASE_DIR,"static/media")
```

- 使用django后台管理，遇到ImageField类型的属性会出现一个file框，完成文件上传

### 分页操作

- Django提供了一些类实现管理数据分页，这些类位于django/core/paginator.py中

### Paginator对象

- Paginator(列表,int)：返回分页对象，参数为列表数据，每面数据的条数

#### 属性

- count：对象总数
- num_pages：页面总数
- page_range：页码列表，从1开始，例如[1, 2, 3, 4]

#### 方法

- page(num)：下标以1开始，如果提供的页码不存在，抛出InvalidPage异常

#### 异常exception

- InvalidPage：当向page()传入一个无效的页码时抛出
- PageNotAnInteger：当向page()传入一个不是整数的值时抛出
- EmptyPage：当向page()提供一个有效值，但是那个页面上没有任何对象时抛出

### Page对象

#### 创建对象

- Paginator对象的page()方法返回Page对象，不需要手动构造

#### 属性

- object_list：当前页上所有对象的列表
- number：当前页的序号，从1开始
- paginator：当前page对象相关的Paginator对象

#### 方法

- has_next()：如果有下一页返回True
- has_previous()：如果有上一页返回True
- has_other_pages()：如果有上一页或下一页返回True
- next_page_number()：返回下一页的页码，如果下一页不存在，抛出InvalidPage异常
- previous_page_number()：返回上一页的页码，如果上一页不存在，抛出InvalidPage异常
- len()：返回当前页面对象的个数
- 迭代页面对象：访问当前页面中的每个对象

### 代码示例

#### 1. 创建项目mydemo

#### 创建视图pagTest

```python
from django.core.paginator import Paginator

def pagTest(request, pIndex):
    list1 = AreaInfo.objects.filter(aParent__isnull=True)
    p = Paginator(list1, 10)
    if pIndex == '':
        pIndex = '1'
    pIndex = int(pIndex)
    list2 = p.page(pIndex)
    plist = p.page_range
    return render(request, 'booktest/pagTest.html', {'list': list2, 'plist': plist, 'pIndex': pIndex})
```

#### 配置url

```python
path('pag<int:pIndex>/', views.pagTest, name='pagTest'),
```

#### 定义模板pagTest.html

```html
<!DOCTYPE html>
<html>
<head>
    <title></title>
</head>
<body>
<ul>
{%for area in list%}
<li>{{area.id}}--{{area.atitle}}</li>
{%endfor%}
</ul>

{%for pindex in plist%}
{%if pIndex == pindex%}
{{pindex}}&nbsp;&nbsp;
{%else%}
<a href="/pag{{pindex}}/">{{pindex}}</a>&nbsp;&nbsp;
{%endif%}
{%endfor%}
</body>
</html>
```

### 富文本编辑器

https://github.com/fex-team/ueditor

### 配置方法

### 1,下载解压ueditor文件包,放置在项目中.,作为一个应用目录

```py
myproject:
    manage.py  myproject  static     ueditor
    myadmin    myweb      templates 

uediter文件夹包括以下:
    controller.py   __init__.py   msyhbd.ttf   UE/             urls.py
    controller.pyc  __init__.pyc  __pycache__  ueconfig.json  urls.pyc
```

### 2,打开settings.py，给INSTALLED_APPS加入应用ueditor

```py
INSTALLED_APPS = [
        'django.contrib.admin',
        'django.contrib.auth',
        'django.contrib.contenttypes',
        'django.contrib.sessions',
        'django.contrib.messages',
        'django.contrib.staticfiles',
        'myadmin',
        'myweb',
        'ueditor',
    ]
```

### 3,检查一下settings.py是否设置好static静态目录，可参考如下设置

```py
STATIC_URL = '/static/'
#静态目录
STATICFILES_DIRS = (
    os.path.join(BASE_DIR, "static"),
)
```

### 4,打开django项目的urls.py文件，添加ueditor的url路由配置

```py
myproject/myproject/urls.py:

from django.urls import include,path
from django.contrib import admin

urlpatterns = [
    path('ueditor/', include('ueditor.urls')),
    path('admin/',include('myadmin.urls')),
    path('',include('myweb.urls')),
]
```

### 5,上面步骤配置完成之后，基本可以使用了。

```js
ueditor配置可能需要根据你的项目具体情况修改。 
ueditor前端配置文件，在ueditor/UE/ueditor.config.js 
ueditor后端配置文件，在ueditor/ueconfig.json 具体配置可参考ueditor官网

此时可以在需要使用富文本编辑器的位置设置一下代码:
html:
    <link rel="stylesheet" type="text/css" href="/ueditor/UE/third-party/SyntaxHighlighter/shCoreDefault.css">
    <script type="text/javascript" src="/ueditor/UE/third-party/SyntaxHighlighter/shCore.js"></script>
    <script type="text/javascript" src="/ueditor/UE/ueditor.config.js"></script>
    <script type="text/javascript" src="/ueditor/UE/ueditor.all.min.js"></script>
    <script type="text/javascript" src="/ueditor/UE/lang/zh-cn/zh-cn.js"></script>


    <div class="am-form-group">
        <label for="user-intro" class="am-u-sm-3 am-form-label">商品简介</label>
        <div class="am-u-sm-9">
            <!-- <textarea name="descr" class="" rows="10" id="user-intro" placeholder="请输入商品简介"></textarea> -->
            <!-- <script id="editor" type="text/plain" style="width:100%;height:500px;"></script> -->
            <script id="editor" name="content" type="text/plain" style="height:500px;"></script>
        </div>
    </div>


    <script type="text/javascript">
        var ue = UE.getEditor('editor');
        SyntaxHighlighter.all();
    </script>
```

### 6,其它问题

> 当前使用 妹子UI 模板 css影响了当前的编辑器的样式

```css
修改,/static/myadmin/assets/css/app.css  379行
.tpl-content-wrapper {
  transition: all 0.4s ease-in-out;
  /*position: relative;*/
  margin-left: 240px;
  z-index: 1101;
  min-height: 922px;
  border-bottom-left-radius: 3px;
}
```

### 7,水印功能

- 上传图片自动加水印 该功能默认没开启。

- 上传图片加水印功能需要安装PIL

  ```py
  pip install pillow
  ```

- 水印相关设置在ueconfig.json末尾：

  ```js
  "openWaterMark": false,  //是否开启
  "waterMarkText": "我的水印\nhttp://xxxxx.com", //水印内容，建议一行文本
  "waterMarkFont": "msyhbd.ttf",  //字体，中文需要字体支持才不会出错
  "waterMarkSize": 15,    //字体大小
  "waterMarkBottom": 45,  //下边距
  "waterMarkRight": 155   //右边距
  ```



### 静态文件

### 配置静态文件

#### 1.在settings 文件中定义静态内容

```py
STATIC_URL = '/static/'
STATICFILES_DIRS = [
    os.path.join(BASE_DIR, 'static'),
]
```

#### 2.在项目根目录下创建static目录，再创建当前应用名称的目录

```py
mysite/static/myapp/
```

#### 3.在模板中可以使用硬编码

```py
/static/my_app/myexample.jpg
```

#### 4.在模板中可以使用static编码

```js
{ % load static from staticfiles % }
<img src="{ % static "my_app/myexample.jpg" % }" alt="My image"/>
```

### Csrf

CSRF（Cross-site request forgery）跨站请求伪造，

### csrf的使用

在django的模板中，提供了防止跨站攻击的方法，使用步骤如下：

- step1：在settings.py中启用'django.middleware.csrf.CsrfViewMiddleware'中间件，此项在创建项目时，默认被启用

- step2：在HTML的表单中添加标签

  ```js
  <form>
  { % csrf_token % }
  ...
  </form>
  ```

### 取消保护

如果某些视图不需要保护，可以使用装饰器csrf_exempt，模板中也不需要写标签，修改csrf2的视图如下 from django.views.decorators.csrf import csrf_exempt

```py
@csrf_exempt 
def csrf2(request):
    uname=request.POST['uname'] 
    return render(request,'booktest/csrf2.html',{'uname':uname}) 
    运行上面的两个请求，发现都可以请求
```

### 保护原理

加入标签后，可以查看源代码，发现多了如下代码

```
<input type='hidden' name='csrfmiddlewaretoken' value='nGjAB3Md9ZSb4NmG1sXDolPmh3bR2g59' />
```

- 在浏览器的调试工具中，通过network标签可以查看cookie信息
- 本站中自动添加了cookie信息，如下图csrf3
- 查看跨站的信息，并没有cookie信息，即使加入上面的隐藏域代码，发现又可以访问了
- 结论：django的csrf不是完全的安全
- 当提交请求时，中间件'django.middleware.csrf.CsrfViewMiddleware'会对提交的cookie及隐藏域的内容进行验证，如果失败则返回403错误

#### Ajax CSRF 认证

> GET 请求不需要 CSRF 认证，POST 请求需要正确认证才能得到正确的返回结果。

**如果使用Ajax调用的时候，就要麻烦一些。需要注意以下几点：**

- 在视图中使用**render** （而不要使用 render_to_response）

- 使用 jQuery 的 ajax 或者 post 之前 加入这个 js 代码

  ```js
  jQuery(document).ajaxSend(function(event, xhr, settings) {
      function getCookie(name) {
          var cookieValue = null;
          if (document.cookie && document.cookie != '') {
              var cookies = document.cookie.split(';');
              for (var i = 0; i < cookies.length; i++) {
                  var cookie = jQuery.trim(cookies[i]);
                  // Does this cookie string begin with the name we want?
                  if (cookie.substring(0, name.length + 1) == (name + '=')) {
                      cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                      break;
                  }
              }
          }
          return cookieValue;
      }
      function sameOrigin(url) {
          // url could be relative or scheme relative or absolute
          var host = document.location.host; // host + port
          var protocol = document.location.protocol;
          var sr_origin = '//' + host;
          var origin = protocol + sr_origin;
          // Allow absolute or scheme relative URLs to same origin
          return (url == origin || url.slice(0, origin.length + 1) == origin + '/') ||
              (url == sr_origin || url.slice(0, sr_origin.length + 1) == sr_origin + '/') ||
              // or any other URL that isn't scheme relative or absolute i.e relative.
              !(/^(\/\/|http:|https:).*/.test(url));
      }
      function safeMethod(method) {
          return (/^(GET|HEAD|OPTIONS|TRACE)$/.test(method));
      }
  
      if (!safeMethod(settings.type) && sameOrigin(settings.url)) {
          xhr.setRequestHeader("X-CSRFToken", getCookie('csrftoken'));
      }
  });
  ```

- 或者 **更为优雅简洁的代码（不能写在 .js 中，要直接写在模板文件中**）：

  ```js
  $.ajaxSetup({
      data: {csrfmiddlewaretoken: '{ { csrf_token } }' },
  });
  ```

这样之后，就可以像原来一样的使用 jQuery.ajax() 和 jQuery.post()了

### 状态保持

- **HTTP协议是无状态的：每次请求都是一次新的请求，不会记得之前通信的状**态
- 客户端与服务器端的一次通信，就是一次会话
- **实现状态保持的方式：在客户端或服务器端存储与会话有关的数据**
- 存储方式包括cookie、session，会话一般指session对象
- 使用cookie，所有数据存储在客户端，注意不要存储敏感信息
- **推荐使用sesison方式，所有数据存储在服务器端，在客户端cookie中存储session_id**
- **状态保持的目的是在一段时间内跟踪请求者的状态，可以实现跨页面访问当前请求者的数据**
- **注意：不同的请求者之间不会共享这个数据，与请求者一一对应**

### 开启session

- 使用django-admin startproject创建的项目默认启用

- 禁用会话：删除下面指定的两个值，禁用会话将节省一些性能消耗

- **Django 中session需要依赖数据库,因此需要确认数据库中是否存在 与session相关的 表**

- 在settings.py文件中

  ```py
  * 项INSTALLED_APPS列表中添加：
  * 'django.contrib.sessions',
  
  * 项MIDDLEWARE_CLASSES列表中添加：
  * 'django.contrib.sessions.middleware.SessionMiddleware',
  ```

### 使用session

- 启用会话后，每个HttpRequest对象将具有一个session属性，它是一个类字典对象

- get(key, default=None)：根据键获取会话的值

- clear()：清除所有会话

- flush()：删除当前的会话数据并删除会话的Cookie

- del request.session['member_id']：删除会话

- 示例:

  ```python
  #session设置
   request.session[key] = value
  
  #session获取
   request.session.get(key,default=Node)
  
  #session删除
  
  # 删除单个key 不存在时报错
   del request.session['a'] 
  
  #清除所有会话,但不会删除数据
   request.session.clear() 
  
  #删除当前的会话数据
   request.session.flush()
  ```



### 中间件

- 中间件是一个轻量级、底层的插件系统，可**以介入Django的请求和响应处理过程**，修改Django的输入或输出
- 激活：添加到Django配置文件中的MIDDLEWARE_CLASSES元组中
- 使用中间件，可以干扰整个处理过程，每次请求中都会执行中间件的这个方法

### 验证用户是否登陆示例

在应用中创建AdminLoginMiddleware.py文件

```py
from django.shortcuts import render
from django.http import HttpResponse
import re

class AdminLoginMiddleware:
    def __init__(self, get_response):
        self.get_response = get_response
        # One-time configuration and initialization.

    def __call__(self, request):


        # 检测当前的请求是否已经登录,如果已经登录,.则放行,如果未登录,则跳转到登录页
        # 获取当前用户的请求路径  /admin/开头  但不是 /admin/login/  /admin/dologin/   /admin/verifycode
        urllist = ['/admin/login','/admin/dologin','/admin/vcode']
        # 判断是否进入了后台,并且不是进入登录页面
        if re.match('/admin/',request.path) and request.path not in urllist:

            # 检测session中是否存在 adminlogin的数据记录
            if request.session.get('Vuser','') == '':
                # 如果在session没有记录,则证明没有登录,跳转到登录页面
                return HttpResponse('<script>alert("请先登录");location.href="/admin/login";</script>')



        response = self.get_response(request)
        return response
```

### 配置中间件

在settings.py文件中修改MIDDLEWARE_CLASSES选项

```py
MIDDLEWARE = [
    'django.middleware.security.SecurityMiddleware',
    'django.contrib.sessions.middleware.SessionMiddleware',
    'django.middleware.common.CommonMiddleware',
    'django.middleware.csrf.CsrfViewMiddleware',
    'django.contrib.auth.middleware.AuthenticationMiddleware',
    'django.contrib.messages.middleware.MessageMiddleware',
    'django.middleware.clickjacking.XFrameOptionsMiddleware',
    #自定义的中间件
    'myadmin.AdminMiddleware.AdminLoginMiddleware'
]
```

### 使用Django中提供的密码方案

> 该[`django.contrib.auth.hashers`](https://docs.djangoproject.com/en/1.11/topics/auth/passwords/#module-django.contrib.auth.hashers)模块提供了一组函数来创建和验证散列密码。您可以独立于`User`模型使用它们。

```
 # from django.contrib.auth.hashers import make_password, check_password

 # 对密码进行加密操作
 # upass = make_password(request.POST['password'], None, 'pbkdf2_sha256')
 # upass = check_password('1234567','pbkdf2_sha256$36000$197nqXM6yxYv$Zxh/Vsns8qszkvUmY81BgrjCeLPXhCHLEilP6VO+Rnc=')
```

### python中的MD5加密

```
#获取密码并md5
import hashlib
m = hashlib.md5() 
m.update(bytes(request.POST['password'],encoding="utf8"))
print(m.hexdigest())
```









### model

mvc中，负责在数据库中存取数据

model开发流程

1、model。py 中定义模型类，需继承 models.Model

2、settings.py中加应用

3、生成 Python manage.py makemigrations

4、迁移 python manage.py migrate

5、使用crud操作



## 二、全流程上手搭建一个框架



### Model模型的实战操作笔记

### 1. 创建数据库和表（若是执行表迁移，可跳过下面操作）

- 进入MySQL数据库创建数据库：mytest

- 进入数据库创建数据表：myapp_users

  ```mysql
  CREATE TABLE `myapp_users` (                          
    `id` int(10) unsigned NOT NULL AUTO_INCREMENT,       
    `name` varchar(32) NOT NULL,                         
    `age` tinyint(3) unsigned NOT NULL DEFAULT '20',     
    `phone` varchar(16) DEFAULT NULL,
    `addtime` datetime(6) NOT NULL,                    
    PRIMARY KEY (`id`)                                   
  ) ENGINE=InnoDB AUTO_INCREMENT=1 DEFAULT CHARSET=utf8
  ```

- 添加几条测试数据

## 2. 创建项目myweb和应用myapp

```
    # 创建项目框架mydemo
    $ django-admin startproject mydemo

    $ cd mydemo

    # 在项目中创建一个myapp应用
    $ python manage.py startapp myapp

    # 创建模板目录
    $ mkdir templates
    $ mkdir templates/myapp

    $ cd ..

    $ tree myweb

    mydemo
    ├── mydemo
    │   ├── __init__.py
    │   ├── settings.py
    │   ├── urls.py
    │   └── wsgi.py
    ├── manage.py
    ├── myapp
    │   ├── admin.py
    │   ├── apps.py
    │   ├── __init__.py
    │   ├── models.py
    │   ├── tests.py
    │   └── views.py
    └── templates
        └── myapp
```

## 3. 执行数据库连接配置,网站配置

- 编辑myweb/myweb/settings.py文件，配置数据库连接

```python
...
#配置自己的服务器IP地址
ALLOWED_HOSTS = ['*']

...
#添加自己应用
INSTALLED_APPS = [
    'django.contrib.admin',
    'django.contrib.auth',
    'django.contrib.contenttypes',
    'django.contrib.sessions',
    'django.contrib.messages',
    'django.contrib.staticfiles',
    'myapp',
    #或'myapp.apps.MyappConfig',  #或者直接写 myapp
]
...

# 配置模板路径信息
TEMPLATES = [
    {
        'BACKEND': 'django.template.backends.django.DjangoTemplates',
        'DIRS': [os.path.join(BASE_DIR,'templates')],
        'APP_DIRS': True,
        'OPTIONS': {
            'context_processors': [
                'django.template.context_processors.debug',
                'django.template.context_processors.request',
                'django.contrib.auth.context_processors.auth',
                'django.contrib.messages.context_processors.messages',
            ],
        },
    },
]


...
# 数据库连接配置
DATABASES = {
'default': {
    'ENGINE': 'django.db.backends.mysql',
    'NAME': 'mydb',
    'USER': 'root',
    'PASSWORD': '',
    'HOST': 'localhost',
    'PORT': '3306',
}
...
```

## 4. 定义Model类

4.1 编辑mydemo/myapp/models.py

```python
from django.db import models


class Users(models.Model):
    #id = models.AutoField(primary_key=True) #主键可省略不写
    name = models.CharField(max_length=32)
    age = models.IntegerField(default=20)
    phone = models.CharField(max_length=16)
    addtime=models.DateTimeField(default=datetime.now)

    def __str__(self):
        return self.name+":"+self.phone

    # 自定义对应的表名，默认表名：myapp_users
    #class Meta:
    #    db_table="myapp_users"
```

4.2 测试Model类的使用

在项目根目录下执行命令： python manage.py shell

```
[root@localhost mydemo]# ls
mydemo  manage.py  myapp

[root@localhost mydemo]#  python3 manage.py shell
Python 3.6.1 (default, Jul 18 2017, 01:35:19) 
[GCC 4.4.7 20120313 (Red Hat 4.4.7-18)] on linux
Type "help", "copyright", "credits" or "license" for more information.
(InteractiveConsole)

>>> from myapp.models import Users

>>> Users.objects.all()
<QuerySet [<Users: 张三:12345678901>, <Users: aa:13456789023>]>

>>> s = Users.objects.get(id=1)

>>> s.id
1

>>> s.name
'张三'

>>> s.age
20

>>> s.phone
'12345678901'

>>>
```

## 　5. 实现Web端访问

5.1 编辑mydemo/mydemo/settings.py文件.做 ALLOWED_HOSTS 主机访问配置（若第三步已做可跳过此步骤）

```
    #此处添加自己的IP地址
    ALLOWED_HOSTS = ['*']
```

5.2 编写项目主路由urls配置,配置对myapp应用路由的访问连接配置

```python
from django.contrib import admin
from django.urls import include,path

urlpatterns = [
    #path('admin/', admin.site.urls),
    path('', include('myapp.urls')),
]
```

5.3 配置当前应用myapp的路由配置

在myapp应用目录下创建一个路由文件urls.py文件，注意此文件编码为utf-8（建议复制一个）。

编辑应用中的路由配置文件：mydemo/myapp/urls.py, 内容如下：

```python
from django.urls import path

from . import views

urlpatterns = [
    path('', views.index, name='index'),
]
```

5.4 编辑视图文件：mydemo/myapp/views.py，内容如下

```python
#from django.shortcuts import render
from django.http import HttpResponse

from myapp.models import Users

def index(request):
    try:
        s = Users.objects.get(id=1)
        return HttpResponse(s)
    except:
        return HttpResponse("没有找到对应的信息！")
```

5.5 测试

项目根目录下运行 `pythons manage.py sunserver 0.0.0.0:8000` 命令，开启服务：

```
[root@localhost mydemo]# python manage.py runserver 0.0.0.0:8000
Performing system checks...

System check identified no issues (0 silenced).

July 28, 2020 - 14:01:52
Django version 2.2.11, using settings 'myweb.settings'
Starting development server at http://0.0.0.0:8000/
Quit the server with CONTROL-C.
```

打开浏览器，在浏览其中输入网址测试：`http://172.16.142.129:8000`

显示结果：张三:12345678901

### 继续上面操作完成Web版的Users信息增 删 改 查

## 1. 准备模板文件，创建模板目录

1. 在项目目录下创建templates模板目录
2. 进入模板目录templates，在模板目录下创建应用名myapp的目录
3. 进入myapp目录，在里面创建一个users目录
4. 进入users目录，在里面创建文件：index.html,add.html,edit.html,menu.html,info.html

5 设置模板目录信息：编辑mydemo/mydemo/settings.py文件（若第三步已做可跳过此步骤）

```python
...
    'BACKEND': 'django.template.backends.django.DjangoTemplates',
    'DIRS': [os.path.join(BASE_DIR,'templates'),],
    'APP_DIRS': True,
...
```

## 2. 配置路由信息

打开文件：mydemo/myapp/urls.py路由文件，加入六条路由配置信息

```python
from django.urls import path

from . import views

urlpatterns = [
    path('', views.index, name="index"),
    path('users', views.indexUsers, name="users"), #浏览用户信息
    path('users/add', views.addUsers, name="addusers"), #加载添加用户信息表单
    path('users/insert', views.insertUsers, name="insertusers"), #执行用户信息添加
    path('users/<int:uid>/del', views.delUsers, name="delusers"), #执行用户信息删除
    path('users/<int:uid>/edit', views.editUsers, name="editusers"), #加载用户信息编辑表单
    path('users/update', views.updateUsers, name="updateusers"), #执行用户信息编辑
]
```

## 3. 编写视图文件：mydemo/myapp/views.py

```python
# 注意：需导入from django.shortcuts import render

from django.shortcuts import render
from django.http import HttpResponse

from myapp.models import Users

def index(request):
    try:
        list = Users.objects.filter(id__in=[1,3,5])
        s = ','.join([vo.name for vo in list])

        #修改(将id值为5的age值改为30)
        #ob = Users.objects.get(id=5)
        #ob.age = 30
        #ob.save()

        #删除(删除id为3的信息)  
        #ob = Users.objects.get(id=3)
        #ob.delete()

        return HttpResponse(s)
    except:
        return HttpResponse("没有找到对应的信息！")

# 浏览用户信息        
def indexUsers(request):
    # 执行数据查询，并放置到模板中
    list = Users.objects.all()
    context = {"stulist":list}
    return render(request,"myapp/users/index.html",context)

# 加载添加信息表单
def addUsers(request):  
    return render(request,"myapp/users/add.html")

# 执行信息添加操作
def insertUsers(request): 
    try:
        ob = Users()
        ob.name = request.POST['name']
        ob.age = request.POST['age']
        ob.phone = request.POST['phone']
        ob.save()
        context = {'info':'添加成功！'}
    except:
        context = {'info':'添加失败！'}
    return render(request,"myapp/users/info.html",context)

# 执行信息删除操作    
def delUsers(request,uid):  
    try:
        ob = Users.objects.get(id=uid)
        ob.delete()
        context = {'info':'删除成功！'}
    except:
        context = {'info':'删除失败！'}
    return render(request,"myapp/users/info.html",context)

# 加载信息编辑表单    
def editUsers(request,uid):  
    try:
        ob = Users.objects.get(id=uid)
        context = {'user':ob}
        return render(request,"myapp/users/edit.html",context)
    except:
        context = {'info':'没有找到要修改的信息！'}
        return render(request,"myapp/users/info.html",context)

# 执行信息编辑操作
def updateUsers(request):
    try:
        ob = Users.objects.get(id= request.POST['id'])
        ob.name = request.POST['name']
        ob.age = request.POST['age']
        ob.phone = request.POST['phone']
        #ob.addtime = datetime.now
        ob.save()
        context = {'info':'修改成功！'}
    except:
        context = {'info':'修改失败！'}
    return render(request,"myapp/users/info.html",context)
```

## 4. 编辑浏览信息视图文件：

文件位置：mydemo/templates/myapp/users/index.html

```html
<!DOCTYPE html>
<html>
    <head>
        <meta charset="utf-8"/>
        <title>用户信息管理</title>
        <script>
            //自定义执行信息删除提示判断，参数uu是成功的删除url地址
            function doDel(uu){
                if(confirm("确定要删除吗？")){
                    //网页跳转
                    window.location=uu;
                }
            }

        </script>
    </head>
    <body>
        <center>

            {% include 'myapp/users/menu.html' %}

            <h3>浏览用户信息</h3>
            <table width="800" border="1">
                <tr>
                    <th>id号</th>
                    <th>姓名</th>
                    <th>年龄</th>
                    <th>电话</th>
                    <th>添加时间</th>
                    <th>操作</th>
                </tr>
                {% for stu in stulist %}
                    <tr>
                        <td>{{ stu.id }}</td>
                        <td>{{ stu.name }}</td>
                        <td>{{ stu.age }}</td>
                        <td>{{ stu.phone }}</td>
                        <td>{{ stu.addtime|date:'Y-m-d H:i:s' }}</td>
                        <td>
                            <a href="{% url 'editusers' stu.id %}">编辑</a>
                            <a href="javascript:doDel('{% url 'delusers' stu.id %}');">删除</a>
                        </td>
                    </tr>
                {% endfor %}
            </table>
        </center>
    </body>
</html>
```

## ５.　编辑添加表单视图文件

文件位置：mydemo/templates/myapp/users/add.html

```html
<!DOCTYPE html>
<html>
    <head>
        <meta charset="utf-8"/>
        <title>用户信息管理</title>
    </head>
    <body>
        <center>
            {% include "myapp/users/menu.html" %}

            <h3>添加用户信息</h3>
            <form action="{% url 'insertusers' %}" method="post">
            {% csrf_token %}
            <table width="280" border="0">
               <tr>
                 <td>姓名：</td>
                 <td><input type="text" name="name"/></td>
               </tr>
               <tr>
                 <td>年龄：</td>
                 <td><input type="text" name="age"/></td>
               </tr>
               <tr>
                 <td>电话：</td>
                 <td><input type="text" name="phone"/></td>
               </tr>
               <tr>
                 <td colspan="2" align="center">
                    <input type="submit" value="添加"/>
                    <input type="reset" value="重置"/>
                 </td>
               </tr>
            </table>
            </form>
        </center>
    </body>
</html>
```

## 6.　编辑信息表单视图文件

文件位置：mydemo/templates/myapp/users/edit.html

```html
<!DOCTYPE html>
<html>
    <head>
        <meta charset="utf-8"/>
        <title>用户信息管理</title>
    </head>
    <body>
        <center>
            {% include "myapp/users/menu.html" %}
            <h3>修改用户信息</h3>
            <form action="{% url 'updateusers' %}" method="post">
            <input type="hidden" name="id" value="{{ user.id}}"/>
            {% csrf_token %}
            <table width="280" border="0">
               <tr>
                 <td>姓名：</td>
                 <td><input type="text" name="name" value="{{ user.name }}"/></td>
               </tr>
               <tr>
                 <td>年龄：</td>
                 <td><input type="text" name="age"  value="{{ user.age }}"/></td>
               </tr>
               <tr>
                 <td>电话：</td>
                 <td><input type="text" name="phone" value="{{ user.phone }}"/></td>
               </tr>
               <tr>
                 <td colspan="2" align="center">
                    <input type="submit" value="编辑"/>
                    <input type="reset" value="重置"/>
                 </td>
               </tr>
            </table>
            </form>
        </center>
    </body>
</html>
```

## 7.　编辑公共导航栏页视图文件

文件位置：mydemo/templates/myapp/users/menu.html

```html
        <h2>用户信息管理</h2>
        <a href="{% url 'users' %}">浏览用户</a> |
        <a href="{% url 'addusers' %}">添加用户</a>
        <hr/>
```

文件位置：mydemo/templates/myapp/users/info.html

```html
<!DOCTYPE html>
<html>
    <head>
        <meta charset="utf-8"/>
        <title>用户信息管理</title>
    </head>
    <body>
        <center>
            {% include "myapp/users/menu.html" %}

            <h3>{{ info }}</h3>

        </center>
    </body>
</html>
```





### Ajax实战笔记--城市级联操作

### 1. 项目架构搭建

- 1.1 创建项目tpdemo,创建应用myapp

  ```
    # 创建项目框架tpdemo
    $ django-admin startproject tpdemo
  
    $ cd tpdemo
  
    # 在项目中创建一个myapp应用
    $ python manage.py startapp myapp
  
    # 创建模板目录
    $ mkdir templates
    $ mkdir templates/myapp
  
    $ cd ..
  
    $ tree tpdemo
  
    tpdemo
    ├── tpdemo
    │   ├── __init__.py
    │   ├── settings.py
    │   ├── urls.py
    │   └── wsgi.py
    ├── manage.py
    ├── myapp
    │   ├── admin.py
    │   ├── apps.py
    │   ├── __init__.py
    │   ├── models.py
    │   ├── tests.py
    │   └── views.py
    └── templates
        └── mytest
  ```

- 1.2 编辑tpdemo/tpdemo/settings.py文件，配置数据库连接

```python
...
#配置自己的服务器IP地址
ALLOWED_HOSTS = ['*']

...
#添加自己应用
INSTALLED_APPS = [
    'django.contrib.admin',
    'django.contrib.auth',
    'django.contrib.contenttypes',
    'django.contrib.sessions',
    'django.contrib.messages',
    'django.contrib.staticfiles',
    'myapp',
]
...

# 配置模板路径信息
TEMPLATES = [
    {
        'BACKEND': 'django.template.backends.django.DjangoTemplates',
        'DIRS': [os.path.join(BASE_DIR,'templates')],
        'APP_DIRS': True,
        'OPTIONS': {
            'context_processors': [
                'django.template.context_processors.debug',
                'django.template.context_processors.request',
                'django.contrib.auth.context_processors.auth',
                'django.contrib.messages.context_processors.messages',
            ],
        },
    },
]


...
# 数据库连接配置
DATABASES = {
'default': {
    'ENGINE': 'django.db.backends.mysql',
    'NAME': 'mytest',
    'USER': 'root',
    'PASSWORD': '',
    'HOST': 'localhost',
    'PORT': '3306',
}
...
```

- 1.3 Django使用MySQL数据库需要加载 MySQLdb模块，需要安装 mysqlclient，若已经安装请略过。

```
   pip install  mysqlclient
```

- 1.4 编写项目主路由urls配置,配置对myapp应用路由的访问连接配置: tpdemo/tpdemo/urls.py

```python
from django.urls import include,path
from django.contrib import admin

urlpatterns = [
    path('admin/', admin.site.urls),
    path('', include('myapp.urls')),
]
```

- 1.5 配置当前应用myapp的路由配置
- 在myapp应用目录下创建一个路由文件urls.py文件，注意此文件编码为utf-8（建议复制一个）。
- 编辑应用中的路由配置文件：tpdemo/myapp/urls.py, 内容如下：

```python
from django.urls import path

from . import views

urlpatterns = [
    path('', views.index, name="index"),
]
```

- 1.6 编写视图tpdemo/myapp/views.py

```python
from django.shortcuts import render
from django.http import HttpResponse

# 网站首页
def index(request):
    return render(request,'myapp/index.html')
```

- 1.7 定义模板并编写模板 tpdemo/templates/myapp/index.html

```html
<!DOCTYPE html>
<html lang="cn">
<head>
    <meta charset="UTF-8">
    <title>Django框架案例</title>
</head>
<body>
      <h2>Django框架案例</h2>

      <h4><a href="#">1. Ajax实战笔记--城市级联操作</a></h4>
</body>
</html>
```

- 1.8 启动服务，通过浏览器测试效果

```
[root@localhost tpdemo]# ls
tpdemo  manage.py  myapp  templates

[root@localhost tpdemo]# python manage.py runserver 0.0.0.0:8000
```

- 打开浏览器输入网址：http://localhost:8000

## 2. 开发《城市级联信息操作》

- 2.1 将提前准备好的district.sql信息导入到mydb数据库中

  在mydb数据库中存在一个district（城市区县信息表）

- 2.2 编写model类：打开tpdemo/myapp/models.py文件

```python
from django.db import models

# 自定义城市区县信息model类
class District(models.Model):
    name = models.CharField(max_length=255)
    upid = models.IntegerField()

    class Meta:
        db_table = "district"  # 指定真实表名
```

- 2.3 编写子路由文件：tpdemo/myapp/urls.py

```python
...
    # 城市级联操作
    path('showdistrict/', views.showdistrict, name='showdistrict'), #加载网页
    path('district/<int:upid>', views.district, name='district'),  #Ajax加载城市信息
...
```

- 2.4 编写视图文件：tpdemo/myapp/views.py

```python
from django.http import HttpResponse,JsonResponse

from myapp.models import District

...
# 加载城市级联信息操作模板
def showdistrict(request):
    return render(request,"myapp/district.html")

# 加载对应的城市信息，并json格式ajax方式响应
def district(request,upid):
    dlist = District.objects.filter(upid=upid)
    list = []
    for ob in dlist:
        list.append({'id':ob.id,'name':ob.name})
    return JsonResponse({'data':list})
...
```

- 启动服务测试：url：http://localhost:8000/district/0 加载一级城市信息
- 2.5 开发网页前端的准备：首先启用静态资源目录
  - 在项目的根目录下创建一个静态资源目录：static 路径：tpdemo/static
  - 并在此目录下创建一个js目录。然后将jquery文件：jquery-1.8.2.min.js放到此目录中 具体位置：tpdemo/static/js/jquery-1.8.2.min.js
  - 编辑tpdemo/tpdemo/settings.py配置文件，在最后加入代码：(配置静态资源目录)

```python
...
STATIC_URL = '/static/'

STATICFILES_DIRS = [
    os.path.join(BASE_DIR,'static'),
]
```

- 2.6 配置访问url：编辑tpdemo/templates/myapp/index.html

```html
...
   <h4><a href="{% url 'showdistrict' %}">1. Ajax实战笔记--城市级联操作</a></h4> 
...
```

- 2.7 定义并编写模板文件：tpdemo/templates/myapp/district.html

```html
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Ajax实战--城市级联操作</title>
    <script type="text/javascript" src="/static/js/jquery-1.8.2.min.js"></script>
    <script type="text/javascript">
        //编写js代码
        $(function(){
            $.ajax({
                type:'get',
                url:"{% url 'district' 0 %}",
                dataType:'json',
                async: false,
                success:function(res){
                    list = res.data;
                    //遍历响应的城市信息
                    for(var i=0;i<list.length;i++){
                        $("#cid").append("<option value='"+list[i].id+"'>"+list[i].name+"</option>");
                    }
                },
            });

            //获取最后一个下拉框并添加选中事件
            $("select").live('change',function(){
                //获取选中的id号
                var id = $(this).val();
                $(this).nextAll().remove();
                $.ajax({
                    url: "/district/"+id,
                    type: 'get',
                    data: {},
                    dataType:'json',
                    success:function(res){
                        if(res.data.length<1)
                            return;
                        var data = res.data;
                        var select = $("<select></select>")
                        for(var i=0;i<data.length;i++){
                            $('<option value="'+data[i].id+'">'+data[i].name+'</option>').appendTo(select)
                            //$('select:last').append('<option value="'+data[i].id+'">'+data[i].name+'</option>'); 
                        }
                        $("select:last").after(select);
                    }
                });
            });

        })

    </script>
</head>
<body>
    <h2>Ajax实战笔记--城市级联操作</h2>

    <select id="cid">
        <option>-请选择-</option>
    </select>
</body>
</html>
```











### 基于Django框架的项目搭建

### (1). 创建数据库 `osdb`

- 进入MySQL数据库中，创建一个数据库名为：osdb
- 将上节《项目的数据库设计》中准备好的osdb.sql脚本导入到`osdb`数据库中

### (2). 创建项目 `myobject` 框架和应用 `myamdin`、`web`和`mobile`。

```
    # 创建项目框架 `myobject`
    $ django-admin startproject myobject

    $ cd myobject

    # 在项目中创建一个myadmin应用(项目的后台管理)
    $ python manage.py startapp myadmin

    # 在项目中再创建一个web应用(项目前台大堂点餐应用)
    $ python manage.py startapp web

    # 在项目中再创建一个mobile应用(移动客户点餐端应用)
    $ python manage.py startapp mobile

    # 创建模板目录
    $ mkdir templates
    $ mkdir templates/myadmin
    $ mkdir templates/web
    $ mkdir templates/mobile

    # 创建静态资源目录
    $ mkdir static
    $ mkdir static/myadmin
    $ mkdir static/web
    $ mkdir static/mobile
    $ mkdir static/uploads

    # 创建前后台应用模板目录,并在里面各创建一个`__init__.py`和`index.py`的空文件
    $ mkdir myadmin/views
    $ touch myadmin/views/__init__.py
    $ touch myadmin/views/index.py
    $ mkdir web/views
    $ touch web/views/__init__.py
    $ touch web/views/index.py
    $ mkdir mobile/views
    $ touch mobile/views/__init__.py
    $ touch mobile/views/index.py

    # 删除前后台应用的默认模板文件
    # rm -rf myadmin/views.py
    # rm -rf web/views.py
    # rm -rf mobile/views.py

    # 拷贝路由文件到应用目录中
    $ cp myobject/urls.py   myadmin/urls.py
    $ cp myobject/urls.py   web/urls.py
    $ cp myobject/urls.py   mobile/urls.py

    # 退出项目目录
    $ cd ..

    #查看项目目录结构
    $ tree myobject

    myobject/
        ├── manage.py
        ├── myobject
        │   ├── __init__.py
        │   ├── settings.py
        │   ├── urls.py
        │   └── wsgi.py
        ├── myadmin
        │   ├── admin.py
        │   ├── apps.py
        │   ├── __init__.py
        │   ├── migrations
        │   │   └── __init__.py
        │   ├── views
        │   │   ├── __init__.py
        │   │   └── index.py
        │   ├── models.py
        │   ├── tests.py
        │   └── urls.py
        ├── web
        │   ├── admin.py
        │   ├── apps.py
        │   ├── __init__.py
        │   ├── migrations
        │   │   ├── __init__.py
        │   ├── views
        │   │   ├── __init__.py
        │   │   └── index.py
        │   ├── models.py
        │   ├── tests.py
        │   └── urls.py
        ├── mobile
        │   ├── admin.py
        │   ├── apps.py
        │   ├── __init__.py
        │   ├── migrations
        │   │   ├── __init__.py
        │   ├── views
        │   │   ├── __init__.py
        │   │   └── index.py
        │   ├── models.py
        │   ├── tests.py
        │   └── urls.py
        ├── static
        │   ├── myadmin/
        │   ├── web/
        │   ├── mobile/
        │   └── uploads/
        └── templates
            ├── myadmin/
            ├── web/
            └── mobile/
```

### (3). 项目框架配置

注意：此配置需要安装mysql数据库mysqlclient软件包， 如：`$ pip install mysqlclient`

- 3.2 编辑myobject/myobject/settings.py文件:

```python
# myobject/myobject/settings.py  项目配置文件

# 1. 配置允许访问的主机名信息
ALLOWED_HOSTS = ['*']
或
ALLOWED_HOSTS = ['localhost','127.0.0.1','192.168.2.240']

...

# 2. 将myadmin和web的应用添加到项目框架结构中
INSTALLED_APPS = [
    'django.contrib.admin',
    'django.contrib.auth',
    'django.contrib.contenttypes',
    'django.contrib.sessions',
    'django.contrib.messages',
    'django.contrib.staticfiles',
    'myadmin',
    'web',
    'mobile',
]

...

# 3. 配置模板目录 os.path.join(BASE_DIR,'templates')
TEMPLATES = [
    {
        'BACKEND': 'django.template.backends.django.DjangoTemplates',
        'DIRS': [os.path.join(BASE_DIR,'templates')],
        'APP_DIRS': True,
        'OPTIONS': {
            'context_processors': [
                'django.template.context_processors.debug',
                'django.template.context_processors.request',
                'django.contrib.auth.context_processors.auth',
                'django.contrib.messages.context_processors.messages',
            ],
        },
    },
]

...

# 4. 配置项目的数据库连接信息：
DATABASES = {
    'default': {
        'ENGINE': 'django.db.backends.mysql',
        'NAME': 'osdb',
        'USER': 'root',
        'PASSWORD': '',
        'HOST': 'localhost',
        'PORT': '3306',
    }
}

...

# 5. 设置时区和语言 
LANGUAGE_CODE = 'zh-hans'

TIME_ZONE = 'Asia/Shanghai'

...

# 6. 配置网站的静态资源目录
STATIC_URL = '/static/'
STATICFILES_DIRS = [
    os.path.join(BASE_DIR, 'static'),
]
```

### (4). 项目urls路由信息配置

- 4.1 打开根路由文件：myobject/myobject/urls.py路由文件，编写路由配置信息

```python
# myobject/myobject/urls.py

#from django.contrib import admin
from django.urls import include,path

urlpatterns = [
    #path('admin/', admin.site.urls),
    path('', include("web.urls")),                # 默认前台大堂点餐端
    path('myadmin/', include("myadmin.urls")),     # 后台管理端
    path('mobile/', include("mobile.urls")),    # 移动会员端
]
```

- 4.2 打开项目后台管理路由文件：myobject/myadmin/urls.py路由文件，编写路由配置信息

```python
# myobject/myadmin/urls.py

from django.urls import path

from myadmin.views import index

urlpatterns = [
    # 后台首页
    path('', index.index, name="myadmin_index"),

]
```

- 4.3 打开项目前台大堂点餐端路由文件：myobject/web/urls.py路由文件，编写路由配置信息

```python
# myobject/web/urls.py

from django.urls import path

from web.views import index

urlpatterns = [
   # path('', index.index, name="index"),
]
```

- 4.4 打开项目移动会员端路由文件：myobject/mobile/urls.py路由文件，编写路由配置信息

```python
# myobject/mobile/urls.py

from django.urls import path

from web.views import index

urlpatterns = [
   # path('', index.index, name="index"),
]
```

### (5). 编写后台视图测试

- 5.1 编辑后台、前台和移动端的视图文件

```python
# myobject/myadmin/views/index.py
from django.shortcuts import render
from django.http import HttpResponse

#后台首页
def index(request):
    return HttpResponse('欢迎进入点餐系统网站后台管理！')
# myobject/web/views/index.py
from django.shortcuts import render
from django.http import HttpResponse

#前台首页
def index(request):
    return HttpResponse('欢迎进入大堂点餐前台首页！')
# myobject/mobile/views/index.py
from django.shortcuts import render
from django.http import HttpResponse

#移动端首页
def index(request):
    return HttpResponse('欢迎进入移动会员端首页！')
```

- 5.2 运行测试
- 在项目根目录下启动服务，并使用浏览器访问测试：http://localhost:8000/myadmin

```
[root@localhost myobject]# pwd
/python/myobject
[root@localhost myobject]# ls
manage.py  myadmin  myobject  web  mobile  static  templates
[root@localhost myobject]# python manage.py runserver 0.0.0.0:8000
Performing system checks...

System check identified no issues (0 silenced).

April 06, 2020 - 14:29:36
Django version 1.11, using settings 'myobject.settings'
Starting development server at http://127.0.0.1:8000/
Quit the server with CONTROL-C.
^C[root@localhost myobject]#
```

### (6). 摆放后台首页面：



- 6.1. 使用事先准备好的后台模板：

  - 从github上下载一个后台简洁模板：https://github.com/ColorlibHQ/AdminLTE

  - 将后台模板目录中的资源目录：`bower_components`、`dist`、`local`、`package.json`复制到项目的后台静态资源目录`static/myadmin/`中

  - 在`templates/myadmin/`目录中创建一个基类父模板文件`base.html`

  - 在`templates/myadmin/index/`目录中创建一个首页模板文件`index.html`

  - 在`templates/myadmin/`目录中创建一个信息提示模板文件`info.html`

  - 修改

    ```
    myobject/myadmin/views/index.py
    ```

    视图文件中index函数中代码：

    ```python
    def index(request):
      '''管理后台首页'''
      return render(request,"myadmin/index/index.html")
    ```

- 6.2. 编辑父类模板：/templates/myadmin/base.html

```html
{% load static from staticfiles %}
<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <title>订餐系统后台管理</title>
  <!-- 支持响应式布局 -->
  <meta content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no" name="viewport">
  <link rel="stylesheet" href="{% static 'myadmin/bower_components/bootstrap/dist/css/bootstrap.min.css'%}">
  <!-- 象形字体 -->
  <link rel="stylesheet" href="{% static 'myadmin/bower_components/font-awesome/css/font-awesome.min.css'%}">
  <!-- 图标 -->
  <link rel="stylesheet" href="{% static 'myadmin/bower_components/Ionicons/css/ionicons.min.css'%}">
  <!-- 主题风格样式 -->
  <link rel="stylesheet" href="{% static 'myadmin/dist/css/AdminLTE.min.css'%}">
  <!-- AdminLTE 皮肤.这里选择的是skin-blue样式，我们还可以有其他皮肤可以选择. -->
  <link rel="stylesheet" href="{% static 'myadmin/dist/css/skins/skin-blue.min.css'%}">
  <!-- 兼容IE9以下浏览器 -->
  <!--[if lt IE 9]>
  <script src="{% static 'myadmin/local/js/html5shiv.min.js'%}"></script>
  <script src="{% static 'myadmin/local/js/respond.min.js'%}"></script>
  <![endif]-->
  <!-- Google Font -->
  <link rel="stylesheet" href="{% static 'myadmin/local/css/google_fonts.css'%}">
</head>
<body class="hold-transition skin-blue sidebar-mini">
<div class="wrapper">

  <!-- Main Header 主体页头 -->
  <header class="main-header">

    <!-- Logo -->
    <a href="index2.html" class="logo">
      <!-- 侧栏迷你徽标 mini 50x50 pixels -->
      <span class="logo-mini"><b>餐</b></span>
      <!-- 常规状态标志和移动设备标志 -->
      <span class="logo-lg"><b>订餐系统后台管理</b></span>
    </a>

    <!-- Header Navbar 首部导航栏 -->
    <nav class="navbar navbar-static-top" role="navigation">
      <!-- Sidebar toggle button 侧边栏切换按钮 -->
      <a href="#" class="sidebar-toggle" data-toggle="push-menu" role="button">
        <span class="sr-only">切换导航</span>
      </a>
      <!-- 右栏菜单 -->
      <div class="navbar-custom-menu">
        <ul class="nav navbar-nav">
          <!-- messages-menu 消息菜单: 样式可以在 dropdown.less 中找到 -->
          <li class="dropdown messages-menu">
            <!-- Menu toggle button 菜单切换按钮 -->
            <a href="#" class="dropdown-toggle" data-toggle="dropdown">
              <i class="fa fa-envelope-o"></i>
              <span class="label label-success">4</span>
            </a>
            <ul class="dropdown-menu">
              <li class="header">你有4个短信息</li>
              <li>
                <!-- 内部菜单：包含消息 -->
                <ul class="menu">
                  <li><!-- start message 信息开始 -->
                    <a href="#">
                      <div class="pull-left">
                        <!-- User Image 使用图片 -->
                        <img src="{% static 'myadmin/dist/img/user2-160x160.jpg'%}" class="img-circle" alt="User Image">
                      </div>
                      <!-- 消息标题和时间 -->
                      <h4>
                        我们都支持团队
                        <small><i class="fa fa-clock-o"></i> 5 分钟</small>
                      </h4>
                      <!-- The message -->
                      <p>Why not buy a new awesome theme?</p>
                    </a>
                  </li>
                  <!-- end message -->
                </ul>
                <!-- /.menu -->
              </li>
              <li class="footer"><a href="#">查看所有信息</a></li>
            </ul>
          </li>
          <!-- /.messages-menu -->

          <!-- Notifications Menu 通知菜单 -->
          <li class="dropdown notifications-menu">
            <!-- Menu toggle button  菜单切换按钮 -->
            <a href="#" class="dropdown-toggle" data-toggle="dropdown">
              <i class="fa fa-bell-o"></i>
              <span class="label label-warning">10</span>
            </a>
            <ul class="dropdown-menu">
              <li class="header">你有10条通知信息</li>
              <li>
                <!-- Inner Menu: contains the notifications -->
                <ul class="menu">
                  <li><!-- start notification -->
                    <a href="#">
                      <i class="fa fa-users text-aqua"></i> 今天有5名新成员加入
                    </a>
                  </li>
                  <!-- end notification -->
                </ul>
              </li>
              <li class="footer"><a href="#">查看全部</a></li>
            </ul>
          </li>
          <!-- Tasks Menu 任务菜单 -->
          <li class="dropdown tasks-menu">
            <!-- Menu Toggle Button 菜单切换按钮 -->
            <a href="#" class="dropdown-toggle" data-toggle="dropdown">
              <i class="fa fa-flag-o"></i>
              <span class="label label-danger">9</span>
            </a>
            <ul class="dropdown-menu">
              <li class="header">你有9个任务</li>
              <li>
                <!-- Inner menu: contains the tasks -->
                <ul class="menu">
                  <li><!-- Task item -->
                    <a href="#">
                      <!-- Task title and progress text -->
                      <h3>
                        设计一些按钮
                        <small class="pull-right">20%</small>
                      </h3>
                      <!-- The progress bar -->
                      <div class="progress xs">
                        <!-- Change the css width attribute to simulate progress -->
                        <div class="progress-bar progress-bar-aqua" style="width: 20%" role="progressbar"
                             aria-valuenow="20" aria-valuemin="0" aria-valuemax="100">
                          <span class="sr-only">20% 完成</span>
                        </div>
                      </div>
                    </a>
                  </li>
                  <!-- end task item -->
                </ul>
              </li>
              <li class="footer">
                <a href="#">查看所有任务</a>
              </li>
            </ul>
          </li>
          <!-- User Account Menu -->
          <li class="dropdown user user-menu">
            <!-- Menu Toggle Button -->
            <a href="#" class="dropdown-toggle" data-toggle="dropdown">
              <!-- The user image in the navbar-->
              <img src="{% static 'myadmin/dist/img/user2-160x160.jpg'%}" class="user-image" alt="User Image">
              <!-- hidden-xs hides the username on small devices so only the image appears. -->
              <span class="hidden-xs">{{request.session.adminuser.nickname}}</span>
            </a>
            <ul class="dropdown-menu">
              <!-- The user image in the menu -->
              <li class="user-header">
                <img src="{% static 'myadmin/dist/img/user2-160x160.jpg'%}" class="img-circle" alt="User Image">

                <p>
                  张无忌 - 管理员
                  <small>2020年07月16日加入</small>
                </p>
              </li>
              <!-- Menu Footer-->
              <li class="user-footer">
                <div class="pull-left">
                  <a href="#" class="btn btn-default btn-flat">个人信息</a>
                </div>
                <div class="pull-right">
                  <a href="#" class="btn btn-default btn-flat">退 出</a>
                </div>
              </li>
            </ul>
          </li>

        </ul>
      </div>
    </nav>
  </header>

  <!-- 左侧柱。包含徽标和边栏 -->
  <aside class="main-sidebar">

    <!-- sidebar: style can be found in sidebar.less -->
    <section class="sidebar">

      <!-- Sidebar user panel (optional) -->
      <div class="user-panel">
        <div class="pull-left image">
          <img src="{% static 'myadmin/dist/img/user2-160x160.jpg'%}" class="img-circle" alt="User Image">
        </div>
        <div class="pull-left info">
          <p>张无忌 . 管理员</p>
          <!-- Status -->
          <a href="#"><i class="fa fa-circle text-success"></i> 在线</a>
        </div>
      </div>

      <!-- Sidebar Menu -->
      <ul class="sidebar-menu" data-widget="tree">
        <li class="header">主要导航</li>
        <!-- 导航列表，你可以自行更改图标 -->
        <li class="active"><a href="admin.html"><i class="fa fa-home"></i> <span>首页</span></a></li>

        <li><a href="member.html"><i class="fa fa-users"></i> <span>会员管理</span></a></li>
        <li><a href="shop.html"><i class="fa fa-sitemap"></i> <span>店铺管理</span></a></li>
        <li class="treeview">
          <a href="category.html"><i class="fa fa-cutlery"></i> <span>菜品管理</span>
            <span class="pull-right-container">
              <i class="fa fa-angle-left pull-right"></i>
            </span>
          </a>
          <ul class="treeview-menu">
            <li><a href="category.html"> <i class="fa fa-circle-o"></i> 菜品分类</a></li>
            <li><a href="product.html"> <i class="fa fa-circle-o"></i> 菜品信息</a></li>
          </ul>
        </li>
        <li><a href="orders.html"><i class="fa fa-shopping-cart"></i> <span>订单管理</span></a></li>
        <li><a href="#"><i class="fa fa-user"></i> <span>账号管理</span></a></li>
        <li><a href="#"><i class="fa fa-key"></i> <span>权限管理</span></a></li>
        <li><a href="#"><i class="fa fa-gear"></i> <span>系统配置</span></a></li>
        <li><a href="#"><i class="fa fa-unlock-alt"></i> <span>认证体系</span></a></li>
      </ul>
      <!-- /.sidebar-menu -->
    </section>
    <!-- /.sidebar -->
  </aside>

  <!-- Content Wrapper. Contains page content -->
  <div class="content-wrapper">
    {% block main_body %}
    {% endblock %}
  </div>
  <!-- /.content-wrapper -->

  <!-- Main Footer -->
  <footer class="main-footer">
    <!-- To the right -->
    <div class="pull-right hidden-xs">
      <!--餐饮管理平台-->
    </div>
    <!-- Default to the left -->
    <strong>Copyright &copy; 2020 <a href="#">北京*******有限公司</a>.</strong> 版权所有
  </footer>

  <!-- 添加侧栏的背景。必须放置此处紧接在控制侧边栏之后 -->
  <div class="control-sidebar-bg"></div>
</div>
<!-- ./wrapper -->

<!-- edu-model提示框模板 -->
<div id="edu-alert" class="modal">
  <div class="modal-dialog modal-sm">
    <div class="modal-content">
      <div class="modal-header">
        <button type="button" class="close" data-dismiss="modal"><span aria-hidden="true">×</span><span class="sr-only">Close</span></button>
        <h5 class="modal-title"><i class="fa fa-exclamation-circle"></i> [Title]</h5>
      </div>
      <div class="modal-body small">
        <p>[Message]</p>
      </div>
      <div class="modal-footer" >
        <button type="button" class="btn btn-primary ok" data-dismiss="modal">[BtnOk]</button>
        <button type="button" class="btn btn-default cancel" data-dismiss="modal">[BtnCancel]</button>
      </div>
    </div>
  </div>
</div>
<!-- edu-model-end -->

<!-- REQUIRED JS SCRIPTS -->

<!-- jQuery 3 -->
<script src="{% static 'myadmin/bower_components/jquery/dist/jquery.min.js'%}"></script>
<!-- Bootstrap 3.3.7 -->
<script src="{% static 'myadmin/bower_components/bootstrap/dist/js/bootstrap.min.js'%}"></script>
<!-- AdminLTE App -->
<script src="{% static 'myadmin/dist/js/adminlte.min.js'%}"></script>

<script src="{% static 'myadmin/dist/js/edu-modal-alert-confirm.js'%}"></script>

<!-- 此处可以添加SimLoopl和FastClick插件，用于增强用户体验。 -->

<script type="text/javascript">
  //自定义一个用于实现Ajax信息删除的函数
  function doDelete(del_url){
    Modal.confirm({
      msg: "确定要删除吗？",
      title: ' 信息提示',
      btnok: '确定',
      btncl:'取消'
    }).on(function (e){
      if(e){ //判断是否点击了确定按钮
        $.ajax({
          type:'get',
          url:del_url,
          dataType:'json',
          async: false,
          success:function(res){
            Modal.alert({msg:res.info, title:' 信息提示',btnok: '确定',btncl:'取消'});
            window.location.reload(); //刷新当前页面.
          },
        });
      }
    });
  }
</script>
{% block loadjavascript %}
<!-- 此处可加载独立的javascript程序 -->
{% endblock %}
</body>
</html>
```

- 6.3. 编辑后台首页模板：/templates/myadmin/index.html

```html
{% extends 'myadmin/base.html' %}

{% block main_body %}
    <!-- Content Header (Page header) -->
    <section class="content-header">
      <h1>
        首页
        <small>订餐系统后台管理</small>
      </h1>
      <ol class="breadcrumb">
        <li><a href="#"><i class="fa fa-dashboard"></i> Level</a></li>
        <li class="active">Here</li>
      </ol>
    </section>

    <!-- Main content -->
    <section class="content container-fluid">
      <!-- Small boxes (Stat box) -->
      <div class="row">
        <div class="col-lg-3 col-xs-6">
          <!-- small box -->
          <div class="small-box bg-aqua">
            <div class="inner">
              <h3>150</h3>

              <p>新订单</p>
            </div>
            <div class="icon">
              <i class="ion ion-bag"></i>
            </div>
            <a href="#" class="small-box-footer">更多信息 <i class="fa fa-arrow-circle-right"></i></a>
          </div>
        </div>
        <!-- ./col -->
        <div class="col-lg-3 col-xs-6">
          <!-- small box -->
          <div class="small-box bg-green">
            <div class="inner">
              <h3>53<sup style="font-size: 20px">%</sup></h3>

              <p>Bounce Rate</p>
            </div>
            <div class="icon">
              <i class="ion ion-stats-bars"></i>
            </div>
            <a href="#" class="small-box-footer">更多信息 <i class="fa fa-arrow-circle-right"></i></a>
          </div>
        </div>
        <!-- ./col -->
        <div class="col-lg-3 col-xs-6">
          <!-- small box -->
          <div class="small-box bg-yellow">
            <div class="inner">
              <h3>44</h3>

              <p>用户注册</p>
            </div>
            <div class="icon">
              <i class="ion ion-person-add"></i>
            </div>
            <a href="#" class="small-box-footer">更多信息 <i class="fa fa-arrow-circle-right"></i></a>
          </div>
        </div>
        <!-- ./col -->
        <div class="col-lg-3 col-xs-6">
          <!-- small box -->
          <div class="small-box bg-red">
            <div class="inner">
              <h3>65</h3>

              <p>Unique Visitors</p>
            </div>
            <div class="icon">
              <i class="ion ion-pie-graph"></i>
            </div>
            <a href="#" class="small-box-footer">More info <i class="fa fa-arrow-circle-right"></i></a>
          </div>
        </div>
        <!-- ./col -->
      </div>

    </section>
    <!-- /.content -->
{% endblock %}
```

- 6.4. 后台公共提示信息模板：/templates/myadmin/info.html

```html
{% extends "myadmin/base.html" %}

{% block main_body %}                
    <!-- Content Header (Page header) -->
    <section class="content-header">
      <h4>
        信息提示:
      </h4>
    </section>

    <div class="pad margin no-print">
      <div class="callout callout-info" style="margin-bottom: 0!important;padding-left: 50px">
        <h3><i class="fa fa-exclamation-triangle"></i>  &nbsp; {{ info }}</h3>
      </div>
    </div>
{% endblock %}
```



## 三、疑难杂症问题解决





### Django 迁移   +++报错



### 迁移报错

将模型类同步到数据库中。

**1）生成迁移文件**

```
python manage.py makemigrations
```

**2）同步到数据库中**

```
python manage.py migrate
```



已安装情况下仍然报错
报错内容为找不到mysqlclient

#### django.core.exceptions.ImproperlyConfigured: Error loading MySQLdb module. Did you install mysqlclient?--报错

通常解决办法

```python
pip install pymysql

#**项目（settings.py同级)目录中init.py中添加**
import pymysql

pymysql.install_as_MySQLdb()
```


强制重装一下
pip install mysqlclient‑1.4.6‑cp38‑cp38‑win32.whl --force-reinstall





